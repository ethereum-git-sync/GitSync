{
  "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1974",
  "repository_url": "https://api.github.com/repos/ethereum/consensus-specs",
  "labels_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1974/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1974/comments",
  "events_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1974/events",
  "html_url": "https://github.com/ethereum/consensus-specs/issues/1974",
  "id": 659572862,
  "node_id": "MDU6SXNzdWU2NTk1NzI4NjI=",
  "number": 1974,
  "title": "Phase 1 configuration invariant and minimal config",
  "user": {
    "login": "hwwhww",
    "id": 9263930,
    "node_id": "MDQ6VXNlcjkyNjM5MzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9263930?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hwwhww",
    "html_url": "https://github.com/hwwhww",
    "followers_url": "https://api.github.com/users/hwwhww/followers",
    "following_url": "https://api.github.com/users/hwwhww/following{/other_user}",
    "gists_url": "https://api.github.com/users/hwwhww/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hwwhww/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hwwhww/subscriptions",
    "organizations_url": "https://api.github.com/users/hwwhww/orgs",
    "repos_url": "https://api.github.com/users/hwwhww/repos",
    "events_url": "https://api.github.com/users/hwwhww/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hwwhww/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1170173759,
      "node_id": "MDU6TGFiZWwxMTcwMTczNzU5",
      "url": "https://api.github.com/repos/ethereum/consensus-specs/labels/phase1",
      "name": "phase1",
      "color": "F7C242",
      "default": false,
      "description": ""
    },
    {
      "id": 1295439957,
      "node_id": "MDU6TGFiZWwxMjk1NDM5OTU3",
      "url": "https://api.github.com/repos/ethereum/consensus-specs/labels/scope:CI/tests/pyspec",
      "name": "scope:CI/tests/pyspec",
      "color": "BDC0BA",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2020-07-17T19:42:49Z",
  "updated_at": "2020-08-06T17:40:21Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "I just found that some BLS-enabled tests are broken. (The CI is running with `--disable-bls` flag) Some Issue 1 showed up after I enabled BLS. And then Issue 1 revealed Issue 2 and Issue 3.\r\n\r\n### [FIXED] Issue 1. Suggestion: `EPOCHS_PER_CUSTODY_PERIOD` should be smaller than `EPOCHS_PER_HISTORICAL_VECTOR`. -> fixed in #1990\r\n\r\nFrom the test cases, my understanding is that the period of valid `custody_slashing: SignedCustodySlashing` is that `compute_epoch_at_slot(custody_slashing.attestation.data.slot) + EPOCHS_PER_CUSTODY_PERIOD < get_current_epoch(state)`, where the `state` is the beacon state processing `SignedCustodySlashing`.\r\nIn [process_custody_slashing](https://github.com/ethereum/eth2.0-specs/blob/3e9556202a5535be87e2189c90330f75c5e3c014/specs/phase1/custody-game.md#custody-slashings), it needs to use `state.randao_mixes` to get the seed to verify the `custody_slashing.attestation`. Due to `MIN_SEED_LOOKAHEAD`, the acceptable `SignedCustodySlashing`  has to satisfy `compute_epoch_at_slot(custody_slashing.attestation.data.slot) + EPOCHS_PER_CUSTODY_PERIOD - MIN_SEED_LOOKAHEAD < get_current_epoch(state)`.\r\n\r\n#### Proposal\r\n\r\nTo fix it easily, we can increase `EPOCHS_PER_HISTORICAL_VECTOR` to `128` or decrease `EPOCHS_PER_CUSTODY_PERIOD` to `32`. However, when I set `EPOCHS_PER_CUSTODY_PERIOD` to `32`, some other tests broke. That's another different issue. (see Issue 3 below)\r\n\r\n---\r\n\r\n### [FIXED] Issue 2. Suggestion: set minimal config numbers in a similar ratio of the mainnet config. -> fixed in #1990\r\n\r\nFor example:\r\n- In minimal config, `EARLY_DERIVED_SECRET_PENALTY_MAX_FUTURE_EPOCHS = MAX_CHUNK_CHALLENGE_DELAY = 128 > EPOCHS_PER_HISTORICAL_VECTOR = 64`\r\n- In mainnet config, `EPOCHS_PER_HISTORICAL_VECTOR = 65536 > EARLY_DERIVED_SECRET_PENALTY_MAX_FUTURE_EPOCHS = MAX_CHUNK_CHALLENGE_DELAY > EPOCHS_PER_HISTORICAL_VECTOR = 32768`.\r\n\r\nIt would be better to keep the same ratio or the same order when we scale down the numbers.\r\n\r\n#### Proposal\r\n\r\nAdjust the numbers carefully. This branch is my current trial: https://github.com/ethereum/eth2.0-specs/compare/6a7a47dd5f6ce39cb8fcdbf787325886140191c3...hwwhww/fix-body-root\r\n\r\n---\r\n\r\n### Issue 3. Some block processing custody test cases trigger reveal-deadlines-slashing\r\n\r\nIt's not mainly due to the config numbers failure, but changing config numbers would reveal this issue in some test cases.\r\n\r\nFor example, [`test_process_custody_slashing.py::test_many_epochs_custody`](https://github.com/ethereum/eth2.0-specs/blob/8a2132e65df19643e7c10be93be5451e4eb501aa/tests/core/pyspec/eth2spec/test/phase1/block_processing/test_process_custody_slashing.py#L126) calls [transition_to(spec, state, state.slot + spec.SLOTS_PER_EPOCH * (spec.EPOCHS_PER_CUSTODY_PERIOD - 1))\r\n](https://github.com/ethereum/eth2.0-specs/blob/8a2132e65df19643e7c10be93be5451e4eb501aa/tests/core/pyspec/eth2spec/test/phase1/block_processing/test_process_custody_slashing.py#L95), which would trigger **the epoch processing**. Some validators may get slashed in `process_reveal_deadlines`.\r\n\r\nAnd when we run `process_custody_slashing`, it checks `assert is_slashable_validator(whistleblower, get_current_epoch(state))` and `assert is_slashable_validator(malefactor, get_current_epoch(state))`. The whistleblower and malefactor may have been slashed by `process_reveal_deadlines`, which is not this test case aim to do.\r\n\r\n\r\n---\r\n\r\n### Reference\r\n\r\nThe current mainnet config:\r\n```yaml\r\n# Phase 0\r\n# 2**16 (= 65,536) epochs ~0.8 years\r\nEPOCHS_PER_HISTORICAL_VECTOR: 65536\r\n# 2**13 (= 8,192) epochs ~36 days\r\nEPOCHS_PER_SLASHINGS_VECTOR: 8192\r\n\r\n# Phase 1\r\n# Time parameters\r\n# 2**1 (= 2) epochs, 12.8 minutes\r\nRANDAO_PENALTY_EPOCHS: 2\r\n# 2**15 (= 32,768) epochs, ~146 days\r\nEARLY_DERIVED_SECRET_PENALTY_MAX_FUTURE_EPOCHS: 32768\r\n# 2**14 (= 16,384) epochs ~73 days\r\nEPOCHS_PER_CUSTODY_PERIOD: 16384\r\n# 2**11 (= 2,048) epochs, ~9 days\r\nCUSTODY_PERIOD_TO_RANDAO_PADDING: 2048\r\n# 2**15 (= 32,768) epochs, ~146 days\r\nMAX_CHUNK_CHALLENGE_DELAY: 32768\r\n```\r\n\r\nThe current minimal config:\r\n```yaml\r\n# Phase 0\r\n# [customized] smaller state\r\nEPOCHS_PER_HISTORICAL_VECTOR: 64\r\n# [customized] smaller state\r\nEPOCHS_PER_SLASHINGS_VECTOR: 64\r\n\r\n# Phase 1\r\n# Time parameters\r\n# 2**1 (= 2) epochs\r\nRANDAO_PENALTY_EPOCHS: 2\r\n# [customized] quicker for testing\r\nEARLY_DERIVED_SECRET_PENALTY_MAX_FUTURE_EPOCHS: 128\r\n# [customized] quicker for testing\r\nEPOCHS_PER_CUSTODY_PERIOD: 64\r\n# [customized] quicker for testing\r\nCUSTODY_PERIOD_TO_RANDAO_PADDING: 8\r\n# [customize for faster testing]\r\nMAX_CHUNK_CHALLENGE_DELAY: 128\r\n```\r\n\r\n---\r\n\r\np.s. I haven't completed running custody tests with mainnet config; my laptop is screaming. I'll try to see what I can do with it next week.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1974/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1974/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/670026481",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1974#issuecomment-670026481",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1974",
    "id": 670026481,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3MDAyNjQ4MQ==",
    "user": {
      "login": "dankrad",
      "id": 6130607,
      "node_id": "MDQ6VXNlcjYxMzA2MDc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6130607?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dankrad",
      "html_url": "https://github.com/dankrad",
      "followers_url": "https://api.github.com/users/dankrad/followers",
      "following_url": "https://api.github.com/users/dankrad/following{/other_user}",
      "gists_url": "https://api.github.com/users/dankrad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dankrad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dankrad/subscriptions",
      "organizations_url": "https://api.github.com/users/dankrad/orgs",
      "repos_url": "https://api.github.com/users/dankrad/repos",
      "events_url": "https://api.github.com/users/dankrad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dankrad/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-06T16:13:14Z",
    "updated_at": "2020-08-06T16:13:14Z",
    "author_association": "MEMBER",
    "body": "One suggestion: We could make a flag that stops reveal deadlines from falling due for a given test. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/670026481/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/670047891",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1974#issuecomment-670047891",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1974",
    "id": 670047891,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3MDA0Nzg5MQ==",
    "user": {
      "login": "djrtwo",
      "id": 1433595,
      "node_id": "MDQ6VXNlcjE0MzM1OTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1433595?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djrtwo",
      "html_url": "https://github.com/djrtwo",
      "followers_url": "https://api.github.com/users/djrtwo/followers",
      "following_url": "https://api.github.com/users/djrtwo/following{/other_user}",
      "gists_url": "https://api.github.com/users/djrtwo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djrtwo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djrtwo/subscriptions",
      "organizations_url": "https://api.github.com/users/djrtwo/orgs",
      "repos_url": "https://api.github.com/users/djrtwo/repos",
      "events_url": "https://api.github.com/users/djrtwo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djrtwo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-06T16:50:40Z",
    "updated_at": "2020-08-06T16:50:40Z",
    "author_association": "MEMBER",
    "body": "We could consider putting the entire custody game behind a flag",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/670047891/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/670051926",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1974#issuecomment-670051926",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1974",
    "id": 670051926,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3MDA1MTkyNg==",
    "user": {
      "login": "dankrad",
      "id": 6130607,
      "node_id": "MDQ6VXNlcjYxMzA2MDc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6130607?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dankrad",
      "html_url": "https://github.com/dankrad",
      "followers_url": "https://api.github.com/users/dankrad/followers",
      "following_url": "https://api.github.com/users/dankrad/following{/other_user}",
      "gists_url": "https://api.github.com/users/dankrad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dankrad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dankrad/subscriptions",
      "organizations_url": "https://api.github.com/users/dankrad/orgs",
      "repos_url": "https://api.github.com/users/dankrad/repos",
      "events_url": "https://api.github.com/users/dankrad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dankrad/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-06T16:57:34Z",
    "updated_at": "2020-08-06T16:57:34Z",
    "author_association": "MEMBER",
    "body": "There's no reason for that -- it's only the reveal deadlines that will slash validators without interaction, everything else will only do something when called.\r\nThe advantage of doing only the reveal deadlines is that this flag would also be useful for custody tests, as mentioned above, where you do want the other parts of the custody game active.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/670051926/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
