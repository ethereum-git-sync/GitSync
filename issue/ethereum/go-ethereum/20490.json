{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20490",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20490/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20490/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20490/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/20490",
  "id": 543794354,
  "node_id": "MDU6SXNzdWU1NDM3OTQzNTQ=",
  "number": 20490,
  "title": "LES package refactor",
  "user": {
    "login": "rjl493456442",
    "id": 5959481,
    "node_id": "MDQ6VXNlcjU5NTk0ODE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rjl493456442",
    "html_url": "https://github.com/rjl493456442",
    "followers_url": "https://api.github.com/users/rjl493456442/followers",
    "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
    "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
    "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
    "repos_url": "https://api.github.com/users/rjl493456442/repos",
    "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "rjl493456442",
    "id": 5959481,
    "node_id": "MDQ6VXNlcjU5NTk0ODE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rjl493456442",
    "html_url": "https://github.com/rjl493456442",
    "followers_url": "https://api.github.com/users/rjl493456442/followers",
    "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
    "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
    "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
    "repos_url": "https://api.github.com/users/rjl493456442/repos",
    "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2019-12-30T08:29:58Z",
  "updated_at": "2020-01-08T12:18:21Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "[LES Protocol](https://github.com/ethereum/devp2p/blob/master/caps/les.md)(light ethereum sub-protocol) contains two parts specs and relative implementations: **LES server** and **LES client**.\r\n\r\nUsually **LES server** refers to a full ethereum node that can offer additional data services for free or not. Basically both server and client share the same protocol definition like `protocol message`, `auxiliary structure definitions` and etc. However most of the internal logic of these two parts are totally different.\r\n\r\nFor **LES client**, most logic defined is:\r\n* *how to retrieve the specified piece of chain data or state data as well as the corresponding proof*. \r\n* *how to manage all connected servers and payment strategy*\r\n\r\nFor **LES server**, most logic defined is:\r\n* *how to serve requests from clients*.\r\n* *how to limit requests from clients* \r\n* *how to manage all connected clients and charge strategy*\r\n\r\nBut now in the current implementation, we mix all these parts logic into the same package. It means it's very hard to maintain the code correctly in the long term. So this is a proposal for LES package clean up and refactor.\r\n\r\nThe approximate structure of les codebase looks like:\r\n\r\n```\r\nles\r\n├── checkpointoracle\r\n│   └── oracle.go\r\n├── flowcontrol\r\n│   ├── control.go\r\n│   ├── logger.go\r\n│   ├── manager.go\r\n│   └── manager_test.go\r\n├── lesclient\r\n│   ├── api_backend.go\r\n│   ├── backend.go\r\n│   ├── bloombits.go\r\n│   ├── common.go\r\n│   ├── distributor\r\n│   │   ├── distributor.go\r\n│   │   └── request.go\r\n│   ├── fetcher\r\n│   │   ├── fetcher.go\r\n│   │   └── ulc.go\r\n│   ├── handler.go\r\n│   ├── odr.go\r\n│   ├── odr_requests.go\r\n│   ├── peer.go\r\n│   ├── retriever.go\r\n│   ├── serverpool\r\n│   │   └── serverpool.go\r\n│   ├── sync.go\r\n│   └── txrelay.go\r\n├── lesserver\r\n│   ├── api.go\r\n│   ├── backend.go\r\n│   ├── clientpool\r\n│   │   ├── balance.go\r\n│   │   ├── balance_test.go\r\n│   │   └── clientpool.go\r\n│   ├── costtracker.go\r\n│   ├── enr_entry.go\r\n│   ├── handler.go\r\n│   ├── misc.go\r\n│   ├── peers.go\r\n│   └── servingqueue.go\r\n├── metrics\r\n│   └── metrics.go\r\n├── protocol\r\n│   ├── costable.go\r\n│   └── protocol.go\r\n├── server\r\n│   ├── backend.go\r\n│   ├── common.go\r\n│   ├── costtracker.go\r\n│   ├── handler.go\r\n│   ├── peer.go\r\n│   └── servingqueue.go\r\n└── utilities\r\n    ├── execqueue.go\r\n    ├── execqueue_test.go\r\n    ├── extendablemap.go\r\n    ├── randselect_test.go\r\n    └── randselector.go\r\n\r\n```\r\n\r\nBasically I propose to split a few common utilities used by both server and client in the `utilities` sub-package. All protocol relative message and structures are all moved to `protocol` sub-package.\r\n\r\nAll in all, it's the purposal for cleanup current les package for long term maintenance. Need input from internal team members especially @zsfelfoldi .\r\n\r\n- [ ] Separate  `utilities`  https://github.com/ethereum/go-ethereum/pull/20509\r\n- [ ] Separate `protocol` https://github.com/ethereum/go-ethereum/pull/20516\r\n- [x] Separate `checkpoint` https://github.com/ethereum/go-ethereum/pull/20508\r\n- [ ] Separate `lesserver` and `lesclient`\r\n- [ ] Aggregate capacity management code",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20490/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20490/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/570191292",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20490#issuecomment-570191292",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20490",
    "id": 570191292,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3MDE5MTI5Mg==",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-01-02T12:14:43Z",
    "updated_at": "2020-01-02T12:14:43Z",
    "author_association": "MEMBER",
    "body": "https://github.com/rjl493456442/go-ethereum/tree/separate-les is an experiment branch for revamp",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/570191292/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/572023368",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20490#issuecomment-572023368",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20490",
    "id": 572023368,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3MjAyMzM2OA==",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-01-08T12:17:07Z",
    "updated_at": "2020-01-08T12:17:07Z",
    "author_association": "MEMBER",
    "body": "In the server side, we have two logic modules: flow control and capacity management.\r\n\r\nFor the flow control, it's a shared package used by client and server, which capacity management is server special. However now a few capacity management relative code is mixed in flow control package.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/572023368/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
