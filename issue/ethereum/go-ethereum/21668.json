{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21668",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21668/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21668/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21668/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/21668",
  "id": 715852416,
  "node_id": "MDU6SXNzdWU3MTU4NTI0MTY=",
  "number": 21668,
  "title": "Geth Websocket Connections Return 200",
  "user": {
    "login": "BisonAl",
    "id": 56267776,
    "node_id": "MDQ6VXNlcjU2MjY3Nzc2",
    "avatar_url": "https://avatars.githubusercontent.com/u/56267776?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/BisonAl",
    "html_url": "https://github.com/BisonAl",
    "followers_url": "https://api.github.com/users/BisonAl/followers",
    "following_url": "https://api.github.com/users/BisonAl/following{/other_user}",
    "gists_url": "https://api.github.com/users/BisonAl/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/BisonAl/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/BisonAl/subscriptions",
    "organizations_url": "https://api.github.com/users/BisonAl/orgs",
    "repos_url": "https://api.github.com/users/BisonAl/repos",
    "events_url": "https://api.github.com/users/BisonAl/events{/privacy}",
    "received_events_url": "https://api.github.com/users/BisonAl/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-10-06T16:47:32Z",
  "updated_at": "2022-07-15T01:32:09Z",
  "closed_at": "2020-10-06T19:15:40Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\nGeth version: `1.9.20`\r\nOS & Version: Alpine\r\n\r\nRunning both websocket and rpc on port `8545`, using the\r\n```\r\n--ws.port\r\n8545\r\n```\r\nflag\r\n\r\n#### Expected behaviour\r\nWhen attempting to query the rpc endpoint over `https` at `/` and port `8545`, a correct response is served.\r\n\r\nWhen attempting to connect to the websocket over `wss` endpoint at `/` and port `8545`, while passing through the headers:\r\n```\r\nConnection: Upgrade\r\nUpgrade: websocket\r\n```\r\na lasting websocket connection is made.\r\n\r\n#### Actual behaviour\r\nWhen attempting to query the rpc endpoint over `https` at `/` and port `8545`, a correct response is served.\r\n\r\nWhen attempting to connect to the websocket over `wss` endpoint at `/` and port `8545`, while passing through the headers:\r\n```\r\nConnection: Upgrade\r\nUpgrade: websocket\r\n```\r\nI'll get back a `200` response code instead, and no lasting connection made.\r\n\r\nThe same behavior was encountered with a variety of tools:\r\n\r\n```\r\n~ ❯ wscat -c wss://myethereumurl.net                    \r\nerror: Unexpected server response: 200\r\n\r\n~ ❯ geth attach wss://myethereumurl.net\r\nFatal: Unable to attach to remote geth: websocket: bad handshake (HTTP status 200 OK)\r\n\r\n~ ❯ websocat -k wss://myethereumurl.net \r\nwebsocat: WebSocketError: Received unexpected status code (200 OK)\r\nwebsocat: error running\r\n```\r\n\r\nMy theory is that geth is not treating this incoming request as an websocket connection, and is not switching protocols properly. \r\n\r\n#### Steps to reproduce the behaviour\r\n- Create a geth full node on `v1.9.20` with websocket and rpc served at port `8545`.\r\n- Expose this geth node to external traffic\r\n- Attempt to establish a websocket connection using `wss://`, with a tool such as `geth attach`, `wscat` or `websocat`\r\n- See that you'll receive a 200 error code back.\r\n\r\n#### Additional Note\r\nWondering if anyone else has ran into this, and may have some additional insight. I am not sure if this is a bug, or an expected result given the way I'm trying to interact with my node.\r\n\r\nMy setup was working on geth `1.9.13`, however since then I know there's been a good deal of work done overhauling websockets. I'm wondering if there's any changes since then that could be causing this behavior, however I couldn't find any details in recent release notes.\r\n\r\nIf this is a known issue and can be solved by altering my configuration, I would greatly appreciate the insight!\r\n\r\n",
  "closed_by": {
    "login": "BisonAl",
    "id": 56267776,
    "node_id": "MDQ6VXNlcjU2MjY3Nzc2",
    "avatar_url": "https://avatars.githubusercontent.com/u/56267776?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/BisonAl",
    "html_url": "https://github.com/BisonAl",
    "followers_url": "https://api.github.com/users/BisonAl/followers",
    "following_url": "https://api.github.com/users/BisonAl/following{/other_user}",
    "gists_url": "https://api.github.com/users/BisonAl/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/BisonAl/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/BisonAl/subscriptions",
    "organizations_url": "https://api.github.com/users/BisonAl/orgs",
    "repos_url": "https://api.github.com/users/BisonAl/repos",
    "events_url": "https://api.github.com/users/BisonAl/events{/privacy}",
    "received_events_url": "https://api.github.com/users/BisonAl/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21668/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21668/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/704496014",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21668#issuecomment-704496014",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21668",
    "id": 704496014,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwNDQ5NjAxNA==",
    "user": {
      "login": "BisonAl",
      "id": 56267776,
      "node_id": "MDQ6VXNlcjU2MjY3Nzc2",
      "avatar_url": "https://avatars.githubusercontent.com/u/56267776?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/BisonAl",
      "html_url": "https://github.com/BisonAl",
      "followers_url": "https://api.github.com/users/BisonAl/followers",
      "following_url": "https://api.github.com/users/BisonAl/following{/other_user}",
      "gists_url": "https://api.github.com/users/BisonAl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/BisonAl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/BisonAl/subscriptions",
      "organizations_url": "https://api.github.com/users/BisonAl/orgs",
      "repos_url": "https://api.github.com/users/BisonAl/repos",
      "events_url": "https://api.github.com/users/BisonAl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/BisonAl/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-06T19:12:22Z",
    "updated_at": "2020-10-06T19:13:36Z",
    "author_association": "NONE",
    "body": "Issue solved, we can close it when https://github.com/ethereum/go-ethereum/pull/21646 is merged.\r\n\r\nOn second thought, going to close this issue as a duplicate of https://github.com/ethereum/go-ethereum/issues/21525.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/704496014/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1184854219",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21668#issuecomment-1184854219",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21668",
    "id": 1184854219,
    "node_id": "IC_kwDOAOvK985Gn3DL",
    "user": {
      "login": "BrockMcCullough",
      "id": 90647035,
      "node_id": "MDQ6VXNlcjkwNjQ3MDM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/90647035?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/BrockMcCullough",
      "html_url": "https://github.com/BrockMcCullough",
      "followers_url": "https://api.github.com/users/BrockMcCullough/followers",
      "following_url": "https://api.github.com/users/BrockMcCullough/following{/other_user}",
      "gists_url": "https://api.github.com/users/BrockMcCullough/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/BrockMcCullough/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/BrockMcCullough/subscriptions",
      "organizations_url": "https://api.github.com/users/BrockMcCullough/orgs",
      "repos_url": "https://api.github.com/users/BrockMcCullough/repos",
      "events_url": "https://api.github.com/users/BrockMcCullough/events{/privacy}",
      "received_events_url": "https://api.github.com/users/BrockMcCullough/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-14T20:12:44Z",
    "updated_at": "2022-07-14T21:32:54Z",
    "author_association": "NONE",
    "body": "I realize this issue has been closed for a while, but I am seeing *almost* this exact problem again on version `1.10.20`.  \r\n\r\nAttaching directly to port `8546` works without issue using `web3` libraries and `wscat -c ws://localhost:8546`. However, using seemingly _any_ proxy causes this issue to resurface, so far I have not been able to figure out why. Testing with both `nginx` and `envoy` has given the same result, `HTTP 200` on the websocket upgrade attempt. In the `nginx` logs I can see the correct upgrade headers being passed, the configuration for both proxies is presumably correct (works with other services), but with both `geth` and `bor`, the websocket connections do not work. \r\n\r\nReplication: I'm running a Geth node with the default ports. The node has been functional for a few weeks and tested (on localhost). \r\n[envoy.yaml.zip](https://github.com/ethereum/go-ethereum/files/9115020/envoy.yaml.zip)\r\n1. Add reverse proxy to the node, I've attached a config for envoy here that is listening on `8544` for websocket and forwarding to `8546`. Can add `nginx` config as well, but has the same result.  \r\n2. Run `wscat -c ws://localhost:8544/ws`\r\n3. Above will return: `error: Unexpected server response: 200`\r\n\r\nAlso attached are some screenshots of logs from debugging. The first is the expected `101 Switching Protocol` response that is expected from the successful websocket call. This was pulled from an identical `nginx` configuration running on my Solana node. Next to that is the `HTTP 200` being returned by Geth on the upgrade request, even with the correct headers. Any help or suggestions appreciated, going to try an older version of Geth now, then keep trying alternate configs to see what shakes loose. \r\n\r\nFrom geth.service: \r\n`User=ubuntu`\r\n\r\n`ExecStart=/usr/bin/geth --datadir /node_data --signer=/node_data/clef/clef.ipc --goerli --syncmode snap --http --http.api personal,eth,net,web3 --ws --ws.origins '*' --ws.api eth,net,web3`\r\n\r\n![Screen Shot 2022-07-13 at 2 03 42 PM](https://user-images.githubusercontent.com/90647035/179074185-06bc9e0e-20d4-49e5-a4a8-d587baa768bb.png)\r\n \r\n![Screen Shot 2022-07-13 at 2 01 43 PM](https://user-images.githubusercontent.com/90647035/179074182-049aeefc-4317-4bb9-88fb-c5db9e96e360.png)\r\n\r\nAlso adding Envoy logs:\r\n![Screen Shot 2022-07-14 at 2 09 23 PM](https://user-images.githubusercontent.com/90647035/179086538-182df35e-0f65-4528-8c01-9b084af4ffd2.png)\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1184854219/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
