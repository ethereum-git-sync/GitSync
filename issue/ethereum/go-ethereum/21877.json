{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21877",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21877/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21877/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21877/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/21877",
  "id": 746546754,
  "node_id": "MDU6SXNzdWU3NDY1NDY3NTQ=",
  "number": 21877,
  "title": "db ignores files handle limit (during shutdown)",
  "user": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    },
    {
      "id": 2518526877,
      "node_id": "MDU6TGFiZWwyNTE4NTI2ODc3",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/area:db",
      "name": "area:db",
      "color": "006b75",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2020-11-19T12:36:14Z",
  "updated_at": "2020-11-20T10:40:59Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "This happens while shutting down the node, as the database is being closed:\r\n\r\n```\r\narchive@archive:~$ lsof -p 18496 > lsof.1\r\narchive@archive:~$ lsof -p 18496 > lsof.2\r\narchive@archive:~$ lsof -p 18496 > lsof.3\r\narchive@archive:~$ wc -l lsof.1\r\n298017 lsof.1\r\narchive@archive:~$ wc -l lsof.2\r\n321139 lsof.2\r\narchive@archive:~$ wc -l lsof.3\r\n1000227 lsof.3\r\n```\r\nThe db keeps opening ldb files:\r\n```\r\narchive@archive:~$ cat lsof.1 | grep \".ldb\" | wc -l\r\n297967\r\narchive@archive:~$ cat lsof.2 | grep \".ldb\" | wc -l\r\n321100\r\narchive@archive:~$ cat lsof.3 | grep \".ldb\" | wc -l\r\n1000184\r\n```\r\nTo clarify: despite the geth file handles having been limited to ~500K, the process has 1M+ file handles opened!\r\n\r\nThis is during _shutdown_, so there's no block processing happening. There hasn't even been any, because I told it to shut down before it even started getting any blocks to import. \r\n\r\n## Tangential about networking \r\n\r\nEventually, this causes networking to fail, which incidentally\r\nexplains why ssh sessions become torn down (some other ticket).\r\n\r\nIt also causes a \"temporary error\" in p2p to happen, which causes a spin-loop:\r\n```\r\narchive@archive:~$ cat dump2.log | grep \"Temporary read error\" | wc -l\r\n12832728\r\n```\r\n\r\nI've added a change to fix the spin-loop effect (on https://github.com/holiman/go-ethereum/tree/archivefix, commit https://github.com/ethereum/go-ethereum/commit/fd53776780804c8ad24f67108c22ca0ac5995556). \r\n\r\n## Back the the root problem\r\n\r\nEssentially the problem is: \r\n\r\n- If the database is huge (archive node), closing the db seems to have the effect of \r\n  triggering something (compaction?) which does not respect the given limit on handles, \r\n  and which eventually causes OOM.\r\n  \r\nActual number of ldb-files are close to `3M`: \r\n```\r\narchive@archive:~$ ls -l ~/geth_data/geth/chaindata/ | wc -l\r\n2923415\r\n```\r\n\r\nI eventually killed it. Probably related parts of the stack: \r\n```\r\ngoroutine 40 [runnable]:\r\ngithub.com/syndtr/goleveldb/leveldb/util.(*BufferPool).Put(0xc000136fc0, 0xcf1ce4f400, 0x11ef, 0x200a)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/util/buffer_pool.go:158 +0x184\r\ngithub.com/syndtr/goleveldb/leveldb/table.(*Reader).readRawBlock(0xcc32ce6f70, 0x0, 0x11ea, 0xdc91e48a1ce63501, 0x8, 0xc022323198, 0x713402, 0x0, 0x0)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/table/reader.go:589 +0x551\r\ngithub.com/syndtr/goleveldb/leveldb/table.(*Reader).readBlock(0xcc32ce6f70, 0x0, 0x11ea, 0x1, 0x0, 0x71bb63, 0x12ed060)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/table/reader.go:603 +0x55\r\ngithub.com/syndtr/goleveldb/leveldb/table.(*Reader).readBlockCached(0xcc32ce6f70, 0x0, 0x11ea, 0xccea270001, 0xccea278090, 0xc022323438, 0x7183f0, 0xccea278090, 0x44ac6a)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/table/reader.go:648 +0x1fe\r\ngithub.com/syndtr/goleveldb/leveldb/table.(*Reader).getDataIter(0xcc32ce6f70, 0x0, 0x11ea, 0x0, 0x1, 0x0, 0x3)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/table/reader.go:765 +0x5b\r\ngithub.com/syndtr/goleveldb/leveldb/table.(*Reader).getDataIterErr(0xcc32ce6f70, 0x0, 0x11ea, 0x0, 0x1, 0x0, 0x0)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/table/reader.go:780 +0x160\r\ngithub.com/syndtr/goleveldb/leveldb/table.(*indexIter).Get(0xcc32c76a20, 0xcc32d3e5a0, 0x709501)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/table/reader.go:507 +0x2b0\r\ngithub.com/syndtr/goleveldb/leveldb/iterator.(*indexedIterator).setData(0xcc32cd1080)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/iterator/indexed_iter.go:39 +0x41\r\ngithub.com/syndtr/goleveldb/leveldb/iterator.(*indexedIterator).First(0xcc32cd1080, 0xcf1cee4060)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/iterator/indexed_iter.go:88 +0xfe\r\ngithub.com/syndtr/goleveldb/leveldb/iterator.(*mergedIterator).First(0xca950b5a00, 0xc000197560)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/iterator/merged_iter.go:72 +0x8a\r\ngithub.com/syndtr/goleveldb/leveldb/iterator.(*mergedIterator).Next(0xca950b5a00, 0x15ae420)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/iterator/merged_iter.go:157 +0x322\r\ngithub.com/syndtr/goleveldb/leveldb.(*tableCompactionBuilder).run(0xc000234640, 0xc00019d170, 0x0, 0x0)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/db_compaction.go:442 +0x31a\r\ngithub.com/syndtr/goleveldb/leveldb.(*DB).compactionTransact(0xc000282000, 0x1320774, 0xb, 0x15895a0, 0xc000234640)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/db_compaction.go:186 +0x181\r\ngithub.com/syndtr/goleveldb/leveldb.(*DB).tableCompaction(0xc000282000, 0xc000160000, 0xc000120100)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/db_compaction.go:580 +0x63f\r\ngithub.com/syndtr/goleveldb/leveldb.(*DB).tableAutoCompaction(0xc000282000)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/db_compaction.go:644 +0x54\r\ngithub.com/syndtr/goleveldb/leveldb.(*DB).tCompaction(0xc000282000)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/db_compaction.go:863 +0x2ef\r\ncreated by github.com/syndtr/goleveldb/leveldb.openDB\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/db.go:155 +0x582\r\n\r\ngoroutine 93 [select]:\r\ngithub.com/syndtr/goleveldb/leveldb/util.(*BufferPool).drain(0xc000137340)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/util/buffer_pool.go:209 +0x134\r\ncreated by github.com/syndtr/goleveldb/leveldb/util.NewBufferPool\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/util/buffer_pool.go:240 +0x176\r\n\r\ngoroutine 94 [select, 6 minutes]:\r\ngithub.com/syndtr/goleveldb/leveldb.(*session).refLoop(0xc2a5d13ef0)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/session_util.go:189 +0x5f9\r\ncreated by github.com/syndtr/goleveldb/leveldb.newSession\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/session.go:93 +0x2b4\r\n\r\ngoroutine 95 [select, 24 minutes]:\r\ngithub.com/syndtr/goleveldb/leveldb.(*DB).compactionError(0xc0000d2000)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/db_compaction.go:91 +0xcd\r\ncreated by github.com/syndtr/goleveldb/leveldb.openDB\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/db.go:148 +0x40c\r\n\r\ngoroutine 96 [select, 2 minutes]:\r\ngithub.com/syndtr/goleveldb/leveldb.(*DB).mpoolDrain(0xc0000d2000)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/db_state.go:101 +0xf6\r\ncreated by github.com/syndtr/goleveldb/leveldb.openDB\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/db.go:149 +0x42e\r\n\r\ngoroutine 97 [select, 24 minutes]:\r\ngithub.com/syndtr/goleveldb/leveldb.(*DB).tCompaction(0xc0000d2000)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/db_compaction.go:836 +0x25d\r\ncreated by github.com/syndtr/goleveldb/leveldb.openDB\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/db.go:155 +0x582\r\n\r\ngoroutine 98 [select, 24 minutes]:\r\ngithub.com/syndtr/goleveldb/leveldb.(*DB).mCompaction(0xc0000d2000)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/db_compaction.go:773 +0x150\r\ncreated by github.com/syndtr/goleveldb/leveldb.openDB\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/db.go:156 +0x5a4\r\n\r\ngoroutine 279 [semacquire, 24 minutes]:\r\nsync.runtime_Semacquire(0xc000282188)\r\n\truntime/sema.go:56 +0x42\r\nsync.(*WaitGroup).Wait(0xc000282180)\r\n\tsync/waitgroup.go:130 +0x64\r\ngithub.com/syndtr/goleveldb/leveldb.(*DB).Close(0xc000282000, 0xc2be3b3d80, 0xc2be1c6060)\r\n\tgithub.com/syndtr/goleveldb@v1.0.1-0.20200815110645-5c35d600f0ca/leveldb/db.go:1175 +0x1ad\r\ngithub.com/ethereum/go-ethereum/ethdb/leveldb.(*Database).Close(0xc000218100, 0x0, 0x0)\r\n\tgithub.com/ethereum/go-ethereum@/ethdb/leveldb/leveldb.go:150 +0xb1\r\ngithub.com/ethereum/go-ethereum/core/rawdb.(*freezerdb).Close(0xc0001f6420, 0xc0004db740, 0xc0001f6440)\r\n\tgithub.com/ethereum/go-ethereum@/core/rawdb/database.go:48 +0x8a\r\ngithub.com/ethereum/go-ethereum/node.(*closeTrackingDB).Close(0xc0001f6440, 0x0, 0x0)\r\n\tgithub.com/ethereum/go-ethereum@/node/node.go:606 +0x90\r\ngithub.com/ethereum/go-ethereum/eth.(*Ethereum).Stop(0xc000136c40, 0xc2be1a1700, 0x206d800)\r\n\tgithub.com/ethereum/go-ethereum@/eth/backend.go:546 +0xcc\r\ngithub.com/ethereum/go-ethereum/node.(*Node).stopServices(0xc0000a5040, 0xc292fd6d50, 0x1, 0x1, 0x0, 0x0)\r\n\tgithub.com/ethereum/go-ethereum@/node/node.go:282 +0xbd\r\ngithub.com/ethereum/go-ethereum/node.(*Node).Close(0xc0000a5040, 0x0, 0x0)\r\n\tgithub.com/ethereum/go-ethereum@/node/node.go:204 +0x13f\r\ncreated by github.com/ethereum/go-ethereum/cmd/utils.StartNode.func1\r\n\tgithub.com/ethereum/go-ethereum@/cmd/utils/cmd.go:76 +0x184\r\n```\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21877/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21877/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/730397893",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21877#issuecomment-730397893",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21877",
    "id": 730397893,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMDM5Nzg5Mw==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-19T14:05:48Z",
    "updated_at": "2020-11-19T14:05:48Z",
    "author_association": "MEMBER",
    "body": "cc @rjl493456442 any ideas? ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/730397893/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/730855692",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21877#issuecomment-730855692",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21877",
    "id": 730855692,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMDg1NTY5Mg==",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-20T05:14:57Z",
    "updated_at": "2020-11-20T05:14:57Z",
    "author_association": "MEMBER",
    "body": "Regarding the fdlimit, I'm not sure it's Geth doesn't respect the limitation, but we do give a very high number for it\r\n\r\n```go\r\n\r\n// makeDatabaseHandles raises out the number of allowed file handles per process\r\n// for Geth and returns half of the allowance to assign to the database.\r\nfunc makeDatabaseHandles() int {\r\n\tlimit, err := fdlimit.Maximum()\r\n\tif err != nil {\r\n\t\tFatalf(\"Failed to retrieve file descriptor allowance: %v\", err)\r\n\t}\r\n\traised, err := fdlimit.Raise(uint64(limit))\r\n\tif err != nil {\r\n\t\tFatalf(\"Failed to raise file descriptor allowance: %v\", err)\r\n\t}\r\n\treturn int(raised / 2) // Leave half for networking and other stuff\r\n}\r\n\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/730855692/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/730855793",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21877#issuecomment-730855793",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21877",
    "id": 730855793,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMDg1NTc5Mw==",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-20T05:15:20Z",
    "updated_at": "2020-11-20T05:15:20Z",
    "author_association": "MEMBER",
    "body": "For the leveldb, it will maintain all the handlers for all \"referenced\" sstables. So it's the reason why we open 3m files because the ldb has 3m files.\r\n\r\nFirst, should we set a hardcap for the openfile cache? The FdCache is really useful for READ, because it caches the metadata and can prevent to open the files over and over again. While the downside is during the shutdown we have to close 3M files. I guess it will take a long time.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/730855793/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/730855830",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21877#issuecomment-730855830",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21877",
    "id": 730855830,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMDg1NTgzMA==",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-20T05:15:26Z",
    "updated_at": "2020-11-20T05:15:26Z",
    "author_association": "MEMBER",
    "body": "https://github.com/syndtr/goleveldb/blob/master/leveldb/db.go#L1175\r\n\r\nObviously, it's waiting for all the background threads, (e.g. close the fd cache)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/730855830/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/730971110",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21877#issuecomment-730971110",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21877",
    "id": 730971110,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMDk3MTExMA==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-20T07:44:52Z",
    "updated_at": "2020-11-20T07:44:52Z",
    "author_association": "MEMBER",
    "body": "More info\r\n```\r\nWARN [11-19|11:37:53.616] Sanitizing cache to Go's GC limits       provided=16384 updated=10721\r\nDEBUG[11-19|11:37:53.616] Sanitizing Go's GC trigger               percent=20\r\nINFO [11-19|11:37:53.620] Maximum peer count                       ETH=50 LES=0 total=50\r\nINFO [11-19|11:37:53.620] Smartcard socket not found, disabling    err=\"stat /run/pcscd/pcscd.comm: no such file or directory\"\r\nDEBUG[11-19|11:37:53.621] FS scan times                            list=\"76.036µs\" set=\"3.839µs\" diff=\"4.2µs\"\r\nINFO [11-19|11:37:53.623] Set global gas cap                       cap=25000000\r\nINFO [11-19|11:37:53.623] Allocated trie memory caches             clean=5.23GiB dirty=0.00B\r\nINFO [11-19|11:37:53.623] Allocated cache and file handles         database=/home/archive/geth_data/geth/chaindata cache=5.23GiB handles=524288\r\n```\r\nThat message is printed in `ethdb/leveldb/leveldb.go`, so `524288` is what we give `leveldb` as the `OpenFilesCacheCapacity`, which is thus ignored. Which seems like a bug, to me",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/730971110/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/731082626",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21877#issuecomment-731082626",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21877",
    "id": 731082626,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMTA4MjYyNg==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-20T10:22:56Z",
    "updated_at": "2020-11-20T10:24:24Z",
    "author_association": "MEMBER",
    "body": "Some more info... The file descriptors grows until the OS won't give any more. That does not cause leveldb to crash, however, but the memory consumption grows to ~24Gb \r\n\r\nThe initial boot said: \r\n```\r\nWARN [11-20|10:00:56.198] Sanitizing cache to Go's GC limits       provided=16384 updated=10721\r\n```\r\nSo we're apparently at 2.4x the memory that we gave it\r\n\r\n```\r\nOpen ldb files:\r\n1048548\r\nMB memory used:\r\n22685\r\nOpen ldb files:\r\n1048548\r\nMB memory used:\r\n23677\r\nOpen ldb files:\r\n1048548\r\nMB memory used:\r\n24568\r\nOpen ldb files:\r\n1048548\r\nMB memory used:\r\n24887\r\nOpen ldb files:\r\n1048548\r\nMB memory used:\r\n24919\r\nOpen ldb files:\r\n1048548\r\nMB memory used:\r\n24831\r\n```\r\nscript: \r\n```bash\r\npid=6861\r\nwhile :\r\ndo\r\n  echo \"Open ldb files:\"\r\n  lsof -p $pid | grep ldb | wc -l\r\n  echo \"MB memory used:\"\r\n  ps -o rss= $pid | awk '{printf \"%.0f\\n\", $1 / 1024}'\r\ndone\r\n```\r\nAgain: it has not imported a single block, just start + stop, and the shutdown sequence has been going on for 15 minutes at least now\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/731082626/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/731084479",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21877#issuecomment-731084479",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21877",
    "id": 731084479,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMTA4NDQ3OQ==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-20T10:26:36Z",
    "updated_at": "2020-11-20T10:26:36Z",
    "author_association": "MEMBER",
    "body": "Shutdown finished after `18m` (not OOM-reaped this time)\r\n\r\nSo then the question might be if we can prevent the memory blowup during compaction? ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/731084479/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/731091565",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21877#issuecomment-731091565",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21877",
    "id": 731091565,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMTA5MTU2NQ==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-20T10:40:59Z",
    "updated_at": "2020-11-20T10:40:59Z",
    "author_association": "MEMBER",
    "body": "On the archive node: \r\n```\r\narchive@archive:~$ iostat -d -x\r\nLinux 5.4.0-53-generic (archive) \t11/20/20 \t_x86_64_\t(4 CPU)\r\n\r\nDevice            r/s     rkB/s   rrqm/s  %rrqm r_await rareq-sz     w/s     wkB/s   wrqm/s  %wrqm w_await wareq-sz     d/s     dkB/s   drqm/s  %drqm d_await dareq-sz  aqu-sz  %util\r\nfd0              0.00      0.00     0.00   0.00 12361.80     4.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00   0.00\r\nloop0            0.00      0.01     0.00   0.00    0.32     9.04    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00   0.00\r\nloop1            0.02      0.03     0.00   0.00    0.41     1.38    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00   0.00\r\nloop2            0.00      0.03     0.00   0.00    0.73    21.57    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00   0.00\r\nloop3            0.00      0.03     0.00   0.00    0.53    18.06    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00   0.00\r\nloop4            0.00      0.01     0.00   0.00    0.50     9.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00   0.00\r\nloop5            0.00      0.01     0.00   0.00    1.34     4.95    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00   0.00\r\nloop6            0.00      0.00     0.00   0.00    0.00     1.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00   0.00\r\nmd0            124.89   1135.50     0.00   0.00    0.00     9.09   27.65    139.54     0.00   0.00    0.00     5.05    0.00      0.00     0.00   0.00    0.00     0.00    0.00   0.00\r\nsda              6.34     60.88     1.71  21.22    1.00     9.60    0.69     22.05     4.90  87.73    8.82    32.15    0.00      0.00     0.00   0.00    0.00     0.00    0.01   1.10\r\nsdb             10.11     73.28     1.71  14.46    0.69     7.25    0.65     21.64     4.84  88.13    9.02    33.22    0.00      0.00     0.00   0.00    0.00     0.00    0.01   1.48\r\nsdc             42.11    410.92     1.89   4.30    0.33     9.76    0.73     22.66     5.02  87.36    9.03    31.22    0.00      0.00     0.00   0.00    0.00     0.00    0.01   3.17\r\nsdd              4.04     43.34     1.87  31.70    1.53    10.74    0.71     22.58     5.01  87.56    9.13    31.72    0.00      0.00     0.00   0.00    0.00     0.00    0.01   0.86\r\nsde             40.32    399.20     1.68   4.00    0.32     9.90    0.65     22.20     4.98  88.49    8.88    34.26    0.00      0.00     0.00   0.00    0.00     0.00    0.01   3.12\r\nsdf              6.43     63.07     1.81  21.99    1.00     9.81    0.69     22.59     5.03  87.88    8.92    32.56    0.00      0.00     0.00   0.00    0.00     0.00    0.01   1.13\r\nsdg             10.11     73.43     1.68  14.26    0.70     7.27    0.65     22.09     4.95  88.39    9.06    33.97    0.00      0.00     0.00   0.00    0.00     0.00    0.01   1.50\r\nsdh              3.87     41.22     1.71  30.66    1.71    10.66    0.68     22.22     4.96  88.00    8.92    32.86    0.00      0.00     0.00   0.00    0.00     0.00    0.01   0.88\r\n\r\n```\r\n\r\nCompared with https://github.com/ethereum/go-ethereum/issues/21648#issuecomment-702274506 : \r\n\r\non our aws node, `rkB/s` is `8712`: \r\n```\r\nDevice            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util\r\nnvme0n1        735.15   82.32   8712.76   8506.39     3.10    53.63   0.42  39.45    0.14    1.64   0.08    11.85   103.34   0.39  31.69\r\n```\r\narchive node, `rKB/s` is `1135`: \r\n```\r\nDevice            r/s     rkB/s   rrqm/s  %rrqm r_await rareq-sz     w/s     wkB/s   wrqm/s  %wrqm w_await wareq-sz     d/s     dkB/s   drqm/s  %drqm d_await dareq-sz  aqu-sz  %util\r\nmd0            124.89   1135.50     0.00   0.00    0.00     9.09   27.65    139.54     0.00   0.00    0.00     5.05    0.00      0.00     0.00   0.00    0.00     0.00    0.00   0.00\r\n\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/731091565/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
