{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24457",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24457/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24457/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24457/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/24457",
  "id": 1147276597,
  "node_id": "I_kwDOAOvK985EYg01",
  "number": 24457,
  "title": "[Question] Why does snap sync sometimes switch to full sync?",
  "user": {
    "login": "dzou",
    "id": 3209274,
    "node_id": "MDQ6VXNlcjMyMDkyNzQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3209274?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dzou",
    "html_url": "https://github.com/dzou",
    "followers_url": "https://api.github.com/users/dzou/followers",
    "following_url": "https://api.github.com/users/dzou/following{/other_user}",
    "gists_url": "https://api.github.com/users/dzou/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dzou/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dzou/subscriptions",
    "organizations_url": "https://api.github.com/users/dzou/orgs",
    "repos_url": "https://api.github.com/users/dzou/repos",
    "events_url": "https://api.github.com/users/dzou/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dzou/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 268304226,
      "node_id": "MDU6TGFiZWwyNjgzMDQyMjY=",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:docs",
      "name": "type:docs",
      "color": "fef2c0",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2022-02-22T19:15:08Z",
  "updated_at": "2022-08-16T10:25:07Z",
  "closed_at": "2022-02-23T08:10:42Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hey, I have a question about what happens if a fully synced up node is shutdown for some time, and then wants to be synced up again? Is it possible to \"catch up\" the node using snap sync?\r\n\r\nI see in my case, I see that [snap sync switches back to full sync from this line](https://github.com/ethereum/go-ethereum/blob/adc0a6adca90c4a784b7eb9ba88c1af15fd2b681/eth/handler.go#L163).\r\n\r\n```\r\nINFO [02-09|20:42:17.378] Initialising Ethereum protocol           network=1 dbversion=8\r\nINFO [02-09|20:42:18.604] Loaded most recent local header          number=786,629 hash=54da69..b98d10 td=5,014,519,227,691,977,823 age=6y2mo1w\r\nINFO [02-09|20:42:18.604] Loaded most recent local full block      number=786,629 hash=54da69..b98d10 td=5,014,519,227,691,977,823 age=6y2mo1w\r\nINFO [02-09|20:42:18.604] Loaded most recent local fast block      number=786,629 hash=54da69..b98d10 td=5,014,519,227,691,977,823 age=6y2mo1w\r\nINFO [02-09|20:42:18.614] Loaded local transaction journal         transactions=0 dropped=0\r\nINFO [02-09|20:42:18.614] Regenerated local transaction journal    transactions=0 accounts=0\r\nWARN [02-09|20:42:18.614] Switch sync mode from snap sync to full sync\r\n```\r\n\r\nCould someone explain why the sync-mode gets switched?\r\n\r\nAlso, I see in my logs that I already have some blocks. I'm working with a base image that already has some blocks downloaded; we thought that this would help speed things up. But now I think this may not be the case if we have understood `snap` sync incorrectly.",
  "closed_by": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24457/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24457/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1048532787",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/24457#issuecomment-1048532787",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24457",
    "id": 1048532787,
    "node_id": "IC_kwDOAOvK984-f1cz",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-23T08:10:42Z",
    "updated_at": "2022-02-23T08:10:42Z",
    "author_association": "MEMBER",
    "body": "There are two types of sync, which both leads to a \"full node\". \r\n- statesync: `syncmode=snap` (or the old `syncmode=fast`)\r\n  - In this mode, the \"current\" state is downloaded from peers. With \"current\", I mean that it aims for the state at block `N`, where `N` is close to head when the sync starts, also called the pivot point. Since we cannot sync up quickly enough, we move the pivot point forward from time to time. Eventually, geth has the complete state for a certain block, but has still maybe ~100 blocks remaining to be fully in sync with head.  \r\n  - Once this mode reaches the point where it has the full state for a certain block, it switches over to \"block-by-block\" sync.\r\n- block-by-block-sync: `syncmode=full`. \r\n  - In this mode, geth imports and executes the contents of each block, from genesis to head. \r\n\r\nIf geth has performed a state-sync at any point, it will never redo that, but always progress block by block. It _is_ possible to bypass this, by deleting a certain metadata field (which one I don't recall right now), and do a new statesync, but it's not something we have implemented as part of the \"normal ux\". \r\n\r\nIn your logs, you seem ot have started a full-sync and gone up to block 786K. After a block-by-block sync is started, regardless of what you tell it to do, it will continue with the block-by-block sync. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1048532787/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1048960215",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/24457#issuecomment-1048960215",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24457",
    "id": 1048960215,
    "node_id": "IC_kwDOAOvK984-hdzX",
    "user": {
      "login": "dzou",
      "id": 3209274,
      "node_id": "MDQ6VXNlcjMyMDkyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3209274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dzou",
      "html_url": "https://github.com/dzou",
      "followers_url": "https://api.github.com/users/dzou/followers",
      "following_url": "https://api.github.com/users/dzou/following{/other_user}",
      "gists_url": "https://api.github.com/users/dzou/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dzou/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dzou/subscriptions",
      "organizations_url": "https://api.github.com/users/dzou/orgs",
      "repos_url": "https://api.github.com/users/dzou/repos",
      "events_url": "https://api.github.com/users/dzou/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dzou/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-23T16:21:16Z",
    "updated_at": "2022-02-23T16:21:16Z",
    "author_association": "NONE",
    "body": "Thank you for the thoughtful response! This is a great help and clarifies a lot for us.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1048960215/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1124642443",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/24457#issuecomment-1124642443",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24457",
    "id": 1124642443,
    "node_id": "IC_kwDOAOvK985DCK6L",
    "user": {
      "login": "2thecoin",
      "id": 92323971,
      "node_id": "U_kgDOBYDAgw",
      "avatar_url": "https://avatars.githubusercontent.com/u/92323971?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/2thecoin",
      "html_url": "https://github.com/2thecoin",
      "followers_url": "https://api.github.com/users/2thecoin/followers",
      "following_url": "https://api.github.com/users/2thecoin/following{/other_user}",
      "gists_url": "https://api.github.com/users/2thecoin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/2thecoin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/2thecoin/subscriptions",
      "organizations_url": "https://api.github.com/users/2thecoin/orgs",
      "repos_url": "https://api.github.com/users/2thecoin/repos",
      "events_url": "https://api.github.com/users/2thecoin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/2thecoin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-12T07:43:07Z",
    "updated_at": "2022-05-12T07:43:07Z",
    "author_association": "NONE",
    "body": "Your post helped me too, thanks.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1124642443/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1216448738",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/24457#issuecomment-1216448738",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24457",
    "id": 1216448738,
    "node_id": "IC_kwDOAOvK985IgYji",
    "user": {
      "login": "shiziwen",
      "id": 1405245,
      "node_id": "MDQ6VXNlcjE0MDUyNDU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1405245?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shiziwen",
      "html_url": "https://github.com/shiziwen",
      "followers_url": "https://api.github.com/users/shiziwen/followers",
      "following_url": "https://api.github.com/users/shiziwen/following{/other_user}",
      "gists_url": "https://api.github.com/users/shiziwen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shiziwen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shiziwen/subscriptions",
      "organizations_url": "https://api.github.com/users/shiziwen/orgs",
      "repos_url": "https://api.github.com/users/shiziwen/repos",
      "events_url": "https://api.github.com/users/shiziwen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shiziwen/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-16T10:22:44Z",
    "updated_at": "2022-08-16T10:22:44Z",
    "author_association": "NONE",
    "body": "@holiman Hi, if I run geth with snap sync and it has synced to the latest block. Then, I stopped the node and make the node as image which I can load to other machines to accelerate the sync speed. I may cost almost one day.\r\n\r\nWhen I restart the node, can it still use snap sync mode?\r\n\r\n\r\n ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1216448738/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1216450983",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/24457#issuecomment-1216450983",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24457",
    "id": 1216450983,
    "node_id": "IC_kwDOAOvK985IgZGn",
    "user": {
      "login": "shiziwen",
      "id": 1405245,
      "node_id": "MDQ6VXNlcjE0MDUyNDU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1405245?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shiziwen",
      "html_url": "https://github.com/shiziwen",
      "followers_url": "https://api.github.com/users/shiziwen/followers",
      "following_url": "https://api.github.com/users/shiziwen/following{/other_user}",
      "gists_url": "https://api.github.com/users/shiziwen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shiziwen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shiziwen/subscriptions",
      "organizations_url": "https://api.github.com/users/shiziwen/orgs",
      "repos_url": "https://api.github.com/users/shiziwen/repos",
      "events_url": "https://api.github.com/users/shiziwen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shiziwen/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-16T10:25:06Z",
    "updated_at": "2022-08-16T10:25:06Z",
    "author_association": "NONE",
    "body": "@holiman I have met an issue.\r\nI run geth node as full syncmode, and stopped the node, make it as image and load to other machine, start it.\r\nThe geth node sync very very slow. It differs from the latest block by 10,000. I'm afraid it can't sync to the latest block. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1216450983/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
