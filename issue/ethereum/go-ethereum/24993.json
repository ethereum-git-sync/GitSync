{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24993",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24993/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24993/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24993/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/24993",
  "id": 1252337501,
  "node_id": "I_kwDOAOvK985KpSdd",
  "number": 24993,
  "title": "I got \"Head state missing, repairing\" and the node does sync blocks any more",
  "user": {
    "login": "shiziwen",
    "id": 1405245,
    "node_id": "MDQ6VXNlcjE0MDUyNDU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1405245?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/shiziwen",
    "html_url": "https://github.com/shiziwen",
    "followers_url": "https://api.github.com/users/shiziwen/followers",
    "following_url": "https://api.github.com/users/shiziwen/following{/other_user}",
    "gists_url": "https://api.github.com/users/shiziwen/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/shiziwen/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/shiziwen/subscriptions",
    "organizations_url": "https://api.github.com/users/shiziwen/orgs",
    "repos_url": "https://api.github.com/users/shiziwen/repos",
    "events_url": "https://api.github.com/users/shiziwen/events{/privacy}",
    "received_events_url": "https://api.github.com/users/shiziwen/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    },
    {
      "id": 1132754722,
      "node_id": "MDU6TGFiZWwxMTMyNzU0NzIy",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/need:more-information",
      "name": "need:more-information",
      "color": "db6fa3",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-05-30T07:51:40Z",
  "updated_at": "2022-06-23T08:38:43Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hi, when I restart my geth node, I got the warn message and the node does not sync any more. It has been many hours.\r\n```\r\nWARN [05-30|13:04:36.330] Head state missing, repairing            number=14,463,337 hash=4f01d4..959961 snaproot=980390..e6434b\r\n```\r\n\r\nThe whole message after the node start:\r\n```\r\nINFO [05-30|13:04:14.312] Starting Geth on Ethereum mainnet...\r\nINFO [05-30|13:04:14.314] Maximum peer count                       ETH=50 LES=0 total=50\r\nINFO [05-30|13:04:14.314] Smartcard socket not found, disabling    err=\"stat /run/pcscd/pcscd.comm: no such file or directory\"\r\nINFO [05-30|13:04:14.316] Set global gas cap                       cap=50,000,000\r\nINFO [05-30|13:04:14.330] Allocated trie memory caches             clean=307.00MiB dirty=512.00MiB\r\nINFO [05-30|13:04:14.330] Allocated cache and file handles         database=/data/eth_main/geth/chaindata cache=1024.00MiB handles=32767\r\nINFO [05-30|13:04:23.073] Opened ancient database                  database=/data/eth_main/geth/chaindata/ancient readonly=false\r\nINFO [05-30|13:04:23.249] Persisted trie from memory database      nodes=12356 size=1.78MiB time=25.823995ms gcnodes=0 gcsize=0.00B gctime=0s livenodes=1 livesize=0.00B\r\nINFO [05-30|13:04:23.250] Initialised chain configuration          config=\"{ChainID: 1 Homestead: 1150000 DAO: 1920000 DAOSupport: true EIP150: 2463000 EIP155: 2675000 EIP158: 2675000 Byzantium: 4370000 Constantinople: 7280000 Petersburg: 7280000 Istanbul: 9069000, Muir Glacier: 9200000, Berlin: 12244000, London: 12965000, Arrow Glacier: 13773000, MergeFork: <nil>, Terminal TD: <nil>, Engine: ethash}\"\r\nINFO [05-30|13:04:35.570] Disk storage enabled for ethash caches   dir=/data/eth_main/geth/ethash count=3\r\nINFO [05-30|13:04:35.570] Disk storage enabled for ethash DAGs     dir=/home/java-tron/.ethash    count=2\r\nINFO [05-30|13:04:35.574] Initialising Ethereum protocol           network=1 dbversion=8\r\nINFO [05-30|13:04:36.327] Loaded most recent local header          number=14,463,337 hash=4f01d4..959961 td=44,767,534,003,696,042,413,376 age=2mo4d11h\r\nINFO [05-30|13:04:36.327] Loaded most recent local full block      number=14,463,337 hash=4f01d4..959961 td=44,767,534,003,696,042,413,376 age=2mo4d11h\r\nINFO [05-30|13:04:36.327] Loaded most recent local fast block      number=14,463,337 hash=4f01d4..959961 td=44,767,534,003,696,042,413,376 age=2mo4d11h\r\nWARN [05-30|13:04:36.330] Head state missing, repairing            number=14,463,337 hash=4f01d4..959961 snaproot=980390..e6434b\r\n```\r\n\r\n\r\n\r\nWhen I stop the node using `kill pid` , I got the following message:\r\n```\r\nINFO [05-30|11:45:18.054] Got interrupt, shutting down...\r\nINFO [05-30|11:45:18.059] HTTP server stopped                      endpoint=[::]:8545\r\nINFO [05-30|11:45:18.059] IPC endpoint closed                      url=/data/eth_main/geth.ipc\r\nINFO [05-30|11:45:18.747] Downloader queue stats                   receiptTasks=0 blockTasks=33407 itemSize=82.43KiB throttle=3181\r\nWARN [05-30|11:45:18.747] Synchronisation failed, retrying         err=\"content processing canceled (requested)\"\r\nINFO [05-30|11:45:18.749] Ethereum protocol stopped\r\nINFO [05-30|11:45:18.749] Transaction pool stopped\r\nINFO [05-30|11:45:18.749] Waiting background transaction indexer to exit\r\nWARN [05-30|11:45:18.768] Already shutting down, interrupt more to panic. times=9\r\nERROR[05-30|11:45:18.791] Failed to journal state snapshot         err=\"snapshot [0xaae82e4b2b4223051bfa8f75f11434d712e0c1227d6c2bbd395637682fe03833] missing\"\r\nINFO [05-30|11:45:18.792] Writing cached state to disk             block=14,463,337 hash=4f01d4..959961 root=aae82e..e03833\r\nWARN [05-30|11:45:19.292] Already shutting down, interrupt more to panic. times=8\r\nWARN [05-30|11:45:25.001] Already shutting down, interrupt more to panic. times=7\r\nWARN [05-30|11:45:25.815] Already shutting down, interrupt more to panic. times=6\r\nWARN [05-30|11:45:26.867] Already shutting down, interrupt more to panic. times=5\r\nWARN [05-30|11:45:27.410] Already shutting down, interrupt more to panic. times=4\r\nWARN [05-30|11:45:27.929] Already shutting down, interrupt more to panic. times=3\r\nWARN [05-30|11:45:28.428] Already shutting down, interrupt more to panic. times=2\r\nWARN [05-30|11:45:28.883] Already shutting down, interrupt more to panic. times=1\r\nINFO [05-30|11:45:29.346] Looking for peers                        peercount=0 tried=114 static=0\r\npanic: boom\r\n\r\n``` \r\n\r\n\r\n\r\nBefore I restart the node, it also has the `repairing` log, but it just continue minutes and go on.\r\n```\r\nWARN [05-26|17:17:29.280] Head state missing, repairing            number=13,773,036 hash=feb273..d9e13d snaproot=a1e813..4813c0\r\nINFO [05-26|17:20:04.406] Loaded most recent local header          number=13,773,036 hash=feb273..d9e13d td=36,206,751,599,115,524,359,527 age=5mo2w2d\r\nINFO [05-26|17:20:04.406] Loaded most recent local full block      number=13,743,348 hash=17974a..337279 td=35,855,860,751,110,670,126,484 age=5mo3w1d\r\nINFO [05-26|17:20:04.406] Loaded most recent local fast block      number=13,773,036 hash=feb273..d9e13d td=36,206,751,599,115,524,359,527 age=5mo2w2d\r\nWARN [05-26|17:20:04.407] Enabling snapshot recovery               chainhead=13,743,348 diskbase=13,772,860\r\nWARN [05-26|17:20:04.546] Snapshot is not continuous with chain    snaproot=52c356..2fac0d chainroot=a3aecc..32d9d7\r\nINFO [05-26|17:20:04.546] Loaded local transaction journal         transactions=0 dropped=0\r\nINFO [05-26|17:20:04.546] Regenerated local transaction journal    transactions=0 accounts=0\r\nINFO [05-26|17:20:04.550] Gasprice oracle is ignoring threshold set threshold=2\r\nWARN [05-26|17:20:04.553] Unclean shutdown detected                booted=2021-11-14T17:37:46+0800 age=6mo1w5d\r\nINFO [05-26|17:20:04.553] Starting peer-to-peer node               instance=Geth/ddblock/v1.10.9-stable-eae3b194/linux-amd64/go1.17\r\nINFO [05-26|17:20:04.835] New local node record                    seq=1,634,206,267,554 id=e541d3a5d36734f6 ip=127.0.0.1 udp=30303 tcp=30303\r\n\r\n```\r\n\r\n\r\nSo, how can I get the node sync again?\r\nAnd why I got the error?\r\n\r\nThe start command is \r\n```\r\nnohup geth --mainnet --syncmode \"full\"  --datadir /data/eth_main --cache 2048 --identity \"ddblock\"  --http  --http.api eth,net,web3  --http.corsdomain \"*\" --http.port 8545 --port 30303 --http.addr 0.0.0.0  --http.vhosts \"*\" >> eth_main.out 2>&1 &\r\n```\r\n\r\n\r\nI used the geth-linux-amd64-1.10.17-25c9b49f and also tried to update to geth-linux-amd64-1.10.18-de23cf91, but it does not work.\r\n\r\n\r\n\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24993/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24993/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1141603886",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/24993#issuecomment-1141603886",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24993",
    "id": 1141603886,
    "node_id": "IC_kwDOAOvK985EC34u",
    "user": {
      "login": "shiziwen",
      "id": 1405245,
      "node_id": "MDQ6VXNlcjE0MDUyNDU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1405245?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shiziwen",
      "html_url": "https://github.com/shiziwen",
      "followers_url": "https://api.github.com/users/shiziwen/followers",
      "following_url": "https://api.github.com/users/shiziwen/following{/other_user}",
      "gists_url": "https://api.github.com/users/shiziwen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shiziwen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shiziwen/subscriptions",
      "organizations_url": "https://api.github.com/users/shiziwen/orgs",
      "repos_url": "https://api.github.com/users/shiziwen/repos",
      "events_url": "https://api.github.com/users/shiziwen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shiziwen/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-31T02:26:42Z",
    "updated_at": "2022-05-31T02:26:42Z",
    "author_association": "NONE",
    "body": "After about 20 hours, the node sync from number 0.\r\n```\r\nWARN [05-30|11:45:32.608] Head state missing, repairing            number=14,767,004 hash=6371c1..2fb12a sna\r\nproot=1c3393..736d02\r\nINFO [05-31|08:15:42.363] Loaded most recent local header          number=0          hash=d4e567..cb8fa3 td=\r\n17,179,869,184                 age=53y2mo3d\r\nINFO [05-31|08:15:42.363] Loaded most recent local full block      number=0          hash=d4e567..cb8fa3 td=\r\n17,179,869,184                 age=53y2mo3d\r\nINFO [05-31|08:15:42.363] Loaded most recent local fast block      number=0          hash=d4e567..cb8fa3 td=\r\n17,179,869,184                 age=53y2mo3d\r\nWARN [05-31|08:15:42.748] Enabling snapshot recovery               chainhead=0 diskbase=14,771,503\r\nWARN [05-31|08:15:42.969] Snapshot is not continuous with chain    snaproot=60290b..bb096e chainroot=d7f897.\r\n.0f0544\r\nINFO [05-31|08:15:42.977] Loaded local transaction journal         transactions=0 dropped=0\r\nINFO [05-31|08:15:42.978] Regenerated local transaction journal    transactions=0 accounts=0\r\nINFO [05-31|08:15:42.979] Gasprice oracle is ignoring threshold set threshold=2\r\nWARN [05-31|08:15:42.980] Unclean shutdown detected                booted=2021-10-14T18:14:34+0800 age=7mo2w\r\n4d\r\nWARN [05-31|08:15:42.980] Unclean shutdown detected                booted=2022-05-30T11:25:13+0800 age=20h50\r\nm29s\r\nWARN [05-31|08:15:42.980] Unclean shutdown detected                booted=2022-05-30T11:43:15+0800 age=20h32\r\nm27s\r\nINFO [05-31|08:15:42.983] Starting peer-to-peer node               instance=Geth/ddblock/v1.10.17-stable-25c\r\n9b49f/linux-amd64/go1.18\r\nINFO [05-31|08:15:43.173] New local node record                    seq=1,634,206,474,731 id=9bb93ce38e8e2e21\r\n ip=127.0.0.1 udp=30303 tcp=30303\r\nINFO [05-31|08:15:43.174] Started P2P networking                   self=enode://e39a1c7cccece4511de8962277fb\r\n4bbd9fdc55bf8cc75b23521846633d7fc320065e5a4d1bb85fb12073c510c7e6c9e0f84ad988cb3a84063e32f992ca8fa09b@127.0.0\r\n.1:30303\r\nINFO [05-31|08:15:43.176] IPC endpoint opened                      url=/data/eth_main/geth.ipc\r\nINFO [05-31|08:15:43.176] HTTP server started                      endpoint=[::]:8545 auth=false prefix= cor\r\ns=* vhosts=*\r\nINFO [05-31|08:15:47.023] New local node record                    seq=1,634,206,474,732 id=9bb93ce38e8e2e21\r\n ip=47.253.61.22 udp=30303 tcp=30303\r\nINFO [05-31|08:15:54.015] Looking for peers                        peercount=0 tried=12 static=0\r\nINFO [05-31|08:16:04.021] Looking for peers                        peercount=0 tried=24 static=0\r\nINFO [05-31|08:16:14.682] Looking for peers                        peercount=0 tried=29 static=0\r\nINFO [05-31|08:16:24.682] Looking for peers                        peercount=0 tried=38 static=0\r\nINFO [05-31|08:16:24.730] Block synchronisation started\r\nINFO [05-31|08:16:25.166] Downloader queue stats                   receiptTasks=0 blockTasks=189 itemSize=11\r\n1.09B throttle=8192\r\nINFO [05-31|08:16:25.983] Imported new chain segment               blocks=2 txs=0 mgas=0.000 elapsed=817.163\r\nms mgasps=0.000 number=2          hash=b495a1..4698c9 age=6y11mo6d  dirty=4.65KiB\r\nINFO [05-31|08:16:25.986] Indexed transactions                     blocks=3 txs=0 tail=0 elapsed=\"109.398Âµs\"\r\nINFO [05-31|08:16:30.086] Imported new chain segment               blocks=2048 txs=0 mgas=0.000 elapsed=4.08\r\n8s      mgasps=0.000 number=2050       hash=2c83bc..497041 age=6y11mo6d  dirty=485.39KiB\r\nINFO [05-31|08:16:32.645] Imported new chain segment               blocks=2048 txs=0 mgas=0.000 elapsed=2.54\r\n9s      mgasps=0.000 number=4098       hash=3a497e..040fe3 age=6y11mo6d  dirty=576.57KiB\r\nINFO [05-31|08:16:34.710] Imported new chain segment               blocks=2048 txs=0 mgas=0.000 elapsed=2.05\r\n5s      mgasps=0.000 number=6146       hash=1d6dfe..771ede age=6y11mo6d  dirty=593.28KiB\r\n```\r\n\r\n\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1141603886/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1157387150",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/24993#issuecomment-1157387150",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24993",
    "id": 1157387150,
    "node_id": "IC_kwDOAOvK985E_FOO",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-16T08:33:46Z",
    "updated_at": "2022-06-16T08:33:46Z",
    "author_association": "MEMBER",
    "body": "These logs are a bit strange, they are not in order and they seem to be missing Geth runs from in between them. It's extremely hard to see what's wrong when we don't have the full picture of what you've been doing.\r\n\r\nAll in all Geth really hates it if it's killed forcefully, like you did in one of your logs. Such terminations lead to state losses, which are in general recoverable, but if you kill it again during recovery, things just get worse.\r\n\r\nIf you have all the logs, starting from a healthy point going all the way down to the last failure of a rewind to genesis, we might be able to make heads or tails of it, but in the current case we're missing too much information.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1157387150/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
