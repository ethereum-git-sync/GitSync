{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2507",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2507/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2507/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2507/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/2507",
  "id": 152478633,
  "node_id": "MDU6SXNzdWUxNTI0Nzg2MzM=",
  "number": 2507,
  "title": "Client ends up with empty peer list after several hours",
  "user": {
    "login": "pnomarev",
    "id": 9689862,
    "node_id": "MDQ6VXNlcjk2ODk4NjI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9689862?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pnomarev",
    "html_url": "https://github.com/pnomarev",
    "followers_url": "https://api.github.com/users/pnomarev/followers",
    "following_url": "https://api.github.com/users/pnomarev/following{/other_user}",
    "gists_url": "https://api.github.com/users/pnomarev/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pnomarev/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pnomarev/subscriptions",
    "organizations_url": "https://api.github.com/users/pnomarev/orgs",
    "repos_url": "https://api.github.com/users/pnomarev/repos",
    "events_url": "https://api.github.com/users/pnomarev/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pnomarev/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 164892077,
      "node_id": "MDU6TGFiZWwxNjQ4OTIwNzc=",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/area:network",
      "name": "area:network",
      "color": "207de5",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/milestones/29",
    "html_url": "https://github.com/ethereum/go-ethereum/milestone/29",
    "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/milestones/29/labels",
    "id": 1721558,
    "node_id": "MDk6TWlsZXN0b25lMTcyMTU1OA==",
    "number": 29,
    "title": "1.4.1",
    "description": "",
    "creator": {
      "login": "fjl",
      "id": 6915,
      "node_id": "MDQ6VXNlcjY5MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjl",
      "html_url": "https://github.com/fjl",
      "followers_url": "https://api.github.com/users/fjl/followers",
      "following_url": "https://api.github.com/users/fjl/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
      "organizations_url": "https://api.github.com/users/fjl/orgs",
      "repos_url": "https://api.github.com/users/fjl/repos",
      "events_url": "https://api.github.com/users/fjl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjl/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 16,
    "state": "closed",
    "created_at": "2016-04-20T21:44:45Z",
    "updated_at": "2016-05-10T10:44:27Z",
    "due_on": null,
    "closed_at": "2016-05-10T10:44:27Z"
  },
  "comments": 3,
  "created_at": "2016-05-02T04:08:50Z",
  "updated_at": "2016-05-10T09:57:45Z",
  "closed_at": "2016-05-10T09:57:40Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\n\nGeth version: 1.3.6\nOS & Version: Windows\n#### Expected behaviour\n\nMaintain peers list\n#### Actual behaviour\n\nAt some point stops peer discovery(most likely to happen during full sync, less likely when the node is fully synchronized)\nIn the main server cycle, when `newTasks` decided to perform discoveryTask, this task may not make it to the scheduled tasks(if active tasks count >= maxActiveDialTasks). As a result, `newTasks` still thinks that discoveryTask was initiated, and the whole discovery process stops until client's restart.\n\np2p/server.go:\n\n```\n    scheduleTasks := func(new []task) {\n    pt := append(pendingTasks, new...)\n    start := maxActiveDialTasks - len(tasks)\n    if len(pt) < start {\n        start = len(pt)\n    }\n    if start > 0 {\n        ...\n    } \n            //// This part is missing\n            else {\n        pendingTasks = append(pendingTasks, new...)\n    }\n            //////////////////////////////////////\n}\n```\n",
  "closed_by": {
    "login": "obscuren",
    "id": 6264126,
    "node_id": "MDQ6VXNlcjYyNjQxMjY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6264126?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/obscuren",
    "html_url": "https://github.com/obscuren",
    "followers_url": "https://api.github.com/users/obscuren/followers",
    "following_url": "https://api.github.com/users/obscuren/following{/other_user}",
    "gists_url": "https://api.github.com/users/obscuren/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/obscuren/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/obscuren/subscriptions",
    "organizations_url": "https://api.github.com/users/obscuren/orgs",
    "repos_url": "https://api.github.com/users/obscuren/repos",
    "events_url": "https://api.github.com/users/obscuren/events{/privacy}",
    "received_events_url": "https://api.github.com/users/obscuren/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2507/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2507/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/216140095",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2507#issuecomment-216140095",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2507",
    "id": 216140095,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIxNjE0MDA5NQ==",
    "user": {
      "login": "fjl",
      "id": 6915,
      "node_id": "MDQ6VXNlcjY5MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjl",
      "html_url": "https://github.com/fjl",
      "followers_url": "https://api.github.com/users/fjl/followers",
      "following_url": "https://api.github.com/users/fjl/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
      "organizations_url": "https://api.github.com/users/fjl/orgs",
      "repos_url": "https://api.github.com/users/fjl/repos",
      "events_url": "https://api.github.com/users/fjl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjl/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-02T08:30:20Z",
    "updated_at": "2016-05-02T08:30:20Z",
    "author_association": "MEMBER",
    "body": "looking\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/216140095/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/216277892",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2507#issuecomment-216277892",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2507",
    "id": 216277892,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIxNjI3Nzg5Mg==",
    "user": {
      "login": "fjl",
      "id": 6915,
      "node_id": "MDQ6VXNlcjY5MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjl",
      "html_url": "https://github.com/fjl",
      "followers_url": "https://api.github.com/users/fjl/followers",
      "following_url": "https://api.github.com/users/fjl/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
      "organizations_url": "https://api.github.com/users/fjl/orgs",
      "repos_url": "https://api.github.com/users/fjl/repos",
      "events_url": "https://api.github.com/users/fjl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjl/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-02T16:05:05Z",
    "updated_at": "2016-05-02T16:55:40Z",
    "author_association": "MEMBER",
    "body": "I looked and don't see the bug, at least not in the place that you highlighted.\n[This commit](https://github.com/ethereum/go-ethereum/pull/2510/commits/32bb280179a44b9ad1058766bf61cdbacea30a59) (from the PR linked above) improves the code a bit so the slice handling is easier to read.\n\nBut you probably submitted this issue because it didn't work for you. Can you please describe what is\nhappening and maybe provide log output? The other issue fixed by the PR (#2401) can be a cause for the problem that you mentioned (discovery not finding any more nodes).\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/216277892/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/216417337",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2507#issuecomment-216417337",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2507",
    "id": 216417337,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIxNjQxNzMzNw==",
    "user": {
      "login": "pnomarev",
      "id": 9689862,
      "node_id": "MDQ6VXNlcjk2ODk4NjI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9689862?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pnomarev",
      "html_url": "https://github.com/pnomarev",
      "followers_url": "https://api.github.com/users/pnomarev/followers",
      "following_url": "https://api.github.com/users/pnomarev/following{/other_user}",
      "gists_url": "https://api.github.com/users/pnomarev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pnomarev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pnomarev/subscriptions",
      "organizations_url": "https://api.github.com/users/pnomarev/orgs",
      "repos_url": "https://api.github.com/users/pnomarev/repos",
      "events_url": "https://api.github.com/users/pnomarev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pnomarev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-03T02:08:50Z",
    "updated_at": "2016-05-03T02:08:50Z",
    "author_association": "NONE",
    "body": "Looks like your mentioned commit solves the problem I described, although I haven't tested it yet.\nThe problem can be reproduced by simply running the client behind the firewall and thus preventing incoming connections on port 30303. This would prevent other peers to connect to you.\nNow, once your client have \"discoverTask\" appearing in the scheduled tasks, your client will continuously discover new peers and connect to them.\nBut, once this discoverTask is dropped due to mentioned bug(didn't make it to the queue), your client stops getting new peers and looses all of them after some time.\n\nOverall, to reproduce the issue - simply start fresh geth client without any local database with your 30303 port closed for incoming connections ( probably the majority of peers ).\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/216417337/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
