{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25257",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25257/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25257/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25257/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/25257",
  "id": 1296009460,
  "node_id": "I_kwDOAOvK985NP4j0",
  "number": 25257,
  "title": "Gracefully stopping Geth but it hangs on net/http.Shutdown()",
  "user": {
    "login": "cifer76",
    "id": 4777457,
    "node_id": "MDQ6VXNlcjQ3Nzc0NTc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4777457?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cifer76",
    "html_url": "https://github.com/cifer76",
    "followers_url": "https://api.github.com/users/cifer76/followers",
    "following_url": "https://api.github.com/users/cifer76/following{/other_user}",
    "gists_url": "https://api.github.com/users/cifer76/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cifer76/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cifer76/subscriptions",
    "organizations_url": "https://api.github.com/users/cifer76/orgs",
    "repos_url": "https://api.github.com/users/cifer76/repos",
    "events_url": "https://api.github.com/users/cifer76/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cifer76/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-07-06T15:31:10Z",
  "updated_at": "2022-07-12T15:29:25Z",
  "closed_at": "2022-07-12T15:29:17Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### System information\r\n\r\nGeth\r\nVersion: 1.10.19\r\nArchitecture: amd64\r\nGo Version: go1.18.3\r\nOperating System: linux\r\n\r\n#### Expected behaviour\r\n\r\nBy typing `Ctrl - c` or `kill -SIGINT` or `systemctl stop`, geth should be stopped gracefully with all components properly take themselves.\r\n\r\nThe log output should looks like:\r\n\r\n```\r\nt=2022-07-06T03:00:42+0000 lvl=info msg=\"Got interrupt, shutting down...\"\r\nt=2022-07-06T03:00:42+0000 lvl=info msg=\"HTTP server stopped\"                    endpoint=[::]:8545\r\nt=2022-07-06T03:00:42+0000 lvl=info msg=\"HTTP server stopped\"                    endpoint=[::]:8546\r\nt=2022-07-06T03:00:42+0000 lvl=info msg=\"IPC endpoint closed\"                    url=/eth/geth/state/geth.ipc\r\nt=2022-07-06T03:00:42+0000 lvl=info msg=\"Ethereum protocol stopped\"\r\nt=2022-07-06T03:00:42+0000 lvl=info msg=\"Transaction pool stopped\"\r\nt=2022-07-06T03:00:42+0000 lvl=info msg=\"Writing cached state to disk\"           block=15,086,437 \r\n```\r\n\r\n#### Actual behaviour\r\n\r\nWhile actually, it looks like geth totally ignoring the SIGINT signal and continues syncing blocks from peers. The actually log output is:\r\n\r\n```\r\nt=2022-07-06T00:51:23+0000 lvl=info msg=\"Imported new chain segment\"             blocks=1   txs=29    mgas=2.935   elapsed=43.776ms    mgasps=67.040   number=15,085,853 hash=0xe21a04ec30080765cd9d842b9e9482b689b942167bf9454328d11787c1e55060 dirty=\"1017.41 MiB\"\r\nt=2022-07-06T00:51:23+0000 lvl=info msg=\"Unindexed transactions\"                 blocks=1   txs=130   tail=14,995,854 elapsed=2.285ms\r\n**t=2022-07-06T00:51:26+0000 lvl=info msg=\"Got interrupt, shutting down...\"**\r\nt=2022-07-06T00:52:39+0000 lvl=info msg=\"Imported new chain segment\"             blocks=1   txs=223   mgas=30.029  elapsed=192.792ms   mgasps=155.759  number=15,085,854 hash=0xbba1dad5c937c8e59b163a69b5e781cb651828e3a8b171069d1119e349cd7ed0 age=1m16s    dirty=\"1016.93 MiB\"\r\nt=2022-07-06T00:52:39+0000 lvl=info msg=\"Unindexed transactions\"                 blocks=1   txs=210   tail=14,995,855 elapsed=2.407ms\r\nt=2022-07-06T00:53:05+0000 lvl=info msg=\"Imported new chain segment\"             blocks=1   txs=191   mgas=29.999  elapsed=130.565ms   mgasps=229.762  number=15,085,855 hash=0xd5a58548de09b08d4b9fb65f0f50bd9c09b43c1498f7b1158455a612a238423f dirty=\"1017.55 MiB\"\r\nt=2022-07-06T00:53:05+0000 lvl=info msg=\"Unindexed transactions\"                 blocks=1   txs=45    tail=14,995,856 elapsed=\"802.229µs\"\r\nt=2022-07-06T00:53:08+0000 lvl=info msg=\"Imported new chain segment\"             blocks=1   txs=262   mgas=29.981  elapsed=106.978ms   mgasps=280.253  number=15,085,856 hash=0x150cc74970a7aec6d190dd010e5a5775017b64a78921a561d932be58797210c4 dirty=\"1019.33 MiB\"\r\nt=2022-07-06T00:53:08+0000 lvl=info msg=\"Unindexed transactions\"                 blocks=1   txs=787   tail=14,995,857 elapsed=7.301ms\r\n**t=2022-07-06T00:53:10+0000 lvl=warn msg=\"Already shutting down, interrupt more to panic.\" times=9**\r\nt=2022-07-06T00:53:13+0000 lvl=info msg=\"Imported new chain segment\"             blocks=1   txs=222   mgas=29.990  elapsed=140.488ms   mgasps=213.467  number=15,085,857 hash=0x53a98d5276306b9556aec32c3aca0125304c827e7d2f74898b775d0ce4a326c8 dirty=\"1018.80 MiB\"\r\nt=2022-07-06T00:53:13+0000 lvl=info msg=\"Unindexed transactions\"                 blocks=1   txs=0     tail=14,995,858 elapsed=\"435.13µs\"\r\nt=2022-07-06T00:53:21+0000 lvl=info msg=\"Imported new chain segment\"             blocks=1   txs=43    mgas=4.896   elapsed=58.528ms    mgasps=83.643   number=15,085,858 hash=0x6df5f2794b760822306784c19985c32669c91e368082b1bf7d332f10ab5c4f63 dirty=\"1016.55 MiB\"\r\n```\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nit occurs seldomly, we have not found a fixed pattern to reproduce it yet.\r\n\r\n#### Backtrace\r\n\r\nSeems something's wrong inside the net/http.Shutdown() it never returns so the rpc server cannot stop, rpc server is at the first when the node stops, so other components are not able to stop too.\r\n\r\n````\r\ngoroutine 19333821 [select]:\r\nnet/http.(*Server).Shutdown(0xc014d0c620, {0x17deb68, 0xc000138000})\r\n    net/http/server.go:2775 +0x269\r\ngithub.com/ethereum/go-ethereum/node.(*httpServer).doStop(0xc0002a3040)\r\n    github.com/ethereum/go-ethereum/node/rpcstack.go:264 +0x152\r\ngithub.com/ethereum/go-ethereum/node.(*httpServer).stop(0x1357081a9754b950?)\r\n    github.com/ethereum/go-ethereum/node/rpcstack.go:245 +0x8b\r\ngithub.com/ethereum/go-ethereum/node.(*Node).stopRPC(0xc0002135e0)\r\n    github.com/ethereum/go-ethereum/node/node.go:523 +0x2c\r\ngithub.com/ethereum/go-ethereum/node.(*Node).stopServices(0xc0002135e0, {0xc014d6e690, 0x1, 0x1c69da15893bce9d?})\r\n    github.com/ethereum/go-ethereum/node/node.go:312 +0x32\r\ngithub.com/ethereum/go-ethereum/node.(*Node).Close(0xc0002135e0)\r\n    github.com/ethereum/go-ethereum/node/node.go:237 +0x191\r\ncreated by github.com/ethereum/go-ethereum/cmd/utils.StartNode.func1.1\r\n    github.com/ethereum/go-ethereum/cmd/utils/cmd.go:92 +0x96\r\n\r\n...\r\n\r\ngoroutine 205 [chan receive, 5 minutes]:\r\ngithub.com/ethereum/go-ethereum/cmd/utils.StartNode.func1.1()\r\n    github.com/ethereum/go-ethereum/cmd/utils/cmd.go:94 +0xbb\r\ngithub.com/ethereum/go-ethereum/cmd/utils.StartNode.func1()\r\n    github.com/ethereum/go-ethereum/cmd/utils/cmd.go:115 +0x2f0\r\ncreated by github.com/ethereum/go-ethereum/cmd/utils.StartNode\r\n    github.com/ethereum/go-ethereum/cmd/utils/cmd.go:75 +0xc5\r\n````",
  "closed_by": {
    "login": "ligi",
    "id": 111600,
    "node_id": "MDQ6VXNlcjExMTYwMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/111600?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ligi",
    "html_url": "https://github.com/ligi",
    "followers_url": "https://api.github.com/users/ligi/followers",
    "following_url": "https://api.github.com/users/ligi/following{/other_user}",
    "gists_url": "https://api.github.com/users/ligi/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ligi/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ligi/subscriptions",
    "organizations_url": "https://api.github.com/users/ligi/orgs",
    "repos_url": "https://api.github.com/users/ligi/repos",
    "events_url": "https://api.github.com/users/ligi/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ligi/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25257/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25257/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1176574169",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/25257#issuecomment-1176574169",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25257",
    "id": 1176574169,
    "node_id": "IC_kwDOAOvK985GIRjZ",
    "user": {
      "login": "cifer76",
      "id": 4777457,
      "node_id": "MDQ6VXNlcjQ3Nzc0NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4777457?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cifer76",
      "html_url": "https://github.com/cifer76",
      "followers_url": "https://api.github.com/users/cifer76/followers",
      "following_url": "https://api.github.com/users/cifer76/following{/other_user}",
      "gists_url": "https://api.github.com/users/cifer76/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cifer76/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cifer76/subscriptions",
      "organizations_url": "https://api.github.com/users/cifer76/orgs",
      "repos_url": "https://api.github.com/users/cifer76/repos",
      "events_url": "https://api.github.com/users/cifer76/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cifer76/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-06T19:06:08Z",
    "updated_at": "2022-07-06T19:06:08Z",
    "author_association": "CONTRIBUTOR",
    "body": "have we ever met this issue before?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1176574169/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1176741388",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/25257#issuecomment-1176741388",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25257",
    "id": 1176741388,
    "node_id": "IC_kwDOAOvK985GI6YM",
    "user": {
      "login": "fjl",
      "id": 6915,
      "node_id": "MDQ6VXNlcjY5MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjl",
      "html_url": "https://github.com/fjl",
      "followers_url": "https://api.github.com/users/fjl/followers",
      "following_url": "https://api.github.com/users/fjl/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
      "organizations_url": "https://api.github.com/users/fjl/orgs",
      "repos_url": "https://api.github.com/users/fjl/repos",
      "events_url": "https://api.github.com/users/fjl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjl/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-06T21:00:48Z",
    "updated_at": "2022-07-06T21:00:48Z",
    "author_association": "MEMBER",
    "body": "I have not seen this issue before.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1176741388/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1177769902",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/25257#issuecomment-1177769902",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25257",
    "id": 1177769902,
    "node_id": "IC_kwDOAOvK985GM1eu",
    "user": {
      "login": "meta-bot",
      "id": 13970152,
      "node_id": "MDQ6VXNlcjEzOTcwMTUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/13970152?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/meta-bot",
      "html_url": "https://github.com/meta-bot",
      "followers_url": "https://api.github.com/users/meta-bot/followers",
      "following_url": "https://api.github.com/users/meta-bot/following{/other_user}",
      "gists_url": "https://api.github.com/users/meta-bot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/meta-bot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/meta-bot/subscriptions",
      "organizations_url": "https://api.github.com/users/meta-bot/orgs",
      "repos_url": "https://api.github.com/users/meta-bot/repos",
      "events_url": "https://api.github.com/users/meta-bot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/meta-bot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-07T15:12:29Z",
    "updated_at": "2022-07-07T15:12:29Z",
    "author_association": "NONE",
    "body": "I have faced this issue multiple times. I think one service is not closing.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1177769902/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1181911282",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/25257#issuecomment-1181911282",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25257",
    "id": 1181911282,
    "node_id": "IC_kwDOAOvK985Gcojy",
    "user": {
      "login": "ligi",
      "id": 111600,
      "node_id": "MDQ6VXNlcjExMTYwMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/111600?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ligi",
      "html_url": "https://github.com/ligi",
      "followers_url": "https://api.github.com/users/ligi/followers",
      "following_url": "https://api.github.com/users/ligi/following{/other_user}",
      "gists_url": "https://api.github.com/users/ligi/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ligi/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ligi/subscriptions",
      "organizations_url": "https://api.github.com/users/ligi/orgs",
      "repos_url": "https://api.github.com/users/ligi/repos",
      "events_url": "https://api.github.com/users/ligi/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ligi/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-12T15:29:16Z",
    "updated_at": "2022-07-12T15:29:16Z",
    "author_association": "MEMBER",
    "body": "closed by #25258",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1181911282/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
