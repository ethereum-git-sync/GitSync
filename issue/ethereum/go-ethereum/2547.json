{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2547",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2547/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2547/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2547/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/2547",
  "id": 154182774,
  "node_id": "MDU6SXNzdWUxNTQxODI3NzQ=",
  "number": 2547,
  "title": "debug.traceTransaction running out of memory and crashing (6 GB+)",
  "user": {
    "login": "fairglu",
    "id": 8669120,
    "node_id": "MDQ6VXNlcjg2NjkxMjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8669120?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fairglu",
    "html_url": "https://github.com/fairglu",
    "followers_url": "https://api.github.com/users/fairglu/followers",
    "following_url": "https://api.github.com/users/fairglu/following{/other_user}",
    "gists_url": "https://api.github.com/users/fairglu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fairglu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fairglu/subscriptions",
    "organizations_url": "https://api.github.com/users/fairglu/orgs",
    "repos_url": "https://api.github.com/users/fairglu/repos",
    "events_url": "https://api.github.com/users/fairglu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fairglu/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 856638432,
      "node_id": "MDU6TGFiZWw4NTY2Mzg0MzI=",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/status:inactive",
      "name": "status:inactive",
      "color": "ffffff",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2016-05-11T08:02:02Z",
  "updated_at": "2018-04-16T17:37:38Z",
  "closed_at": "2018-04-16T17:37:38Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\n\nGeth version: 1.5.0\nOS & Version: Linux\n#### Expected behaviour\n\ndebug.traceTransaction should not crash geth, but at least return an error.\n#### Actual behaviour\n\nIt can consume all memory then crash geth\n#### Steps to reproduce the behaviour\n\nin the console run\n\n`debug.traceTransaction('0x9b3d5c27071b5ed45bff4e3c48b97efd790e9455cef4c92748ac5e27f99d59da')`\n\nIt will also crash through the RPC API\n\nNote that for the above transaction, even with storage, memory and stack disabled, execution is extremely slow, I am not even sure it completes (it has been running for almost 30 minutes here... still running).\nAccording to ethercamp, the transaction has 201392 steps.\n",
  "closed_by": {
    "login": "stale[bot]",
    "id": 26384082,
    "node_id": "MDM6Qm90MjYzODQwODI=",
    "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/stale%5Bbot%5D",
    "html_url": "https://github.com/apps/stale",
    "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2547/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2547/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/218409256",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2547#issuecomment-218409256",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2547",
    "id": 218409256,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIxODQwOTI1Ng==",
    "user": {
      "login": "obscuren",
      "id": 6264126,
      "node_id": "MDQ6VXNlcjYyNjQxMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6264126?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/obscuren",
      "html_url": "https://github.com/obscuren",
      "followers_url": "https://api.github.com/users/obscuren/followers",
      "following_url": "https://api.github.com/users/obscuren/following{/other_user}",
      "gists_url": "https://api.github.com/users/obscuren/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/obscuren/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/obscuren/subscriptions",
      "organizations_url": "https://api.github.com/users/obscuren/orgs",
      "repos_url": "https://api.github.com/users/obscuren/repos",
      "events_url": "https://api.github.com/users/obscuren/events{/privacy}",
      "received_events_url": "https://api.github.com/users/obscuren/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-11T09:33:17Z",
    "updated_at": "2016-05-11T09:33:17Z",
    "author_association": "MEMBER",
    "body": "Ouch. This is because of the following issues:\n- JSON marshalling\n- Each trace contains a copy of the data (storage, memory, stack)\n\nWe'll look in to making this more performant. No temporary solution. \n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/218409256/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/218430455",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2547#issuecomment-218430455",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2547",
    "id": 218430455,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIxODQzMDQ1NQ==",
    "user": {
      "login": "fairglu",
      "id": 8669120,
      "node_id": "MDQ6VXNlcjg2NjkxMjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8669120?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fairglu",
      "html_url": "https://github.com/fairglu",
      "followers_url": "https://api.github.com/users/fairglu/followers",
      "following_url": "https://api.github.com/users/fairglu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fairglu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fairglu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fairglu/subscriptions",
      "organizations_url": "https://api.github.com/users/fairglu/orgs",
      "repos_url": "https://api.github.com/users/fairglu/repos",
      "events_url": "https://api.github.com/users/fairglu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fairglu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-11T11:16:36Z",
    "updated_at": "2016-05-11T11:16:36Z",
    "author_association": "NONE",
    "body": "Redid some tests after a full reboot, and when storage/memory/stack are disabled, it manages to complete, though it takes some time.\n\nAdding the stack limit option suggested in https://github.com/ethereum/go-ethereum/issues/2546 would probably help, but may not be enough for transactions with hundreds of tousandths of steps.\n\nAnother approach is detailed in https://github.com/ethereum/go-ethereum/issues/2550, and should allow tackling monster transactions with minimal changes to the API (just extra options, which should just affect logger.go AFAICT)\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/218430455/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/218486846",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2547#issuecomment-218486846",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2547",
    "id": 218486846,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIxODQ4Njg0Ng==",
    "user": {
      "login": "fairglu",
      "id": 8669120,
      "node_id": "MDQ6VXNlcjg2NjkxMjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8669120?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fairglu",
      "html_url": "https://github.com/fairglu",
      "followers_url": "https://api.github.com/users/fairglu/followers",
      "following_url": "https://api.github.com/users/fairglu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fairglu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fairglu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fairglu/subscriptions",
      "organizations_url": "https://api.github.com/users/fairglu/orgs",
      "repos_url": "https://api.github.com/users/fairglu/repos",
      "events_url": "https://api.github.com/users/fairglu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fairglu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-11T15:01:47Z",
    "updated_at": "2016-05-11T15:01:47Z",
    "author_association": "NONE",
    "body": "Another partial solution could be to simply trim the leading zeroes for hex values, depending on transactions this can reduce json size by 30% to 90%.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/218486846/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/218677743",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2547#issuecomment-218677743",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2547",
    "id": 218677743,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIxODY3Nzc0Mw==",
    "user": {
      "login": "fairglu",
      "id": 8669120,
      "node_id": "MDQ6VXNlcjg2NjkxMjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8669120?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fairglu",
      "html_url": "https://github.com/fairglu",
      "followers_url": "https://api.github.com/users/fairglu/followers",
      "following_url": "https://api.github.com/users/fairglu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fairglu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fairglu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fairglu/subscriptions",
      "organizations_url": "https://api.github.com/users/fairglu/orgs",
      "repos_url": "https://api.github.com/users/fairglu/repos",
      "events_url": "https://api.github.com/users/fairglu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fairglu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-12T07:11:17Z",
    "updated_at": "2016-05-12T10:00:53Z",
    "author_association": "NONE",
    "body": "Did some more testing and hacking in logger.go, the automated JSON marshalling incurs a significant penalty. Of note is is the marshalling of empty values (f.i. empty storage when storage is disabled, empty error string), I have commented out the fields of StructLog (in eth/api.go & vl/logger.go, rather than using the disableXxxx options), and it makes the trace much faster, so marshalling of empty fields is definitely not free.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/218677743/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/218719741",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2547#issuecomment-218719741",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2547",
    "id": 218719741,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIxODcxOTc0MQ==",
    "user": {
      "login": "fjl",
      "id": 6915,
      "node_id": "MDQ6VXNlcjY5MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjl",
      "html_url": "https://github.com/fjl",
      "followers_url": "https://api.github.com/users/fjl/followers",
      "following_url": "https://api.github.com/users/fjl/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
      "organizations_url": "https://api.github.com/users/fjl/orgs",
      "repos_url": "https://api.github.com/users/fjl/repos",
      "events_url": "https://api.github.com/users/fjl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjl/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-12T10:31:44Z",
    "updated_at": "2016-05-12T10:31:50Z",
    "author_association": "MEMBER",
    "body": "@fairglu you can also try https://github.com/pquerna/ffjson to make serialising the trace faster. \nWould appreciate a PR if you have improvements ;).\n\nWe could also stream large traces as JSON-RPC notifications, although it will make the client side more complicated.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/218719741/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/218761903",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2547#issuecomment-218761903",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2547",
    "id": 218761903,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIxODc2MTkwMw==",
    "user": {
      "login": "fairglu",
      "id": 8669120,
      "node_id": "MDQ6VXNlcjg2NjkxMjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8669120?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fairglu",
      "html_url": "https://github.com/fairglu",
      "followers_url": "https://api.github.com/users/fairglu/followers",
      "following_url": "https://api.github.com/users/fairglu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fairglu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fairglu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fairglu/subscriptions",
      "organizations_url": "https://api.github.com/users/fairglu/orgs",
      "repos_url": "https://api.github.com/users/fairglu/repos",
      "events_url": "https://api.github.com/users/fairglu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fairglu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-12T13:46:40Z",
    "updated_at": "2016-05-12T13:46:40Z",
    "author_association": "NONE",
    "body": "@fjl my go-fu is limited, so my improvements are merely judiciously placed \"//\" :)\n\nMost of the trouble comes from unnecessary overhead: streaming of empty strings, nulls, empty objects, leading zeroes, very deep stacks. So while faster marshalling could help, removing the overhead helps even more, I have been able to trace the monster txs (almost 500k steps for the larger ones) under 1 GB RAM after commenting out what I did not need, but those were ad-hoc changes.\n\nBetter than JSON-RPC notification would be ways to request just a subset explicitly (cf. https://github.com/ethereum/go-ethereum/issues/2550).\n\nWhen the trace is for human analysis, you can only look at a subset anyway, and the rest can be fetched piecemeal when (and if) needed, provided you have some form of index or summary of the whole trace.\nFor automated analysis (my particular use case), I only look at the trace for some opcodes and depths. So in both cases, having all of the data at once is unnecessary, and the interesting tidbits can be anywhere in the trace.\n\nSo it is probably not as much a streaming problem as it is an \"on demand\" one.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/218761903/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/219645523",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2547#issuecomment-219645523",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2547",
    "id": 219645523,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIxOTY0NTUyMw==",
    "user": {
      "login": "fairglu",
      "id": 8669120,
      "node_id": "MDQ6VXNlcjg2NjkxMjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8669120?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fairglu",
      "html_url": "https://github.com/fairglu",
      "followers_url": "https://api.github.com/users/fairglu/followers",
      "following_url": "https://api.github.com/users/fairglu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fairglu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fairglu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fairglu/subscriptions",
      "organizations_url": "https://api.github.com/users/fairglu/orgs",
      "repos_url": "https://api.github.com/users/fairglu/repos",
      "events_url": "https://api.github.com/users/fairglu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fairglu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-17T07:55:52Z",
    "updated_at": "2016-05-17T07:55:52Z",
    "author_association": "NONE",
    "body": "In case someone else faces the same problem, for the stack log, the simplest \"fix\" is to change in eth/api.go, formatLogs function, from\n\n`formattedStructLogs[index].Stack[i] = fmt.Sprintf(\"%x\", common.LeftPadBytes(stackValue.Bytes(), 32))`\n\nto \n\n`formattedStructLogs[index].Stack[i] = fmt.Sprintf(\"%x\", stackValue.Bytes())`\n\nthis removes the zero padding in the json for the stack values, which is easy to add back on the client side if you need it, and can drastically helps with json size without losing data.\n\nAnother more minor but still effective change is to concatenante the Op and Error fields, which allows removing the (typically empty) Error field from the json, untangling the concatenation is simple to handle client-side.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/219645523/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/370482573",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2547#issuecomment-370482573",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2547",
    "id": 370482573,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3MDQ4MjU3Mw==",
    "user": {
      "login": "stale[bot]",
      "id": 26384082,
      "node_id": "MDM6Qm90MjYzODQwODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stale%5Bbot%5D",
      "html_url": "https://github.com/apps/stale",
      "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2018-03-05T16:44:29Z",
    "updated_at": "2018-03-05T16:44:29Z",
    "author_association": "NONE",
    "body": "This issue has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs. Thank you for your contributions.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/370482573/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
