{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19375",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19375/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19375/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19375/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/19375",
  "id": 428269901,
  "node_id": "MDU6SXNzdWU0MjgyNjk5MDE=",
  "number": 19375,
  "title": "Possible memory leak when \"traceChain\"",
  "user": {
    "login": "felberj",
    "id": 6639926,
    "node_id": "MDQ6VXNlcjY2Mzk5MjY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6639926?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/felberj",
    "html_url": "https://github.com/felberj",
    "followers_url": "https://api.github.com/users/felberj/followers",
    "following_url": "https://api.github.com/users/felberj/following{/other_user}",
    "gists_url": "https://api.github.com/users/felberj/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/felberj/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/felberj/subscriptions",
    "organizations_url": "https://api.github.com/users/felberj/orgs",
    "repos_url": "https://api.github.com/users/felberj/repos",
    "events_url": "https://api.github.com/users/felberj/events{/privacy}",
    "received_events_url": "https://api.github.com/users/felberj/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 202012689,
      "node_id": "MDU6TGFiZWwyMDIwMTI2ODk=",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/area:core",
      "name": "area:core",
      "color": "fbca04",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2019-04-02T14:43:14Z",
  "updated_at": "2020-08-27T09:10:42Z",
  "closed_at": "2020-06-25T08:43:53Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: v1.8.21)\r\nOS & Version: OSX\r\nCommit hash : 9dc5d1a915ac0e0bd8429d6ac41df50eec91de5f *WITH* dba336e6121578c001fde7f17c28454d1c1867bf cherry-picked\r\n\r\n#### Expected behaviour\r\n\r\nMemory goes down when \"traceChain\" finishes.\r\n\r\n#### Actual behaviour\r\n\r\nIf I trace the chain, the memory steadily increases (and never decreases after stopping the \"traceChain\" RPC.\r\n\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nHave a blockchain synced in \"full\"+\"archive\" mode until block 2331366 or so.\r\n\r\n`git checkout v1.8.21 `\r\n`git cherry-pick dba336e6121578c001fde7f17c28454d1c1867bf`\r\n`go build ./cmd/geth`\r\n`./geth --mine=false --datadir=$YOUR_DATA_DIR --syncmode=full --gcmode=archive --maxpeers 0 console`\r\n\r\nanother terminal:\r\n\r\n`nc -U /Volumes/ethereum/geth.ipc`\r\n\r\nThen paste\r\n```\r\n{\"id\": 1, \"method\": \"debug_subscribe\", \"params\": [\"traceChain\", \"0x1e8480\", \"0x22132a\", {\"tracer\": \"{\\r\\narguments: [],\\r\\nstep: function(log, db) {if (false) {\\r\\n this.arguments.push({x: log.stack.peek(1).toString(16), y: log.stack.peek(2).toString(16)})\\r\\n}\\r\\n},\\r\\nresult: function(){ return this.arguments;}, \\r\\nfault: function(){}\\r\\n}\\r\\n\", \"reexec\":0}]}\r\n```\r\n\r\nAnd let it run for a while. The memory increases steadily.\r\nYou can close the \"nc\" socket and the memory will stay the same.\r\n\r\n\r\n#### Backtrace\r\n\r\nNot sure whether this helps:\r\n\r\n[heap.txt](https://github.com/ethereum/go-ethereum/files/3034418/heap.txt)\r\n\r\nI took a heap snapshot after running the query for a short time (2 min).\r\n\r\nI assume it has something to do with this: https://github.com/ethereum/go-ethereum/blob/master/eth/api_tracer.go#L298-L316\r\n\r\nUnfortunately, I do not know what this  \"Reset\", \"Commit\" is doing (and I am also not sure why we need to refrence and dereference).\r\n\r\nAlso,  does `// TODO(karalabe): Do we need the preimages? Won't they accumulate too much?` has something to do with it?\r\n\r\nI am happy to help and to fix this if you can point me to the right places and answer the questions above. I am especially curious about @karalabe 's TODO.",
  "closed_by": {
    "login": "karalabe",
    "id": 129561,
    "node_id": "MDQ6VXNlcjEyOTU2MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/karalabe",
    "html_url": "https://github.com/karalabe",
    "followers_url": "https://api.github.com/users/karalabe/followers",
    "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
    "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
    "organizations_url": "https://api.github.com/users/karalabe/orgs",
    "repos_url": "https://api.github.com/users/karalabe/repos",
    "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
    "received_events_url": "https://api.github.com/users/karalabe/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19375/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19375/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/500756938",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19375#issuecomment-500756938",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19375",
    "id": 500756938,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDc1NjkzOA==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-11T09:10:59Z",
    "updated_at": "2019-06-11T09:10:59Z",
    "author_association": "MEMBER",
    "body": "Go's GC releases memory only after it has't been used for quite a few minutes (5 I think). Does it go down after 5-10 minutes, or doe it stay high?\r\n\r\nAlso, starting with Go 1.12, on Linux Go uses memory **hints** to tell the OS that it **can** take some memory back, but it will only take it back if needed, otherwise the memory bloat will stay in there.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/500756938/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/500758503",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19375#issuecomment-500758503",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19375",
    "id": 500758503,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDc1ODUwMw==",
    "user": {
      "login": "felberj",
      "id": 6639926,
      "node_id": "MDQ6VXNlcjY2Mzk5MjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6639926?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/felberj",
      "html_url": "https://github.com/felberj",
      "followers_url": "https://api.github.com/users/felberj/followers",
      "following_url": "https://api.github.com/users/felberj/following{/other_user}",
      "gists_url": "https://api.github.com/users/felberj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/felberj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/felberj/subscriptions",
      "organizations_url": "https://api.github.com/users/felberj/orgs",
      "repos_url": "https://api.github.com/users/felberj/repos",
      "events_url": "https://api.github.com/users/felberj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/felberj/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-11T09:15:20Z",
    "updated_at": "2019-06-11T09:15:20Z",
    "author_association": "CONTRIBUTOR",
    "body": "IIRC it stood high. I \"solved\" this problem by tracing 10'000 blocks at the time and then the next 10'000.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/500758503/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/643175530",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19375#issuecomment-643175530",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19375",
    "id": 643175530,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0MzE3NTUzMA==",
    "user": {
      "login": "stale[bot]",
      "id": 26384082,
      "node_id": "MDM6Qm90MjYzODQwODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stale%5Bbot%5D",
      "html_url": "https://github.com/apps/stale",
      "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2020-06-12T09:31:33Z",
    "updated_at": "2020-06-12T09:31:33Z",
    "author_association": "NONE",
    "body": "This issue has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs. Thank you for your contributions.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/643175530/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/649383252",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19375#issuecomment-649383252",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19375",
    "id": 649383252,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0OTM4MzI1Mg==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-25T08:43:53Z",
    "updated_at": "2020-06-25T08:43:53Z",
    "author_association": "MEMBER",
    "body": "Chain tracing subscription is mostly meant for full nodes where the state is not available. Internally it starts at the given starting block and keeps generating and keeping the new state in memory as it is progressing. It will not check if the disk is available on disk. This means that if you run very long traces, eventually memory use will pile up quite a bit.\r\n\r\nSince you have an archive node, you don't need to actually keep everything in memory, that's why it actually worked with 10K chunks. For archive nodes it might make sense to trace blocks individually, not via chain tracing subscriptions.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/649383252/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
