{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20067",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20067/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20067/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20067/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/20067",
  "id": 492962516,
  "node_id": "MDU6SXNzdWU0OTI5NjI1MTY=",
  "number": 20067,
  "title": "Fatal: Error starting protocol stack: missing block number for head header hash",
  "user": {
    "login": "CamposBruno",
    "id": 5519109,
    "node_id": "MDQ6VXNlcjU1MTkxMDk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5519109?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/CamposBruno",
    "html_url": "https://github.com/CamposBruno",
    "followers_url": "https://api.github.com/users/CamposBruno/followers",
    "following_url": "https://api.github.com/users/CamposBruno/following{/other_user}",
    "gists_url": "https://api.github.com/users/CamposBruno/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/CamposBruno/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/CamposBruno/subscriptions",
    "organizations_url": "https://api.github.com/users/CamposBruno/orgs",
    "repos_url": "https://api.github.com/users/CamposBruno/repos",
    "events_url": "https://api.github.com/users/CamposBruno/events{/privacy}",
    "received_events_url": "https://api.github.com/users/CamposBruno/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2019-09-12T18:31:12Z",
  "updated_at": "2019-09-13T22:44:33Z",
  "closed_at": "2019-09-13T21:28:23Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hi there!\r\n\r\nI got this error right before the Geth almost full sync:\r\n````\r\nFatal: Error starting protocol stack: missing block number for head header hash\r\n````\r\nI'm using a EC2 only for the Ethereum node, nothing else is running on this vm.\r\nMy EC2 is a t2.Xlarge with 16GB RAM and 8 Cores\r\nMy storage is 800GB EBS with 2400 IOPS\r\n\r\n\r\nIs there a way to fix this ? or revert some of the blocks and continue with sync ?\r\nDon't want to start syncing from the start again.\r\n\r\n#### System information\r\n\r\nGeth version: `1.9.3-stable`\r\nGo : go1.12.9.linux.amd64\r\nOS & Version: CentOS Linux\r\n\r\n#### Expected behaviour\r\n\r\nGeth to sincronize \r\n\r\n#### Actual behaviour\r\n\r\nI get this error when almost finishing full sync:\r\n\r\n````\r\nFatal: Error starting protocol stack: missing block number for head header hash\r\n````\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nI ran Geth with the following parameters :\r\n\r\n````\r\ngeth --datadir ~/NODES/ethmainnet --identity GMCNODE --rpc --rpccorsdomain \"*\" --rpcaddr \"0.0.0.0\" --rpcport \"8545\" --syncmode \"full\" --nousb  --cache=512\r\n````\r\n\r\n#### Backtrace\r\n\r\n````\r\nINFO [09-11|03:45:53.635] Imported new block headers               count=1    elapsed=5.737ms      number=8526160 hash=895afb…3fe6e3\r\nINFO [09-11|03:45:54.777] Imported new state entries               count=1152 elapsed=7.497ms      processed=136478888 pending=15668 retry=0    duplicate=11455 unexpected=194705\r\nINFO [09-11|03:45:55.473] Imported new state entries               count=1152 elapsed=5.237ms      processed=136480040 pending=16892 retry=0    duplicate=11455 unexpected=194705\r\n2019/09/11 03:45:55 http: Accept error: accept tcp [::]:8545: accept4: too many open files; retrying in 5ms\r\n2019/09/11 03:45:55 http: Accept error: accept tcp [::]:8545: accept4: too many open files; retrying in 10ms\r\n2019/09/11 03:45:55 http: Accept error: accept tcp [::]:8545: accept4: too many open files; retrying in 20ms\r\n2019/09/11 03:45:55 http: Accept error: accept tcp [::]:8545: accept4: too many open files; retrying in 5ms\r\n2019/09/11 03:45:55 http: Accept error: accept tcp [::]:8545: accept4: too many open files; retrying in 10ms\r\n2019/09/11 03:45:55 http: Accept error: accept tcp [::]:8545: accept4: too many open files; retrying in 20ms\r\n2019/09/11 03:45:56 http: Accept error: accept tcp [::]:8545: accept4: too many open files; retrying in 40ms\r\n2019/09/11 03:45:56 http: Accept error: accept tcp [::]:8545: accept4: too many open files; retrying in 80ms\r\n2019/09/11 03:45:56 http: Accept error: accept tcp [::]:8545: accept4: too many open files; retrying in 160ms\r\n2019/09/11 03:45:56 http: Accept error: accept tcp [::]:8545: accept4: too many open files; retrying in 320ms\r\n2019/09/11 03:45:56 http: Accept error: accept tcp [::]:8545: accept4: too many open files; retrying in 640ms\r\npanic: runtime error: invalid memory address or nil pointer dereference\r\n[signal SIGSEGV: segmentation violation code=0x1 addr=0x1b8 pc=0x84d1a41]\r\n\r\ngoroutine 479884 [running]:\r\ngithub.com/ethereum/go-ethereum/core.(*HeaderChain).SetCurrentHeader(0xaffbc20, 0x0)\r\n\t/home/travis/gopath/src/github.com/ethereum/go-ethereum/core/headerchain.go:460 +0xf1\r\ngithub.com/ethereum/go-ethereum/core.(*BlockChain).Rollback(0x105a0000, 0x3774e000, 0x800, 0x800)\r\n\t/home/travis/gopath/src/github.com/ethereum/go-ethereum/core/blockchain.go:881 +0x24b\r\ngithub.com/ethereum/go-ethereum/eth/downloader.(*Downloader).processHeaders.func1(0x261b7ec8, 0x106bc000)\r\n\t/home/travis/gopath/src/github.com/ethereum/go-ethereum/eth/downloader/downloader.go:1374 +0x189\r\ngithub.com/ethereum/go-ethereum/eth/downloader.(*Downloader).processHeaders(0x106bc000, 0x821951, 0x0, 0x821843, 0x0, 0x4e7944a0, 0x8e2b7d0, 0xae58440)\r\n\t/home/travis/gopath/src/github.com/ethereum/go-ethereum/eth/downloader/downloader.go:1393 +0x1179\r\ngithub.com/ethereum/go-ethereum/eth/downloader.(*Downloader).syncWithPeer.func6(0x4, 0x8c40924)\r\n\t/home/travis/gopath/src/github.com/ethereum/go-ethereum/eth/downloader/downloader.go:517 +0x49\r\ngithub.com/ethereum/go-ethereum/eth/downloader.(*Downloader).spawnSync.func1(0x106bc000, 0x4cb0d980, 0x5b7f9620)\r\n\t/home/travis/gopath/src/github.com/ethereum/go-ethereum/eth/downloader/downloader.go:534 +0x46\r\ncreated by github.com/ethereum/go-ethereum/eth/downloader.(*Downloader).spawnSync\r\n\t/home/travis/gopath/src/github.com/ethereum/go-ethereum/eth/downloader/downloader.go:534 +0x8c\r\nINFO [09-11|03:51:27.022] Maximum peer count                       ETH=50 LES=0 total=50\r\nINFO [09-11|03:51:27.023] Smartcard socket not found, disabling    err=\"stat /run/pcscd/pcscd.comm: no such file or directory\"\r\nINFO [09-11|03:51:27.025] Starting peer-to-peer node               instance=Geth/GMCNODE/v1.9.3-stable-cfbb969d/linux-386/go1.12.9\r\nINFO [09-11|03:51:27.025] Allocated trie memory caches             clean=128.00MiB dirty=128.00MiB\r\nINFO [09-11|03:51:27.025] Allocated cache and file handles         database=/home/centos/NODES/ethmainnet/geth/chaindata cache=256.00MiB handles=2048\r\nINFO [09-11|03:51:29.848] Opened ancient database                  database=/home/centos/NODES/ethmainnet/geth/chaindata/ancient\r\nFatal: Error starting protocol stack: missing block number for head header hash\r\n\r\n````",
  "closed_by": {
    "login": "CamposBruno",
    "id": 5519109,
    "node_id": "MDQ6VXNlcjU1MTkxMDk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5519109?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/CamposBruno",
    "html_url": "https://github.com/CamposBruno",
    "followers_url": "https://api.github.com/users/CamposBruno/followers",
    "following_url": "https://api.github.com/users/CamposBruno/following{/other_user}",
    "gists_url": "https://api.github.com/users/CamposBruno/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/CamposBruno/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/CamposBruno/subscriptions",
    "organizations_url": "https://api.github.com/users/CamposBruno/orgs",
    "repos_url": "https://api.github.com/users/CamposBruno/repos",
    "events_url": "https://api.github.com/users/CamposBruno/events{/privacy}",
    "received_events_url": "https://api.github.com/users/CamposBruno/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20067/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20067/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/531121591",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20067#issuecomment-531121591",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20067",
    "id": 531121591,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMTEyMTU5MQ==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-09-13T06:53:54Z",
    "updated_at": "2019-09-13T06:53:54Z",
    "author_association": "MEMBER",
    "body": "First up, why did you limit Geth to 512MB cache (default if you don't specify anything is 4GB for mainnet), if you have such a powerful machine?\r\n\r\nSecondly, my hunch is that your system ran out of file descriptors, so leveldb failed to write something to disk. The reason seems to be that someone/thing is hammering your node via the RPC (please never open the RPC for the public internet).\r\n\r\nThere's no simple way to recover, but one thing you can do to not download all the data again is to delete all the files from your `chaindata` folder **except (!!!)** the `ancient` folder. That way only the state needs to be downloaded again. Still, please bump the cache (or not set it at all), otherwise sync is significantly slower than it could be.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/531121591/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/531250618",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20067#issuecomment-531250618",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20067",
    "id": 531250618,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMTI1MDYxOA==",
    "user": {
      "login": "CamposBruno",
      "id": 5519109,
      "node_id": "MDQ6VXNlcjU1MTkxMDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5519109?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/CamposBruno",
      "html_url": "https://github.com/CamposBruno",
      "followers_url": "https://api.github.com/users/CamposBruno/followers",
      "following_url": "https://api.github.com/users/CamposBruno/following{/other_user}",
      "gists_url": "https://api.github.com/users/CamposBruno/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/CamposBruno/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/CamposBruno/subscriptions",
      "organizations_url": "https://api.github.com/users/CamposBruno/orgs",
      "repos_url": "https://api.github.com/users/CamposBruno/repos",
      "events_url": "https://api.github.com/users/CamposBruno/events{/privacy}",
      "received_events_url": "https://api.github.com/users/CamposBruno/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-09-13T14:06:00Z",
    "updated_at": "2019-09-13T14:06:00Z",
    "author_association": "NONE",
    "body": "Hey @karalabe thanks for the hint, I will erase the chain data folder except te ancient, and try to sync again.\r\n\r\nAs for the 512MB cache, it was the only config that did the trick, if I did not set it, or set it 1024MB or other value, I get the error \r\n````\r\nruntime: out of memory: cannot allocate 3465216-byte block (3685285888 in use)\r\nfatal error: out of memory\r\n````",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/531250618/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/531380894",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20067#issuecomment-531380894",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20067",
    "id": 531380894,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMTM4MDg5NA==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-09-13T20:30:35Z",
    "updated_at": "2019-09-13T20:30:35Z",
    "author_association": "MEMBER",
    "body": "Wait, are you using a 32 bit build? Please use a 64bit binary.\n\nOn Fri, Sep 13, 2019, 17:06 Bruno Campos <notifications@github.com> wrote:\n\n> Hey @karalabe <https://github.com/karalabe> thanks for the hint, I will\n> erase the chain data folder except te ancient, and try to sync again.\n>\n> As for the 512MB cache, it was the only config that did the trick, if I\n> did not set it, or set it 1024MB or other value, I get the error\n>\n> runtime: out of memory: cannot allocate 3465216-byte block (3685285888 in use)\n> fatal error: out of memory\n>\n> —\n> You are receiving this because you were mentioned.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/ethereum/go-ethereum/issues/20067?email_source=notifications&email_token=AAA7UGLAJ2ETT3JGAXYG2CDQJOM4ZA5CNFSM4IWICDHKYY3PNVWWK3TUL52HS4DFVREXG43VMVBW63LNMVXHJKTDN5WW2ZLOORPWSZGOD6VD3OQ#issuecomment-531250618>,\n> or mute the thread\n> <https://github.com/notifications/unsubscribe-auth/AAA7UGOP5ZUNQOWWHT7V5MDQJOM4ZANCNFSM4IWICDHA>\n> .\n>\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/531380894/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/531396919",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20067#issuecomment-531396919",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20067",
    "id": 531396919,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMTM5NjkxOQ==",
    "user": {
      "login": "CamposBruno",
      "id": 5519109,
      "node_id": "MDQ6VXNlcjU1MTkxMDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5519109?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/CamposBruno",
      "html_url": "https://github.com/CamposBruno",
      "followers_url": "https://api.github.com/users/CamposBruno/followers",
      "following_url": "https://api.github.com/users/CamposBruno/following{/other_user}",
      "gists_url": "https://api.github.com/users/CamposBruno/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/CamposBruno/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/CamposBruno/subscriptions",
      "organizations_url": "https://api.github.com/users/CamposBruno/orgs",
      "repos_url": "https://api.github.com/users/CamposBruno/repos",
      "events_url": "https://api.github.com/users/CamposBruno/events{/privacy}",
      "received_events_url": "https://api.github.com/users/CamposBruno/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-09-13T21:28:23Z",
    "updated_at": "2019-09-13T21:28:23Z",
    "author_association": "NONE",
    "body": "Thanks @karalabe! I was using 32bit binary. Now I'm using 64bit and that solved the issue! ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/531396919/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
