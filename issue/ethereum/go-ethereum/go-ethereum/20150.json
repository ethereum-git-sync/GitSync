{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20150",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20150/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20150/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20150/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/20150",
  "id": 501925790,
  "node_id": "MDU6SXNzdWU1MDE5MjU3OTA=",
  "number": 20150,
  "title": "Prevent fast-synced node from reorg to before pivot",
  "user": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 202012689,
      "node_id": "MDU6TGFiZWwyMDIwMTI2ODk=",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/area:core",
      "name": "area:core",
      "color": "fbca04",
      "default": false,
      "description": null
    },
    {
      "id": 1149827823,
      "node_id": "MDU6TGFiZWwxMTQ5ODI3ODIz",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/area:fast-sync",
      "name": "area:fast-sync",
      "color": "9165c6",
      "default": false,
      "description": ""
    },
    {
      "id": 1479386843,
      "node_id": "MDU6TGFiZWwxNDc5Mzg2ODQz",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/priority:1",
      "name": "priority:1",
      "color": "49babc",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2019-10-03T08:32:14Z",
  "updated_at": "2020-05-28T09:11:26Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "As evidenced by https://github.com/ethereum/go-ethereum/issues/20149 , on a chain where there are long (invalid) sidechains, there's a possibility for a fast-synched chain to basically switch over to a full block-by-block sync from genesis. \r\n\r\n1. Node syncs to pivot block `N`. \r\n2. Node finds out about a sidechain -- in the case of #20149, the old non-istanbul chain which is still being mined.  Node eventually detects that the sidechain has higher `TD` than his own chain.\r\n3.  Normally, the fetcher prevents extremely long reorgs, where the common ancestor is more than an epoch back. However, in this case, the common ancestor is not _that_ far off. \r\n4. The crucial point here is that although the common ancestor is not that far off, it's _behind the pivot point_, so the node does not have any state for it. \r\n5. So the sidechain importer goes all the way back to genesis, where it _has_ the state, and then reimports every block to recreate the state for the common ancestor. \r\n6. It will eventually reach the fork point, and there detect that there's an invalid block, and reject the sidechain. However, I believe that this scenario might actually repeat multiple times.\r\n\r\nA couple of things we can/should fix: \r\n- A fast-synched node should _not_ try to regenerate state / import a sidechain if the common ancestor is earlier than the pivot point. This can maybe be expressed more generically as: A node should not regenerate state from genesis (?).\r\n- The _penalty_ of the repeating behaviour can be stopped, if we always store the state of a common ancestor, after we have recalculated it (but before we commence on the potentially bad sidechain). (Note: this does not prevent the repetitive behaviour, only the ovehead) \r\n- It _might_ make sense to remember bad blocks, but that is a bit dangerous too. That would stop the repetitive behaviour\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20150/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20150/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/537849792",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20150#issuecomment-537849792",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20150",
    "id": 537849792,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzNzg0OTc5Mg==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-10-03T08:44:47Z",
    "updated_at": "2019-10-03T08:45:12Z",
    "author_association": "MEMBER",
    "body": " * We perhas should also force-commit `FORK_BLOCK - 1` states. This would help during long side chain reimports and would rather always fail instantly at the first invalid block. Though this doesn't help fast sync.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/537849792/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/537850431",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20150#issuecomment-537850431",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20150",
    "id": 537850431,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzNzg1MDQzMQ==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-10-03T08:46:38Z",
    "updated_at": "2019-10-03T08:46:38Z",
    "author_association": "MEMBER",
    "body": "* We should propose an EIP to add some special marker to fork block headers so we can instantly invalidate blocks that are on a different fork, without having to even regenerate the state for it. This is a secondary mechanism beside the forkid (which is cheaper/simpler, but can be faked).",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/537850431/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
