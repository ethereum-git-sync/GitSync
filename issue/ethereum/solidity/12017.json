{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/12017",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/12017/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/12017/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/12017/events",
  "html_url": "https://github.com/ethereum/solidity/issues/12017",
  "id": 1005593102,
  "node_id": "I_kwDOAm_5kc478CIO",
  "number": 12017,
  "title": "Replace assertions with proper validations in AST import",
  "user": {
    "login": "cameel",
    "id": 137030,
    "node_id": "MDQ6VXNlcjEzNzAzMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cameel",
    "html_url": "https://github.com/cameel",
    "followers_url": "https://api.github.com/users/cameel/followers",
    "following_url": "https://api.github.com/users/cameel/following{/other_user}",
    "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
    "organizations_url": "https://api.github.com/users/cameel/orgs",
    "repos_url": "https://api.github.com/users/cameel/repos",
    "events_url": "https://api.github.com/users/cameel/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cameel/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4438003076,
      "node_id": "LA_kwDOAm_5kc8AAAABCIaNhA",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/medium%20effort",
      "name": "medium effort",
      "color": "ff7df7",
      "default": false,
      "description": "Default level of effort"
    },
    {
      "id": 4438157609,
      "node_id": "LA_kwDOAm_5kc8AAAABCIjpKQ",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/low%20impact",
      "name": "low impact",
      "color": "5d71ff",
      "default": false,
      "description": "Changes are not very noticeable or potential benefits are limited."
    },
    {
      "id": 4438490842,
      "node_id": "LA_kwDOAm_5kc8AAAABCI3-2g",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/should%20have",
      "name": "should have",
      "color": "ffbe6c",
      "default": false,
      "description": "We like the idea but itâ€™s not important enough to be a part of the roadmap."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-09-23T15:52:34Z",
  "updated_at": "2022-09-14T16:14:50Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Abstract\r\nThe [AST import code in `CommandLineInterface`](https://github.com/ethereum/solidity/blob/v0.8.7/solc/CommandLineInterface.cpp#L609-L626) is currently wrapped in an exception handler that catches all exceptions and prints an error message. This is most likely because the JSON input does not get validated before it's passed to `ASTJsonImporter` and the importer just asserts things that it expects not to happen.\r\n\r\nThese assertions should be replaced with proper validations.\r\n\r\nThe `--import-asm-json` option that will be introduced in #11807 will likely suffer from the same problem.\r\n\r\n### Example\r\nThis is how you can trigger a validation error now:\r\n```bash\r\necho \"{}\" | solc - --import-ast\r\n```\r\n```\r\nFailed to import AST: Invalid Format for import-JSON: Must have 'sources'-object\r\n```\r\n\r\n## Motivation\r\nThe current handler suppresses all the extra debug information we include in internal compiler errors. This is what we want if these errors are actually validation errors but not for normal assertions. It means that our usual assertions result in a message looking like this:\r\n```\r\nFailed to import AST: \r\n```\r\nThe message is meant to be followed by error description but our assertions often have no description. This makes debugging harder.\r\n\r\n## Specification\r\nWe should define a new exception type representing a validation error and use it in `ASTJsonImporter`. Then only catch this exception in `CommandLineInterface` and let other exceptions through.\r\n\r\nSince the exception handler also covers `CompilerStack->analyze()`, it's likely that the assertions in `ASTJsonImporter` are not enough to satisfy its assumptions. As a part of this task we need to check what exactly these assumptions are and add additional validations against them in `ASTJsonImporter`.\r\n\r\n## Backwards Compatibility\r\nThis is just a refactor and should not cause changes visible to the user other than in internal compiler errors - and we do not provide backwards-compatibility guarantees for these.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/12017/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/12017/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/940130859",
    "html_url": "https://github.com/ethereum/solidity/issues/12017#issuecomment-940130859",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12017",
    "id": 940130859,
    "node_id": "IC_kwDOAm_5kc44CUIr",
    "user": {
      "login": "ryzheboka",
      "id": 25465835,
      "node_id": "MDQ6VXNlcjI1NDY1ODM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/25465835?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryzheboka",
      "html_url": "https://github.com/ryzheboka",
      "followers_url": "https://api.github.com/users/ryzheboka/followers",
      "following_url": "https://api.github.com/users/ryzheboka/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryzheboka/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryzheboka/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryzheboka/subscriptions",
      "organizations_url": "https://api.github.com/users/ryzheboka/orgs",
      "repos_url": "https://api.github.com/users/ryzheboka/repos",
      "events_url": "https://api.github.com/users/ryzheboka/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryzheboka/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-11T15:27:00Z",
    "updated_at": "2021-10-11T15:27:00Z",
    "author_association": "NONE",
    "body": "Hi, I would like to work on this issue. I'm new to contributing, can you please check my understanding of the needed changes? So I would need to add a new Exception to [Exceptions.h](https://github.com/ethereum/solidity/blob/develop/libsolutil/Exceptions.h). Then, I should throw this exception in ASTJsonImporter. ASRJsonImporter::jsonToSourceUnit is then used in CompilerStack::importASTs. This function would pass the Exception to CommandLineInterface. In CommandLineInterface, I need to catch Exceptions of the new type, instead of the type \"Exception\".",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/940130859/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/940459351",
    "html_url": "https://github.com/ethereum/solidity/issues/12017#issuecomment-940459351",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12017",
    "id": 940459351,
    "node_id": "IC_kwDOAm_5kc44DkVX",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-11T21:34:54Z",
    "updated_at": "2021-10-11T21:35:40Z",
    "author_association": "MEMBER",
    "body": "Generally yes, but this is only a part of the task. The other part is to ensure that the current validations are sufficient so that switching to a more specialized exception handler in `CommandLineInterface` does not result in crashes on invalid input. I suspect that they might not be sufficient and it's probably the reason why the handler is so broad.\r\n\r\nChecking that will require some experimentation with invalid input and adding tests covering all cases that should be validated. Looks like we currently have nearly zero coverage for AST import. [`ast_json_import_wrong_evmVersion`](https://github.com/ethereum/solidity/tree/develop/test/cmdlineTests/ast_json_import_wrong_evmVersion) is the only test I can find.\r\n\r\nAs for the exception, looks like we already have one in [`liblangutil/Exceptions.h`](https://github.com/ethereum/solidity/blob/develop/liblangutil/Exceptions.h) - `InvalidAstError` so you can reuse it. This is actually the exception that is thrown by the `astAssert()` macro. I originally thought that the importer is mixing actual assertions with ones used for input validation but after looking through the file I see that they're all used for validation. This means that leaving these macro invocations as is would be fine and you just need to rename the macro to something like `astCheck()` or `astValidate()` to make it clear that it's not an assertion.\r\n\r\nOverall this is not going to be a small task if we want to be sure the change does not break anything. It's not hard but might be a bit tedious to get the full coverage. If you'd rather take something smaller, I'd recommend #9627 or #10308.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/940459351/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/940787878",
    "html_url": "https://github.com/ethereum/solidity/issues/12017#issuecomment-940787878",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12017",
    "id": 940787878,
    "node_id": "IC_kwDOAm_5kc44E0im",
    "user": {
      "login": "ryzheboka",
      "id": 25465835,
      "node_id": "MDQ6VXNlcjI1NDY1ODM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/25465835?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryzheboka",
      "html_url": "https://github.com/ryzheboka",
      "followers_url": "https://api.github.com/users/ryzheboka/followers",
      "following_url": "https://api.github.com/users/ryzheboka/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryzheboka/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryzheboka/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryzheboka/subscriptions",
      "organizations_url": "https://api.github.com/users/ryzheboka/orgs",
      "repos_url": "https://api.github.com/users/ryzheboka/repos",
      "events_url": "https://api.github.com/users/ryzheboka/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryzheboka/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-12T08:32:00Z",
    "updated_at": "2021-10-12T08:32:00Z",
    "author_association": "NONE",
    "body": "Thanks for the explanations! #10308 sounds less extensive and more manageable than #12017. It might end up too overwhelming for me to search for possible other unknown reasons for exceptions in this issue.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/940787878/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/942401457",
    "html_url": "https://github.com/ethereum/solidity/issues/12017#issuecomment-942401457",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12017",
    "id": 942401457,
    "node_id": "IC_kwDOAm_5kc44K-ex",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-13T15:08:14Z",
    "updated_at": "2021-10-13T15:08:14Z",
    "author_association": "MEMBER",
    "body": "Sounds good!",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/942401457/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
