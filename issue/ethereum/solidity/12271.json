{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/12271",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/12271/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/12271/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/12271/events",
  "html_url": "https://github.com/ethereum/solidity/issues/12271",
  "id": 1051083738,
  "node_id": "I_kwDOAm_5kc4-pkPa",
  "number": 12271,
  "title": "[SMTChecker] Fails to prove a simple assertion with a mapping",
  "user": {
    "login": "olehmisar",
    "id": 29802592,
    "node_id": "MDQ6VXNlcjI5ODAyNTky",
    "avatar_url": "https://avatars.githubusercontent.com/u/29802592?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/olehmisar",
    "html_url": "https://github.com/olehmisar",
    "followers_url": "https://api.github.com/users/olehmisar/followers",
    "following_url": "https://api.github.com/users/olehmisar/following{/other_user}",
    "gists_url": "https://api.github.com/users/olehmisar/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/olehmisar/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/olehmisar/subscriptions",
    "organizations_url": "https://api.github.com/users/olehmisar/orgs",
    "repos_url": "https://api.github.com/users/olehmisar/repos",
    "events_url": "https://api.github.com/users/olehmisar/events{/privacy}",
    "received_events_url": "https://api.github.com/users/olehmisar/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2021-11-11T15:14:57Z",
  "updated_at": "2021-11-11T17:44:22Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nThis code emits an SMTChecker warning when compiled, although `balanceOf[account]` can never be greater than `totalSupply`.\r\n<details>\r\n<summary>Code:</summary>\r\n\r\n```solidity\r\n// SPDX-License-Identifier: MIT\r\npragma solidity 0.8.10;\r\n\r\ncontract Token {\r\n    mapping(address => uint256) public balanceOf;\r\n    uint256 public totalSupply;\r\n\r\n    constructor(uint256 totalSupply_) {\r\n        balanceOf[msg.sender] = totalSupply_;\r\n        totalSupply = totalSupply_;\r\n    }\r\n\r\n    function transfer(address recipient, uint256 amount) public {\r\n        balanceOf[msg.sender] -= amount;\r\n        balanceOf[recipient] += amount;\r\n    }\r\n\r\n    function rule_maxBalanceLessThanTotalSupply(address account) external view {\r\n        assert(balanceOf[account] <= totalSupply);\r\n    }\r\n}\r\n```\r\n</details>\r\n\r\n<details>\r\n<summary>Warining:</summary>\r\n\r\n```\r\nWarning: CHC: Assertion violation might happen here.\r\n  --> contracts/Token.sol:19:9:\r\n   |\r\n19 |         assert(balanceOf[account] <= totalSupply);\r\n   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n\r\n\r\nWarning: BMC: Assertion violation happens here.\r\n  --> contracts/Token.sol:19:9:\r\n   |\r\n19 |         assert(balanceOf[account] <= totalSupply);\r\n   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nNote: Counterexample:\r\n  account = 7719\r\n  balanceOf[account] = 39\r\n  totalSupply = 38\r\n\r\nNote: Callstack:\r\nNote:\r\n```\r\n\r\n</details>\r\n\r\nLooks like SMTChecker blindly assigns any value to a mapping entry:\r\n```\r\nNote: Counterexample:\r\n  account = 7719\r\n  balanceOf[account] = 39\r\n  totalSupply = 38\r\n```\r\n\r\nI also created the same token contract but used `balance0` and `balance1` instead of a `mapping`. SMTChecker works as expected in this case. So, I can conclude that it is definitely a problem with `mapping`s.\r\n\r\n<details>\r\n<summary>Code:</summary>\r\nCompiles without warnings:\r\n\r\n```solidity\r\n// SPDX-License-Identifier: MIT\r\npragma solidity 0.8.10;\r\n\r\ncontract Token2 {\r\n    uint256 public balance0;\r\n    uint256 public balance1;\r\n    uint256 public totalSupply;\r\n\r\n    constructor(uint256 totalSupply_) {\r\n        balance0 = totalSupply_;\r\n        totalSupply = totalSupply_;\r\n    }\r\n\r\n    function transfer(uint256 amount) public {\r\n        if (msg.sender == address(0)) {\r\n            balance0 -= amount;\r\n            balance1 += amount;\r\n        } else {\r\n            balance1 -= amount;\r\n            balance0 += amount;\r\n        }\r\n    }\r\n\r\n    function rule_maxBalanceLessThanTotalSupply() external view {\r\n        assert(balance0 <= totalSupply);\r\n        assert(balance1 <= totalSupply);\r\n        assert(balance0 + balance1 == totalSupply);\r\n    }\r\n}\r\n```\r\n\r\n</details>\r\n\r\n## Environment\r\n\r\n- Compiler version: 0.8.10\r\n- Target EVM version (as per compiler settings): london\r\n- Framework/IDE (e.g. Truffle or Remix): hardhat\r\n- EVM execution environment / backend / blockchain client: hardhat network\r\n- Operating system: macOS 12.0.1\r\n\r\n## Steps to Reproduce\r\n```sh\r\ngit clone git@github.com:olehmisar/smt-checker-bug-reproduction-mapping.git\r\nyarn install\r\nyarn hardhat compile --force\r\n```",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/12271/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/12271/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/966471760",
    "html_url": "https://github.com/ethereum/solidity/issues/12271#issuecomment-966471760",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12271",
    "id": 966471760,
    "node_id": "IC_kwDOAm_5kc45mzBQ",
    "user": {
      "login": "leonardoalt",
      "id": 504195,
      "node_id": "MDQ6VXNlcjUwNDE5NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/504195?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/leonardoalt",
      "html_url": "https://github.com/leonardoalt",
      "followers_url": "https://api.github.com/users/leonardoalt/followers",
      "following_url": "https://api.github.com/users/leonardoalt/following{/other_user}",
      "gists_url": "https://api.github.com/users/leonardoalt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/leonardoalt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/leonardoalt/subscriptions",
      "organizations_url": "https://api.github.com/users/leonardoalt/orgs",
      "repos_url": "https://api.github.com/users/leonardoalt/repos",
      "events_url": "https://api.github.com/users/leonardoalt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/leonardoalt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-11T17:09:16Z",
    "updated_at": "2021-11-11T17:09:16Z",
    "author_association": "MEMBER",
    "body": "tldr: assertion is not as simple as it looks, the underlying SMT and Horn solvers were not able to prove the required nonlinear invariant.\r\n\r\nUnfortunately this assertion is logically not as simple as it looks, even though it's a really good property!\r\n\r\nThe counterexample you see comes from the BMC engine which has lots of false positives. If you use the CHC engine alone (which is what I usually do and recommend) you'll probably see that it says it couldn't prove either way, so an assertion violation `might happen`.\r\n\r\nUsually people prove functional correctness of the `transfer` function +- this way:\r\n```\r\n\tfunction transfer(address recipient, uint256 amount) public {\r\n\t\trequire(balanceOf[msg.sender] >= amount);\r\n\t\tuint sumPrev = balanceOf[msg.sender] + balanceOf[recipient];\r\n\t\tbalanceOf[msg.sender] -= amount;\r\n\t\tbalanceOf[recipient] += amount;\r\n\t\tuint sumPost = balanceOf[msg.sender] + balanceOf[recipient];\r\n\t\tassert(sumPrev == sumPost);\r\n\t}\r\n```\r\nThis version is also proved correct by the CHC engine in the SMTChecker. Notice that this is a local property, that must hold over a single transaction.\r\n\r\nYour property is however much much more meaningful because it holds over *infinitely many* transactions, and is much more difficult to prove. In order for the solver to prove this, it would have to find a nonlinear invariant, which is really hard. I tried your code with two different Horn solvers as backend for the SMTChecker, the default one and a different one. Neither could solve it.\r\nWhen you change it to two variables instead of a mapping the problem indeed becomes much simpler and easier to solve.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/966471760/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/966478458",
    "html_url": "https://github.com/ethereum/solidity/issues/12271#issuecomment-966478458",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12271",
    "id": 966478458,
    "node_id": "IC_kwDOAm_5kc45m0p6",
    "user": {
      "login": "olehmisar",
      "id": 29802592,
      "node_id": "MDQ6VXNlcjI5ODAyNTky",
      "avatar_url": "https://avatars.githubusercontent.com/u/29802592?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/olehmisar",
      "html_url": "https://github.com/olehmisar",
      "followers_url": "https://api.github.com/users/olehmisar/followers",
      "following_url": "https://api.github.com/users/olehmisar/following{/other_user}",
      "gists_url": "https://api.github.com/users/olehmisar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/olehmisar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/olehmisar/subscriptions",
      "organizations_url": "https://api.github.com/users/olehmisar/orgs",
      "repos_url": "https://api.github.com/users/olehmisar/repos",
      "events_url": "https://api.github.com/users/olehmisar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/olehmisar/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-11T17:18:09Z",
    "updated_at": "2021-11-11T17:18:09Z",
    "author_association": "NONE",
    "body": "Thanks for the extensive explanation. I appreciate it.\r\n\r\nSorry if the next question is stupid(I don't know anything about how solvers work). If it is possible to unroll a mapping to two variables, is it possible to unroll a mapping to an infinite number of variables, so the solver can prove correctness of the code?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/966478458/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/966481108",
    "html_url": "https://github.com/ethereum/solidity/issues/12271#issuecomment-966481108",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12271",
    "id": 966481108,
    "node_id": "IC_kwDOAm_5kc45m1TU",
    "user": {
      "login": "olehmisar",
      "id": 29802592,
      "node_id": "MDQ6VXNlcjI5ODAyNTky",
      "avatar_url": "https://avatars.githubusercontent.com/u/29802592?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/olehmisar",
      "html_url": "https://github.com/olehmisar",
      "followers_url": "https://api.github.com/users/olehmisar/followers",
      "following_url": "https://api.github.com/users/olehmisar/following{/other_user}",
      "gists_url": "https://api.github.com/users/olehmisar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/olehmisar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/olehmisar/subscriptions",
      "organizations_url": "https://api.github.com/users/olehmisar/orgs",
      "repos_url": "https://api.github.com/users/olehmisar/repos",
      "events_url": "https://api.github.com/users/olehmisar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/olehmisar/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-11T17:21:48Z",
    "updated_at": "2021-11-11T17:21:48Z",
    "author_association": "NONE",
    "body": "And I want to note that from my perspective(just a smart contract developer), SMTChecker is unfortunately useless right now because mappings are used extensively in smart contracts. I wanted to replace a bunch of unit tests in future projects with formal verification and now I see that it is currently impossible. :(",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/966481108/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/966486578",
    "html_url": "https://github.com/ethereum/solidity/issues/12271#issuecomment-966486578",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12271",
    "id": 966486578,
    "node_id": "IC_kwDOAm_5kc45m2oy",
    "user": {
      "login": "leonardoalt",
      "id": 504195,
      "node_id": "MDQ6VXNlcjUwNDE5NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/504195?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/leonardoalt",
      "html_url": "https://github.com/leonardoalt",
      "followers_url": "https://api.github.com/users/leonardoalt/followers",
      "following_url": "https://api.github.com/users/leonardoalt/following{/other_user}",
      "gists_url": "https://api.github.com/users/leonardoalt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/leonardoalt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/leonardoalt/subscriptions",
      "organizations_url": "https://api.github.com/users/leonardoalt/orgs",
      "repos_url": "https://api.github.com/users/leonardoalt/repos",
      "events_url": "https://api.github.com/users/leonardoalt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/leonardoalt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-11T17:29:34Z",
    "updated_at": "2021-11-11T17:29:34Z",
    "author_association": "MEMBER",
    "body": "> Sorry if the next question is stupid(I don't know anything about how solvers work). If it is possible to unroll a mapping to two variables, is it possible to unroll a mapping to an infinite number of variables, so the solver can prove correctness of the code?\r\n\r\nIn a very high level that's what the solver does. A mapping is treated as an infinite array, so it's kind of that.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/966486578/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/966496224",
    "html_url": "https://github.com/ethereum/solidity/issues/12271#issuecomment-966496224",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12271",
    "id": 966496224,
    "node_id": "IC_kwDOAm_5kc45m4_g",
    "user": {
      "login": "leonardoalt",
      "id": 504195,
      "node_id": "MDQ6VXNlcjUwNDE5NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/504195?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/leonardoalt",
      "html_url": "https://github.com/leonardoalt",
      "followers_url": "https://api.github.com/users/leonardoalt/followers",
      "following_url": "https://api.github.com/users/leonardoalt/following{/other_user}",
      "gists_url": "https://api.github.com/users/leonardoalt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/leonardoalt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/leonardoalt/subscriptions",
      "organizations_url": "https://api.github.com/users/leonardoalt/orgs",
      "repos_url": "https://api.github.com/users/leonardoalt/repos",
      "events_url": "https://api.github.com/users/leonardoalt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/leonardoalt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-11T17:44:22Z",
    "updated_at": "2021-11-11T17:44:22Z",
    "author_association": "MEMBER",
    "body": "> And I want to note that from my perspective(just a smart contract developer), SMTChecker is unfortunately useless right now because mappings are used extensively in smart contracts. I wanted to replace a bunch of unit tests in future projects with formal verification and now I see that it is currently impossible. :(\r\n\r\nThanks for the feedback!\r\nThat's not always the case though. Mappings are not always that problematic, note that the main problem here is the nonlinear math (variable * variable) over multiple transactions, and not the mapping itself. Tools like the SMTChecker cannot handle this type of math very well, and this includes hevm and other symbolic execution tools. For example, even a simplified AMM code like https://github.com/d-xo/symtest-examples/blob/main/src/AMM.sol , that doesn't use mappings at all, won't be supported. We also noticed recently that the solver that the SMTChecker uses by default doesn't solve many problems that another solver we recently discovered does, because of the way that the SMTChecker encodes the contracts. Unfortunately it's still some work to be able to use the second solver.\r\nJust as an example, we recently managed to verify the Open Zeppelin's ERC777 implementation without changes, and those contracts use a lot of mappings, even nested mappings, and other complicated features, but this required us to use this new solver which is not fully integrated and shipped with the compiler.\r\n\r\nI think you're on the right path with the properties it looks like you're writing, hopefully the tool will be able to cope with some of them.\r\nI'd suggest that you also use the `modelChecker.contracts` option to choose exactly which contract you're verifying, this helps the solver a lot, and also increase the `modelChecker.timeout`.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/966496224/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
