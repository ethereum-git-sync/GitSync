{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/12647",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/12647/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/12647/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/12647/events",
  "html_url": "https://github.com/ethereum/solidity/issues/12647",
  "id": 1127183017,
  "node_id": "I_kwDOAm_5kc5DL3Kp",
  "number": 12647,
  "title": "external contract can waste caller's gas by return value.",
  "user": {
    "login": "drortirosh",
    "id": 40341007,
    "node_id": "MDQ6VXNlcjQwMzQxMDA3",
    "avatar_url": "https://avatars.githubusercontent.com/u/40341007?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/drortirosh",
    "html_url": "https://github.com/drortirosh",
    "followers_url": "https://api.github.com/users/drortirosh/followers",
    "following_url": "https://api.github.com/users/drortirosh/following{/other_user}",
    "gists_url": "https://api.github.com/users/drortirosh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/drortirosh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/drortirosh/subscriptions",
    "organizations_url": "https://api.github.com/users/drortirosh/orgs",
    "repos_url": "https://api.github.com/users/drortirosh/repos",
    "events_url": "https://api.github.com/users/drortirosh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/drortirosh/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 785717317,
      "node_id": "MDU6TGFiZWw3ODU3MTczMTc=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/language%20design%20:rage4:",
      "name": "language design :rage4:",
      "color": "9d76d3",
      "default": false,
      "description": "Any changes to the language, e.g. new features"
    },
    {
      "id": 1282209978,
      "node_id": "MDU6TGFiZWwxMjgyMjA5OTc4",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/optimizer",
      "name": "optimizer",
      "color": "d4c5f9",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2022-02-08T12:19:44Z",
  "updated_at": "2022-03-03T14:58:23Z",
  "closed_at": "2022-03-03T14:58:23Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "When calling a contract, the compiler always assigns a buffer to hold entire returned data, even if not in use.\r\neven when calling a \"void\" function, the generated yul code always does\r\n```\r\n    finalize_allocation(_2, returndatasize())\r\n```\r\nregardless if there is a code to use the data or not.\r\n\r\nThis command, by itself, doesn't cause any significant gas usage. however, any future memory operation will start at higher offset, and the caller contract pays for the entire storage in use, up to the highest offset.\r\n\r\nConsider an inner call that does\r\n```\r\n    return (0,1000000)\r\n```\r\nNot only the inner call takes a lot of gas (as expected, to copy this large buffer), but also the calling code now wastes more gas on its own memory allocations.\r\n\r\n## Suggestion:\r\n1. optimize out this allocation when calling a \"void\" function\r\n2. when calling a function with static return size (e.g. `returns (uint)`), use the return buffer size parameter of the call itself, instead of `returndatasize()`. This way, the caller expects (and uses) an exact amount of memory (it is also slightly cheaper than `returndatacopy(memptr, returndatasize())`, but this cost saving is marginal)\r\n3. handling a function with dynamic return (e.g. `returns ( string memory)`) is more complex. This would probably require a language change, to signal the max expected size\r\n\r\n## try/catch blocks\r\nThe same rules apply to:\r\n```\r\n    try methodCall() { }\r\n    catch {\r\n    }\r\n```\r\n",
  "closed_by": {
    "login": "cameel",
    "id": 137030,
    "node_id": "MDQ6VXNlcjEzNzAzMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cameel",
    "html_url": "https://github.com/cameel",
    "followers_url": "https://api.github.com/users/cameel/followers",
    "following_url": "https://api.github.com/users/cameel/following{/other_user}",
    "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
    "organizations_url": "https://api.github.com/users/cameel/orgs",
    "repos_url": "https://api.github.com/users/cameel/repos",
    "events_url": "https://api.github.com/users/cameel/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cameel/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/12647/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/12647/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1032671656",
    "html_url": "https://github.com/ethereum/solidity/issues/12647#issuecomment-1032671656",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12647",
    "id": 1032671656,
    "node_id": "IC_kwDOAm_5kc49jVGo",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-08T14:30:33Z",
    "updated_at": "2022-02-08T14:30:33Z",
    "author_association": "MEMBER",
    "body": "Since the ABI decoder only verifies that returned data is not too short, we could limit the return size to the max size, if the max size is a constant and there are no pointers involved when decoding.\r\n\r\nIn general, I'm not too keen on guarding against hostile called contracts with regards to wasting gas, this is rather complicated and, at least to me, the benefit is not too big.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1032671656/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1032941639",
    "html_url": "https://github.com/ethereum/solidity/issues/12647#issuecomment-1032941639",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12647",
    "id": 1032941639,
    "node_id": "IC_kwDOAm_5kc49kXBH",
    "user": {
      "login": "drortirosh",
      "id": 40341007,
      "node_id": "MDQ6VXNlcjQwMzQxMDA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/40341007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/drortirosh",
      "html_url": "https://github.com/drortirosh",
      "followers_url": "https://api.github.com/users/drortirosh/followers",
      "following_url": "https://api.github.com/users/drortirosh/following{/other_user}",
      "gists_url": "https://api.github.com/users/drortirosh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/drortirosh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/drortirosh/subscriptions",
      "organizations_url": "https://api.github.com/users/drortirosh/orgs",
      "repos_url": "https://api.github.com/users/drortirosh/repos",
      "events_url": "https://api.github.com/users/drortirosh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/drortirosh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-08T18:42:44Z",
    "updated_at": "2022-02-08T18:42:44Z",
    "author_association": "NONE",
    "body": "it is an attack surface that was used.\r\nhttps://twitter.com/transmissions11/status/1487532348467912704\r\n\r\nit will take more effort to protect dynamic-sized return values, but at least avoid exposing staticly-sized return values (like void)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1032941639/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1033040511",
    "html_url": "https://github.com/ethereum/solidity/issues/12647#issuecomment-1033040511",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12647",
    "id": 1033040511,
    "node_id": "IC_kwDOAm_5kc49kvJ_",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-08T20:39:17Z",
    "updated_at": "2022-02-08T20:39:17Z",
    "author_association": "MEMBER",
    "body": "> optimize out this allocation when calling a \"void\" function\r\n\r\n#12306 would cover this case, though it's a bit more general. And harder to solve. A special case for when there is no data returned at all is much simpler - @chriseth do we want to have such a special case or should it be handled as a part of that more general mechanism for optimizing out unused allocations?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1033040511/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1034292205",
    "html_url": "https://github.com/ethereum/solidity/issues/12647#issuecomment-1034292205",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12647",
    "id": 1034292205,
    "node_id": "IC_kwDOAm_5kc49pgvt",
    "user": {
      "login": "frangio",
      "id": 481465,
      "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/frangio",
      "html_url": "https://github.com/frangio",
      "followers_url": "https://api.github.com/users/frangio/followers",
      "following_url": "https://api.github.com/users/frangio/following{/other_user}",
      "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
      "organizations_url": "https://api.github.com/users/frangio/orgs",
      "repos_url": "https://api.github.com/users/frangio/repos",
      "events_url": "https://api.github.com/users/frangio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/frangio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-09T23:05:59Z",
    "updated_at": "2022-02-09T23:05:59Z",
    "author_association": "CONTRIBUTOR",
    "body": "I felt the same way as @chriseth when I first saw this (didn't really consider it an \"attack\") but there's something interesting about this compared to other possible \"gas wasting attacks\".\r\n\r\nWhen one writes `(, bytes res) = target.call{gas: G}(data)` one expects that `G` will be an upper bound on the gas consumed by the call (Â± some constant), but in fact the target contract can cause \"a lot\" more gas to be consumed by copying large returndata.\r\n\r\nNote that this is specifically about `.call` with a `gas` parameter though, so it does not affect high level function calls, but it may be an argument to introduce a new call parameter that would act as a cap on the memory that will be copied from returndata.\r\n\r\nAs for high level function calls, I think this makes sense as an optimization, but I would not consider it critical (based on the arguments I've seen so far).",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1034292205/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1034692144",
    "html_url": "https://github.com/ethereum/solidity/issues/12647#issuecomment-1034692144",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12647",
    "id": 1034692144,
    "node_id": "IC_kwDOAm_5kc49rCYw",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-10T09:32:25Z",
    "updated_at": "2022-02-10T09:32:25Z",
    "author_association": "MEMBER",
    "body": "As far as I see it, direct access to gas turned out to be a bad idea, not only because gas costs have changed several times over the past years. Because of that, I would not want to add more options to `.call`. Instead, if people want full control, they should use inline assembly.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1034692144/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1035077546",
    "html_url": "https://github.com/ethereum/solidity/issues/12647#issuecomment-1035077546",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12647",
    "id": 1035077546,
    "node_id": "IC_kwDOAm_5kc49sgeq",
    "user": {
      "login": "drortirosh",
      "id": 40341007,
      "node_id": "MDQ6VXNlcjQwMzQxMDA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/40341007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/drortirosh",
      "html_url": "https://github.com/drortirosh",
      "followers_url": "https://api.github.com/users/drortirosh/followers",
      "following_url": "https://api.github.com/users/drortirosh/following{/other_user}",
      "gists_url": "https://api.github.com/users/drortirosh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/drortirosh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/drortirosh/subscriptions",
      "organizations_url": "https://api.github.com/users/drortirosh/orgs",
      "repos_url": "https://api.github.com/users/drortirosh/repos",
      "events_url": "https://api.github.com/users/drortirosh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/drortirosh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-10T15:47:27Z",
    "updated_at": "2022-02-10T15:47:27Z",
    "author_association": "NONE",
    "body": ">  As far as I see it, direct access to gas turned out to be a bad idea\r\n\r\nI fully agree. the compiler shouldn't do any gas manipulation.\r\n\r\nWhat I do think it should is do LESS UNEEDED, UNEXPECTED work: if a method call returns nothing (or fixed 32 bytes), don't attempt to use/allocate `returndatasize()` dynamic data",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1035077546/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
