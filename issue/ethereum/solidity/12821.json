{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/12821",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/12821/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/12821/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/12821/events",
  "html_url": "https://github.com/ethereum/solidity/issues/12821",
  "id": 1174593485,
  "node_id": "I_kwDOAm_5kc5GAt_N",
  "number": 12821,
  "title": "constant lookup tables or datacopy in Solidity",
  "user": {
    "login": "recmo",
    "id": 4532328,
    "node_id": "MDQ6VXNlcjQ1MzIzMjg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4532328?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/recmo",
    "html_url": "https://github.com/recmo",
    "followers_url": "https://api.github.com/users/recmo/followers",
    "following_url": "https://api.github.com/users/recmo/following{/other_user}",
    "gists_url": "https://api.github.com/users/recmo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/recmo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/recmo/subscriptions",
    "organizations_url": "https://api.github.com/users/recmo/orgs",
    "repos_url": "https://api.github.com/users/recmo/repos",
    "events_url": "https://api.github.com/users/recmo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/recmo/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 785717317,
      "node_id": "MDU6TGFiZWw3ODU3MTczMTc=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/language%20design%20:rage4:",
      "name": "language design :rage4:",
      "color": "9d76d3",
      "default": false,
      "description": "Any changes to the language, e.g. new features"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-03-20T15:50:59Z",
  "updated_at": "2022-08-17T13:48:57Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!--## Prerequisites\r\n\r\n- First, many thanks for taking part in the community. We really appreciate that.\r\n- We realize there is a lot of data requested here. We ask only that you do your best to provide as much information as possible so we can better help you.\r\n- Support questions are better asked in one of the following locations:\r\n    - [Solidity chat](https://gitter.im/ethereum/solidity)\r\n    - [Stack Overflow](https://ethereum.stackexchange.com/)\r\n- Ensure the issue isn't already reported (check `feature` and `language design` labels).\r\n\r\n*Delete the above section and the instructions in the sections below before submitting*\r\n-->\r\n\r\n## Abstract\r\n\r\nOn several occasions I wished I could write lookup tables like so\r\n\r\n```solidity\r\nuint256[256] constant lookup = [1,2,3,4, /* data */];\r\n\r\nfunction lookup_demo(int256 x) internal pure returns (int256 r) {\r\n    assert(x < 256);\r\n    r = lookup[x];\r\n} \r\n```\r\n\r\nThe expected behaviour here is for solc to compile this down to a Yul `data` object and a `datacopy` to scratch followed by and 1mload`, which in turn results in an EVM `codecopy + mload` instruction. Unfortunately instead I get\r\n\r\n```\r\nTypeError: Type uint8[256] memory is not implicitly convertible to expected type uint256[256] memory.\r\n```\r\n\r\n<!--Please describe by example what problem you see in the current Solidity language and reason about it.-->\r\n\r\n## Motivation\r\n\r\nI am not aware of an alternative with the same constant gas cost. It also appears I am not the only one looking for such a feature (see [this](https://ethereum.stackexchange.com/questions/51415/how-do-i-make-an-efficient-lookup-table) stackoverflow question).\r\n\r\n<!--In this section you describe how you propose to address the problem you described earlier, including by giving one or more exemplary source code snippets for demonstration.-->\r\n\r\n## Specification\r\n\r\n<!--The technical specification should describe the syntax and semantics of any new feature. The specification should be detailed enough to allow any developer to implement the functionality.-->\r\n\r\nPossible solutions for lookup table in order of my personal preference:\r\n\r\n1. Allow use of `data` objects and `datacopy` in inline assembly.\r\n2. Support `code` as a full fledged read-only address space alongside `memory` and `storage`.\r\n3. A language feature that allows for constant plain arrays using data objects and datacopy as in example code above.\r\n4. Allow use of `verbatim_*_*` in inline assembly (some hacks using `PC` can make it work).\r\n\r\n## Backwards Compatibility\r\n\r\nShould be no concerns.\r\n\r\n<!--\r\nAll language changes that introduce backwards incompatibilities must include a section describing these incompatibilities and their severity.\r\n\r\nPlease describe how you propose to deal with these incompatibilities.\r\n-->\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/12821/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/12821/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1073281432",
    "html_url": "https://github.com/ethereum/solidity/issues/12821#issuecomment-1073281432",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12821",
    "id": 1073281432,
    "node_id": "IC_kwDOAm_5kc4_-PmY",
    "user": {
      "login": "recmo",
      "id": 4532328,
      "node_id": "MDQ6VXNlcjQ1MzIzMjg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4532328?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/recmo",
      "html_url": "https://github.com/recmo",
      "followers_url": "https://api.github.com/users/recmo/followers",
      "following_url": "https://api.github.com/users/recmo/following{/other_user}",
      "gists_url": "https://api.github.com/users/recmo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/recmo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/recmo/subscriptions",
      "organizations_url": "https://api.github.com/users/recmo/orgs",
      "repos_url": "https://api.github.com/users/recmo/repos",
      "events_url": "https://api.github.com/users/recmo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/recmo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-20T16:03:04Z",
    "updated_at": "2022-03-20T16:12:29Z",
    "author_association": "NONE",
    "body": "One currently available workaround (while still O(n)) is the stackoverflow suggestion:\r\n\r\n```solidity\r\nbytes constant lookup = hex\"/* data */\";\r\n\r\nfunction lookup_demo(int256 x) internal pure returns (int256 r) {\r\n    assert(x < 256);\r\n    bytes memory copy = lookup;\r\n    assembly {\r\n        r := mload(add(copy, shl(add(x, 1), 5)))\r\n    }\r\n}\r\n```\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1073281432/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1073284097",
    "html_url": "https://github.com/ethereum/solidity/issues/12821#issuecomment-1073284097",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12821",
    "id": 1073284097,
    "node_id": "IC_kwDOAm_5kc4_-QQB",
    "user": {
      "login": "recmo",
      "id": 4532328,
      "node_id": "MDQ6VXNlcjQ1MzIzMjg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4532328?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/recmo",
      "html_url": "https://github.com/recmo",
      "followers_url": "https://api.github.com/users/recmo/followers",
      "following_url": "https://api.github.com/users/recmo/following{/other_user}",
      "gists_url": "https://api.github.com/users/recmo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/recmo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/recmo/subscriptions",
      "organizations_url": "https://api.github.com/users/recmo/orgs",
      "repos_url": "https://api.github.com/users/recmo/repos",
      "events_url": "https://api.github.com/users/recmo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/recmo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-20T16:17:30Z",
    "updated_at": "2022-03-20T16:28:00Z",
    "author_association": "NONE",
    "body": "Another current available workaround (which is technically O(log n) but with a big factor) is a big ugly binary tree of branches:\r\n\r\n```solidity\r\nfunction lookup_demo(int256 x) internal pure returns (int256 r) {\r\n    assert(x < 256);\r\n    if (x < 128) {\r\n        if (x < 64) {\r\n            if (x < 32) {\r\n                if (x < 16) {\r\n                    if (x < 8) {\r\n                        if (x < 4) {\r\n                            if (x < 2) {\r\n                                if (x < 1) {\r\n                                    r = 0;\r\n                                } else {\r\n                                    r = 1;\r\n                                }\r\n                            } else {\r\n                                if (x < 3) {\r\n                                    r = 2;\r\n                                } else {\r\n                                    r = 3;\r\n                                }\r\n                            }\r\n                        } else {\r\n                            revert(); // TODO\r\n                        }\r\n                    } else {\r\n                        revert(); // TODO\r\n                    }\r\n                } else {\r\n                    revert(); // TODO\r\n                }\r\n            } else {\r\n                revert(); // TODO\r\n            }\r\n        } else {\r\n            revert(); // TODO\r\n        }\r\n    } else {\r\n        revert(); // TODO\r\n    }\r\n}\r\n```\r\n\r\nEdit: This benchmarks as ~200 gas, compared to 2000 gas for the `bytes constant` one. Shows you the power of logarithms! But a proper `codecopy` solution should only be a dozen or so gas.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1073284097/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1073284968",
    "html_url": "https://github.com/ethereum/solidity/issues/12821#issuecomment-1073284968",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12821",
    "id": 1073284968,
    "node_id": "IC_kwDOAm_5kc4_-Qdo",
    "user": {
      "login": "hrkrshnn",
      "id": 13174375,
      "node_id": "MDQ6VXNlcjEzMTc0Mzc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/13174375?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hrkrshnn",
      "html_url": "https://github.com/hrkrshnn",
      "followers_url": "https://api.github.com/users/hrkrshnn/followers",
      "following_url": "https://api.github.com/users/hrkrshnn/following{/other_user}",
      "gists_url": "https://api.github.com/users/hrkrshnn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hrkrshnn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hrkrshnn/subscriptions",
      "organizations_url": "https://api.github.com/users/hrkrshnn/orgs",
      "repos_url": "https://api.github.com/users/hrkrshnn/repos",
      "events_url": "https://api.github.com/users/hrkrshnn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hrkrshnn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-20T16:23:11Z",
    "updated_at": "2022-03-20T16:23:11Z",
    "author_association": "MEMBER",
    "body": "Effectively, implementing https://github.com/ethereum/solidity/issues/12587 would allow doing this. `immutable` / `code` data location would be stored in bytecode. The lookup would be `codecopy(...)` of some offset.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1073284968/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
