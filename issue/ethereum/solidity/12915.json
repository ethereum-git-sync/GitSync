{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/12915",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/12915/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/12915/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/12915/events",
  "html_url": "https://github.com/ethereum/solidity/issues/12915",
  "id": 1197462155,
  "node_id": "I_kwDOAm_5kc5HX9KL",
  "number": 12915,
  "title": "Solidity provides invalid `start` in the source map",
  "user": {
    "login": "dongmingh",
    "id": 17034559,
    "node_id": "MDQ6VXNlcjE3MDM0NTU5",
    "avatar_url": "https://avatars.githubusercontent.com/u/17034559?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dongmingh",
    "html_url": "https://github.com/dongmingh",
    "followers_url": "https://api.github.com/users/dongmingh/followers",
    "following_url": "https://api.github.com/users/dongmingh/following{/other_user}",
    "gists_url": "https://api.github.com/users/dongmingh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dongmingh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dongmingh/subscriptions",
    "organizations_url": "https://api.github.com/users/dongmingh/orgs",
    "repos_url": "https://api.github.com/users/dongmingh/repos",
    "events_url": "https://api.github.com/users/dongmingh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dongmingh/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1017612679,
      "node_id": "MDU6TGFiZWwxMDE3NjEyNjc5",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/protocol%20design%20:crystal_ball:",
      "name": "protocol design :crystal_ball:",
      "color": "8af77e",
      "default": false,
      "description": "Potential changes to ABI, meta data, standard JSON"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2022-04-08T15:21:46Z",
  "updated_at": "2022-05-26T04:58:04Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nThe value of `start` in the sourceMap is greater than the length of source file.\r\nThe `start` is the byte offset to the start of the range in the source file.  Hence this value should be less than the byte length of source file.\r\n\r\n## Environment\r\n\r\n- Compiler version: 0.6.8\r\n- Target EVM version (as per compiler settings):\r\n- Framework/IDE (e.g. Truffle or Remix): Truffle\r\n- EVM execution environment / backend / blockchain client:\r\n- Operating system: MacOS Big Sur\r\n\r\n## Steps to Reproduce\r\n\r\nThe steps to reproduce this issue are given in the truffle issue (https://github.com/trufflesuite/truffle/issues/4616).\r\nAfter stepping to 8240 with truffle debugger command `; 8239`, use the following commands to see the issue:\r\n\r\n1. issue command `:!<sourcemapping.current.instruction>` to see the `start` of the first instruction is 28307\r\n```\r\ndebug(inline_config:0x1c796d1e...)> :!<sourcemapping.current.instruction>\r\n{\r\n  pc: 0,\r\n  name: 'PUSH1',\r\n  pushData: '0x80',\r\n  index: 0,\r\n  jump: '-',\r\n  start: 28307,\r\n  length: 3774,\r\n  file: 0,\r\n  modifierDepth: 0,\r\n  range: {\r\n    start: {\r\n      line: null,\r\n      column: null\r\n    },\r\n    end: {\r\n      line: null,\r\n      column: null\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n2. Issue command `:!<sourcemapping.current.sourceMap>` to see the source map which shows the `start` of the first instruction is 28307\r\n```\r\ndebug(inline_config:0x1c796d1e...)> :!<sourcemapping.current.sourceMap>\r\n'28307:3774:0:-:0;;;;5:9:-1;2:2;;;27:1;24;17:12;2:2;28307:3774:0;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;12:1:-1;9;2:12;28367:53:0;;;:::i;:::-;;;;;;;;;;;;;;;;;;;\r\n```\r\n\r\n\r\n3.  issue command `:!<sourcemapping.current.source>.source.length` to see the length of source is 27370 which is less than the start in the source map above.\r\n```\r\ndebug(inline_config:0x1c796d1e...)> :!<sourcemapping.current.source>.source.length\r\n27370\r\n```\r\n\r\n\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/12915/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/12915/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1112531352",
    "html_url": "https://github.com/ethereum/solidity/issues/12915#issuecomment-1112531352",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12915",
    "id": 1112531352,
    "node_id": "IC_kwDOAm_5kc5CT-GY",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-28T18:30:00Z",
    "updated_at": "2022-04-28T18:30:44Z",
    "author_association": "MEMBER",
    "body": "We'll need more information to investigate this.\r\n\r\nThe contract that the transaction from https://github.com/trufflesuite/truffle/issues/4616 interacts with is not source verified (neither on etherscan nor on sourcify). Is the source available? If it's just the bytecode then this does not include a source map - where is Truffle getting that source map from?\r\n\r\nBasically, we need the input that makes the compiler produce that invalid source map to get to the root of the problem. With the info given here I'm not even sure that this source map is actually coming from the compiler.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1112531352/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1113328477",
    "html_url": "https://github.com/ethereum/solidity/issues/12915#issuecomment-1113328477",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12915",
    "id": 1113328477,
    "node_id": "IC_kwDOAm_5kc5CXAtd",
    "user": {
      "login": "dongmingh",
      "id": 17034559,
      "node_id": "MDQ6VXNlcjE3MDM0NTU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/17034559?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongmingh",
      "html_url": "https://github.com/dongmingh",
      "followers_url": "https://api.github.com/users/dongmingh/followers",
      "following_url": "https://api.github.com/users/dongmingh/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongmingh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongmingh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongmingh/subscriptions",
      "organizations_url": "https://api.github.com/users/dongmingh/orgs",
      "repos_url": "https://api.github.com/users/dongmingh/repos",
      "events_url": "https://api.github.com/users/dongmingh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongmingh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-29T13:43:55Z",
    "updated_at": "2022-04-29T13:43:55Z",
    "author_association": "NONE",
    "body": "@cameel thanks for looking into this.  The source file is available in [etherscan](https://etherscan.io/address/0x0000000000004946c0e9F43F4Dee607b0eF1fA1c#code#L1). The solc version is  v0.6.8+commit.0bbfe453 and optimization is enabled.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1113328477/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1114007051",
    "html_url": "https://github.com/ethereum/solidity/issues/12915#issuecomment-1114007051",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12915",
    "id": 1114007051,
    "node_id": "IC_kwDOAm_5kc5CZmYL",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-30T15:32:08Z",
    "updated_at": "2022-04-30T15:37:05Z",
    "author_association": "MEMBER",
    "body": "Thanks!\r\n\r\nI investigated this and the reason seems to be that the source that etherscan is presenting is not the exact source that was used to generate the source map that's being shown there. It's a bit shorter. The difference must be in the comments or whitespace since it did not affect the bytecode but only the source map.\r\n\r\nTo check this you can verify the contract manually. Copy the source from etherscan to a file called `ChiToken.sol` and the bytecode to `ChiToken.bin-runtime`, then run:\r\n\r\n```bash\r\ncurl --remote-name https://binaries.soliditylang.org/linux-amd64/solc-linux-amd64-v0.6.8+commit.0bbfe453\r\nchmod +x solc-linux-amd64-v0.6.8+commit.0bbfe453\r\n\r\nmkdir out/\r\n./solc-linux-amd64-v0.6.8+commit.0bbfe453 \\\r\n    ChiToken.sol \\\r\n    --optimize \\\r\n    --bin \\\r\n    --combined-json srcmap-runtime \\\r\n    --output-dir out/\r\n\r\ndiff --color --unified \\\r\n    <(hexdump ChiToken.bin) \\\r\n    <(hexdump out/ChiToken.bin)\r\n```\r\nThe diff shows that this does recreate the bytecode correctly (only the metadata hash at the very end differs). The source maps are different though.\r\n\r\nIf you try to diff them, you'll see that these source maps still have structure that's too similar for it to be just a coincidence. They both seem to match that bytecode. To see that, I recommend passing both through `tr ';' '\\n'` command (which will replace semicolons with newlines to make it diffable) and using some visual diff tool. It clearly shows that there are many numbers that are identical and those that differ are mostly just shifted.\r\n\r\nThe similarity is even greater if you get the source submitted to sourcify.dev: [`ChiToken.sol`](https://repo.sourcify.dev/contracts/partial_match/56/0x0000000000004946c0e9F43F4Dee607b0eF1fA1c/sources/ChiToken.sol). The only difference from the Etherscan source is that it does not have the `Submitted for verification at Etherscan.io` and `Signed raw transaction for chainId` comments so it's much shorter. The map that you get from it is oddly much closer to what etherscan is showing.\r\n\r\nSo the source map is probably correct, just created from a different input. I'm not sure if that's always the case for Etherscan or just some kind of bug in how their system fed that specific contract to the compiler. A workaround would be for Truffle to get the map from the compiler instead of relying on the one provided by Etherscan.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1114007051/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1117041967",
    "html_url": "https://github.com/ethereum/solidity/issues/12915#issuecomment-1117041967",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12915",
    "id": 1117041967,
    "node_id": "IC_kwDOAm_5kc5ClLUv",
    "user": {
      "login": "haltman-at",
      "id": 35589221,
      "node_id": "MDQ6VXNlcjM1NTg5MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/35589221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/haltman-at",
      "html_url": "https://github.com/haltman-at",
      "followers_url": "https://api.github.com/users/haltman-at/followers",
      "following_url": "https://api.github.com/users/haltman-at/following{/other_user}",
      "gists_url": "https://api.github.com/users/haltman-at/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/haltman-at/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/haltman-at/subscriptions",
      "organizations_url": "https://api.github.com/users/haltman-at/orgs",
      "repos_url": "https://api.github.com/users/haltman-at/repos",
      "events_url": "https://api.github.com/users/haltman-at/events{/privacy}",
      "received_events_url": "https://api.github.com/users/haltman-at/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-04T08:15:26Z",
    "updated_at": "2022-05-04T08:15:26Z",
    "author_association": "CONTRIBUTOR",
    "body": "Jumping in briefly to provide some clarity here, since I realize things may not have been presented in an entirely clear manner here -- there definitely is a compiler issue here (although whether it's still present in current versions, who knows, given that so far we've only reproduced it on 0.6.x).  It's true that the source we compile isn't exactly the same as the source downloaded from Etherscan, but that's irrelevant (or at least, it's irrelevant to the question of whether there's a compiler issue; it's certainly relevant to the question of reproducing it).\r\n\r\nThe reason it's irrelevant is that, while we download the source from Etherscan, we do not download the sourcemap from Etherscan.  Rather, we compile the downloaded source and use the source maps output by the compiler.  We do this precisely to avoid any potential mismatches.  So, it is not possible that the source map is correct but for a different input, because we are getting it directly from the compilation of the input, not downloaded separately from Etherscan.\r\n\r\nThat does leave the problem of reproducing it in a manner not dependent on our tools.  Obviously this is possible -- in the worst case, we could just hand you a standard JSON input file that exhibits the problem -- but I was hoping for something more convenient.  Annoyingly my attempts at more convenient repro haven't worked out so far, but @dongmingh says he was able to recently able to confirm the problem via the standard JSON approach, so, uh, we ought to have something for you soon that demonstrates that there is a real compiler issue here (or was, anyway; that still leaves the question of whether it still exists in current versions).\r\n\r\nBtw, if you're wondering how exactly the source we compile might differ from the source submitted to Etherscan -- not that it's relevant, but if you're wondering:\r\n1. For single-source cases (like this one), we do include a date header comment header, but, because we don't have a good way to get the date, we just use \"20XX-XX-XX\" in place of a more specific date.\r\n2. Any linebreaks in the source we compile will be Windows-style linebreaks... except the ones in the date header, which will be system-style.\r\n\r\nThose should be the only two differences.  Also, IIRC, in the case where the source map pointed past the end, it pointed *way* past the end, so even if we *were* using the wrong source map I don't think that would be sufficient to explain the discrepancy (although I'm going by memory here so it's possible I'm mistaken).",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1117041967/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1138154239",
    "html_url": "https://github.com/ethereum/solidity/issues/12915#issuecomment-1138154239",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12915",
    "id": 1138154239,
    "node_id": "IC_kwDOAm_5kc5D1tr_",
    "user": {
      "login": "haltman-at",
      "id": 35589221,
      "node_id": "MDQ6VXNlcjM1NTg5MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/35589221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/haltman-at",
      "html_url": "https://github.com/haltman-at",
      "followers_url": "https://api.github.com/users/haltman-at/followers",
      "following_url": "https://api.github.com/users/haltman-at/following{/other_user}",
      "gists_url": "https://api.github.com/users/haltman-at/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/haltman-at/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/haltman-at/subscriptions",
      "organizations_url": "https://api.github.com/users/haltman-at/orgs",
      "repos_url": "https://api.github.com/users/haltman-at/repos",
      "events_url": "https://api.github.com/users/haltman-at/events{/privacy}",
      "received_events_url": "https://api.github.com/users/haltman-at/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-26T04:58:04Z",
    "updated_at": "2022-05-26T04:58:04Z",
    "author_association": "CONTRIBUTOR",
    "body": "OK, sorry about taking a while to get back to this.  I've put up a gist [here](https://gist.github.com/haltman-at/9c61763ee78c2ebf717f1a3b9e050441) with the exact standard JSON input that's causing the problem; I just had Truffle log the exact string it's sending to the compiler.  I'm pretty confused about why I've been unable to reproduce this any other way.  Apologies for how inconvenient and non-minimal this example is, not to mention what an old compiler version it's on; but so far I've been utterly unable to reproduce this any other way.  Hoping this is helpful all the same.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1138154239/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
