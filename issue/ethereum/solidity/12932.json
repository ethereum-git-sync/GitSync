{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/12932",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/12932/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/12932/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/12932/events",
  "html_url": "https://github.com/ethereum/solidity/issues/12932",
  "id": 1203317227,
  "node_id": "I_kwDOAm_5kc5HuSnr",
  "number": 12932,
  "title": "Error: `Definition of base has to precede definition of derived contract` when specific file in standard-json-input `outputSelection` but works when `outputSelection` file is specific",
  "user": {
    "login": "kuzdogan",
    "id": 13069972,
    "node_id": "MDQ6VXNlcjEzMDY5OTcy",
    "avatar_url": "https://avatars.githubusercontent.com/u/13069972?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kuzdogan",
    "html_url": "https://github.com/kuzdogan",
    "followers_url": "https://api.github.com/users/kuzdogan/followers",
    "following_url": "https://api.github.com/users/kuzdogan/following{/other_user}",
    "gists_url": "https://api.github.com/users/kuzdogan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kuzdogan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kuzdogan/subscriptions",
    "organizations_url": "https://api.github.com/users/kuzdogan/orgs",
    "repos_url": "https://api.github.com/users/kuzdogan/repos",
    "events_url": "https://api.github.com/users/kuzdogan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kuzdogan/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 249074435,
      "node_id": "MDU6TGFiZWwyNDkwNzQ0MzU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/bug%20:bug:",
      "name": "bug :bug:",
      "color": "fc1313",
      "default": false,
      "description": ""
    },
    {
      "id": 2376134343,
      "node_id": "MDU6TGFiZWwyMzc2MTM0MzQz",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/should%20compile%20without%20error",
      "name": "should compile without error",
      "color": "c48f13",
      "default": false,
      "description": "Error is reported even though it shouldn't. Source is fine."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "wechman",
    "id": 37188783,
    "node_id": "MDQ6VXNlcjM3MTg4Nzgz",
    "avatar_url": "https://avatars.githubusercontent.com/u/37188783?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wechman",
    "html_url": "https://github.com/wechman",
    "followers_url": "https://api.github.com/users/wechman/followers",
    "following_url": "https://api.github.com/users/wechman/following{/other_user}",
    "gists_url": "https://api.github.com/users/wechman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wechman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wechman/subscriptions",
    "organizations_url": "https://api.github.com/users/wechman/orgs",
    "repos_url": "https://api.github.com/users/wechman/repos",
    "events_url": "https://api.github.com/users/wechman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wechman/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "wechman",
      "id": 37188783,
      "node_id": "MDQ6VXNlcjM3MTg4Nzgz",
      "avatar_url": "https://avatars.githubusercontent.com/u/37188783?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wechman",
      "html_url": "https://github.com/wechman",
      "followers_url": "https://api.github.com/users/wechman/followers",
      "following_url": "https://api.github.com/users/wechman/following{/other_user}",
      "gists_url": "https://api.github.com/users/wechman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wechman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wechman/subscriptions",
      "organizations_url": "https://api.github.com/users/wechman/orgs",
      "repos_url": "https://api.github.com/users/wechman/repos",
      "events_url": "https://api.github.com/users/wechman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wechman/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-04-13T13:38:41Z",
  "updated_at": "2022-09-20T14:15:56Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWhen compiling with the specific file in the standard-json-input's `outputSelection` field, the compiler throws the error `Definition of base has to precede definition of derived contract` but when the files in the `outputSelection` is given as `\"*\"` the compiler compiles successfully. \r\n\r\nNoticed this as the [Sourcify](https://github.com/ethereum/sourcify) recompiler targets the specific file and output in the generated json-input and couldn't compile but the user was able to compile and deploy the contract via Hardhat (which has `\"*\"` in `outputSelection`.) \r\n\r\nI'd say the error is correct since according to the order of importing the definition of the base contract is below the inheriting contract, as suggested by the error. Nevertheless a change in the `outputSelection` should not be effecting how the compiler behaves.\r\n\r\nthis `outputSelection` throws:\r\n```json\r\n  \"settings\": {\r\n    \"evmVersion\": \"london\",\r\n    \"libraries\": { \"\": {} },\r\n    \"metadata\": { \"bytecodeHash\": \"ipfs\" },\r\n    \"optimizer\": { \"enabled\": true, \"runs\": 200 },\r\n    \"remappings\": [],\r\n    \"outputSelection\": {\r\n      \"contracts/teleporteth/contracts/TeleportTokenFactory.sol\": {\r\n        \"TeleportTokenFactory\": [\r\n          \"evm.bytecode.object\",\r\n          \"evm.deployedBytecode.object\",\r\n          \"metadata\"\r\n        ]\r\n      }\r\n    }\r\n  }\r\n```\r\nwhile this compiles:\r\n```json\r\n  \"settings\": {\r\n    \"evmVersion\": \"london\",\r\n    \"libraries\": { \"\": {} },\r\n    \"metadata\": { \"bytecodeHash\": \"ipfs\" },\r\n    \"optimizer\": { \"enabled\": true, \"runs\": 200 },\r\n    \"remappings\": [],\r\n    \"outputSelection\": {\r\n      \"*\": { // <-- diff\r\n        \"TeleportTokenFactory\": [\r\n          \"evm.bytecode.object\",\r\n          \"evm.deployedBytecode.object\",\r\n          \"metadata\"\r\n        ]\r\n      }\r\n    }\r\n  }\r\n```\r\n\r\n\r\n## Environment\r\n\r\n- Compiler version: 0.8.7 (originally), also tried 0.8.13\r\n- Target EVM version (as per compiler settings): london\r\n- Framework/IDE (e.g. Truffle or Remix): solc \r\n- EVM execution environment / backend / blockchain client:\r\n- Operating system: Ubuntu 20.04\r\n\r\n## Steps to Reproduce\r\nI am adding the full standard-json-input files with just the diff in the `outputSelection`. Also adding the `.sol` files for reference.\r\n[compiles-with-asterisk.json.txt](https://github.com/ethereum/solidity/files/8481863/compiles-with-asterisk.json.txt)\r\n[error-specific-file.json.txt](https://github.com/ethereum/solidity/files/8481865/error-specific-file.json.txt)\r\n[TeleportToken.sol.txt](https://github.com/ethereum/solidity/files/8481879/TeleportToken.sol.txt)\r\n[TeleportTokenFactory.sol.txt](https://github.com/ethereum/solidity/files/8481880/TeleportTokenFactory.sol.txt)\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/12932/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/12932/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1246345198",
    "html_url": "https://github.com/ethereum/solidity/issues/12932#issuecomment-1246345198",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12932",
    "id": 1246345198,
    "node_id": "IC_kwDOAm_5kc5KSbfu",
    "user": {
      "login": "wechman",
      "id": 37188783,
      "node_id": "MDQ6VXNlcjM3MTg4Nzgz",
      "avatar_url": "https://avatars.githubusercontent.com/u/37188783?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wechman",
      "html_url": "https://github.com/wechman",
      "followers_url": "https://api.github.com/users/wechman/followers",
      "following_url": "https://api.github.com/users/wechman/following{/other_user}",
      "gists_url": "https://api.github.com/users/wechman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wechman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wechman/subscriptions",
      "organizations_url": "https://api.github.com/users/wechman/orgs",
      "repos_url": "https://api.github.com/users/wechman/repos",
      "events_url": "https://api.github.com/users/wechman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wechman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-14T07:15:15Z",
    "updated_at": "2022-09-15T12:02:07Z",
    "author_association": "MEMBER",
    "body": "I have extracted minimal code that lets to reproduce the issue:\r\n```\r\n{\r\n    \"language\": \"Solidity\",\r\n    \"settings\": {\r\n        \"outputSelection\": {\r\n            \"fileB.sol\": {\r\n                \"B\": [\r\n                    \"abi\"\r\n                ]\r\n            }\r\n        }\r\n    },\r\n    \"sources\": {\r\n        \"fileA.sol\": {\r\n            \"content\": \"\r\n                pragma solidity ^0.8.6;\r\n                // SPDX-License-Identifier: MIT\r\n                import \\\"./fileB.sol\\\";\r\n                contract A is BaseA {}\r\n            \"\r\n        },\r\n        \"fileB.sol\": {\r\n            \"content\": \"\r\n                pragma solidity ^0.8.6;\r\n                // SPDX-License-Identifier: MIT\r\n                import \\\"./fileA.sol\\\";\r\n                contract BaseA {}\r\n                contract B {}\r\n            \"\r\n        }\r\n    }\r\n}\r\n```\r\nThe interesting thing about the above code is it can be compiled seamlessly after renaming source file names (`fileA.sol`->` fileB.sol` and `fileB.sol`->`fileA.sol`). The thing is, an order of type and name resolving ([NameAndTypeResolver::resolveNamesAndTypesInternal](https://github.com/ethereum/solidity/blob/develop/libsolidity/analysis/NameAndTypeResolver.cpp#L278)) depends on the source file analysis order ([CompilerStack::analyze](https://github.com/ethereum/solidity/blob/develop/libsolidity/interface/CompilerStack.cpp#L459)), which in turn depends on [CompilerStack::resolveImports](https://github.com/ethereum/solidity/blob/develop/libsolidity/interface/CompilerStack.cpp#L1179). The latter takes `std::map` container with source files and sort them based on file relations and `outputSelection`. In case of circular imports, the determining factors are file names, `std::map` container implementation and `outputSelection`. Whenever `fileA.sol` from above  example is ordered before `fileB.sol` compilation ends with errors. This is why file renaming and `outputSelection` both have an impact on compilation result.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1246345198/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1248032377",
    "html_url": "https://github.com/ethereum/solidity/issues/12932#issuecomment-1248032377",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12932",
    "id": 1248032377,
    "node_id": "IC_kwDOAm_5kc5KY3Z5",
    "user": {
      "login": "wechman",
      "id": 37188783,
      "node_id": "MDQ6VXNlcjM3MTg4Nzgz",
      "avatar_url": "https://avatars.githubusercontent.com/u/37188783?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wechman",
      "html_url": "https://github.com/wechman",
      "followers_url": "https://api.github.com/users/wechman/followers",
      "following_url": "https://api.github.com/users/wechman/following{/other_user}",
      "gists_url": "https://api.github.com/users/wechman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wechman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wechman/subscriptions",
      "organizations_url": "https://api.github.com/users/wechman/orgs",
      "repos_url": "https://api.github.com/users/wechman/repos",
      "events_url": "https://api.github.com/users/wechman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wechman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-15T12:26:10Z",
    "updated_at": "2022-09-15T12:26:10Z",
    "author_association": "MEMBER",
    "body": "The proper way to deal with this issue would be to make `NameAndTypeResolver` robust against bases being defined only after inheriting contracts and then only later validate that all inheritance is sane. Presently, we work on a similar mechanism for the sake of compile-time-constant expression evaluation, which will need the `TypeChecker` to be robust against out-of-order execution. Issues: #13365, #13318. We decided to postpone this ticket until `TypeChecker` changes are delivered so we could try to use the same mechanism here.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1248032377/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
