{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/12944",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/12944/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/12944/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/12944/events",
  "html_url": "https://github.com/ethereum/solidity/issues/12944",
  "id": 1207367588,
  "node_id": "I_kwDOAm_5kc5H9vek",
  "number": 12944,
  "title": "Allow for unchecked function pointer jumps",
  "user": {
    "login": "brockelmore",
    "id": 31553173,
    "node_id": "MDQ6VXNlcjMxNTUzMTcz",
    "avatar_url": "https://avatars.githubusercontent.com/u/31553173?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/brockelmore",
    "html_url": "https://github.com/brockelmore",
    "followers_url": "https://api.github.com/users/brockelmore/followers",
    "following_url": "https://api.github.com/users/brockelmore/following{/other_user}",
    "gists_url": "https://api.github.com/users/brockelmore/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/brockelmore/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brockelmore/subscriptions",
    "organizations_url": "https://api.github.com/users/brockelmore/orgs",
    "repos_url": "https://api.github.com/users/brockelmore/repos",
    "events_url": "https://api.github.com/users/brockelmore/events{/privacy}",
    "received_events_url": "https://api.github.com/users/brockelmore/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 785717317,
      "node_id": "MDU6TGFiZWw3ODU3MTczMTc=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/language%20design%20:rage4:",
      "name": "language design :rage4:",
      "color": "9d76d3",
      "default": false,
      "description": "Any changes to the language, e.g. new features"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-04-18T19:24:05Z",
  "updated_at": "2022-08-17T13:48:54Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Abstract\r\nWith `viaIR` & `0.8.13`, there is an internal function dispatcher. This is quite the hefty gas overhead without anyway to breakout of it to do unchecked internal function calls. \r\n\r\n## Motivation\r\n\r\nIt would be nice to be able to use the old version of direct jumps via `unchecked` or something in yul, even with `viaIR` enabled.\r\n\r\n## Specification\r\n\r\nOne solution may be something like the following:\r\n\r\n```solidity\r\ncontract T {\r\n\r\n    function intoPtr(function(uint256 a) internal view returns (uint256 b) op) internal pure returns (uint256 ptr) {\r\n        assembly (\"memory-safe\") {\r\n            ptr := op\r\n        }\r\n    }\r\n\r\n    function intoOp(uint256 ptr) internal pure returns (function(uint256 a) internal view returns (uint256 b) op) {\r\n        assembly (\"memory-safe\") {\r\n            op := ptr\r\n        }\r\n    }\r\n\r\n    function addOne(uint256 a) internal pure returns(uint256 b) {\r\n        b = a + 1;\r\n    }\r\n    function exec(uint256 c) public returns (uint256 d) {\r\n        uint256 ptr = intoPtr(addOne);\r\n \r\n        // would not do the internal function dispatch checking.\r\n        unchecked { d = intoOp(ptr)(c); }\r\n    }\r\n}\r\n```\r\n\r\nAlternatively, could do something like:\r\n```solidity\r\ncontract T {\r\n    /// snip ....\r\n    function exec(uint256 c) public returns (uint256 d) {\r\n        uint256 ptr = intoPtr(addOne);\r\n \r\n        // would not do the internal function dispatch checking.\r\n        assembly (\"memory-safe\") {\r\n            /// by specifying 1 output, the compiler implies that its a 1-in-1-out stack affecting function\r\n            d := goto(ptr)\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nNote: The change made to restrict function pointers to a known set makes sense, but there is no escape hatch for more optimized usage. The yul approach I think actually makes more sense long term as the optimizer could likely eventually recognize it doesn't need to do the internal function dispatching and can directly jump in certain cases.\r\n\r\nFurther alternative: finally allow `verbatim` in solidity contracts\r\n\r\n## Backwards Compatibility\r\nFully compatible to my knowledge\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/12944/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/12944/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1110123500",
    "html_url": "https://github.com/ethereum/solidity/issues/12944#issuecomment-1110123500",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12944",
    "id": 1110123500,
    "node_id": "IC_kwDOAm_5kc5CKyPs",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-26T18:33:11Z",
    "updated_at": "2022-04-26T18:33:11Z",
    "author_association": "MEMBER",
    "body": "The main reason for having a dispatch function in Yul (rather than direct jumps like in the legacy codegen) is the expectation that the support for dynamic jumps in the EVM will eventually be removed. There's ongoing work on this and at some point we're likely to get some alternative mechanism, e.g. some opcodes for managing jump tables with a set of predefined destinations. Or a new variant of the jump opcode.\r\n\r\nThis is actually a deeper discussion and @chfast, @axic, @ekpyron and @chriseth would probably like to chime in on this. I think that adding the old mechanism back through `unchecked` is unlikely.\r\n\r\nAlso #12650 is a bit related to this.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1110123500/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1112105452",
    "html_url": "https://github.com/ethereum/solidity/issues/12944#issuecomment-1112105452",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12944",
    "id": 1112105452,
    "node_id": "IC_kwDOAm_5kc5CSWHs",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-28T11:45:15Z",
    "updated_at": "2022-04-28T11:45:15Z",
    "author_association": "MEMBER",
    "body": "The reason we do not allow \"goto\" is more that we would otherwise have to remove some optimizations we are currently able to do.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1112105452/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1197841606",
    "html_url": "https://github.com/ethereum/solidity/issues/12944#issuecomment-1197841606",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12944",
    "id": 1197841606,
    "node_id": "IC_kwDOAm_5kc5HZZzG",
    "user": {
      "login": "thedavidmeister",
      "id": 629710,
      "node_id": "MDQ6VXNlcjYyOTcxMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/629710?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thedavidmeister",
      "html_url": "https://github.com/thedavidmeister",
      "followers_url": "https://api.github.com/users/thedavidmeister/followers",
      "following_url": "https://api.github.com/users/thedavidmeister/following{/other_user}",
      "gists_url": "https://api.github.com/users/thedavidmeister/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thedavidmeister/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thedavidmeister/subscriptions",
      "organizations_url": "https://api.github.com/users/thedavidmeister/orgs",
      "repos_url": "https://api.github.com/users/thedavidmeister/repos",
      "events_url": "https://api.github.com/users/thedavidmeister/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thedavidmeister/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-28T08:39:36Z",
    "updated_at": "2022-07-28T08:39:36Z",
    "author_association": "NONE",
    "body": "i _guess_ i'm running into this\r\n\r\ni'm not sure how to check whether i am or not, but my gas costs go up noticeably when i enable viaIR and i make heavy use of calling functions by their pointer, so i assume this is at least contributing\r\n\r\nfor me at least it seems these additional optimizations that @chriseth is pointing to (no pun intended) are less impactful overall than the cost of the slower dispatch\r\n\r\nalso i'd be willing to measure whether this is indeed the gas problem i'm facing with viaIR if i could get some pointers (no pun intended) on how to do that",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1197841606/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
