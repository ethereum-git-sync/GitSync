{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/12951",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/12951/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/12951/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/12951/events",
  "html_url": "https://github.com/ethereum/solidity/issues/12951",
  "id": 1211465920,
  "node_id": "I_kwDOAm_5kc5INYDA",
  "number": 12951,
  "title": "feat: Blackbox code from compiler",
  "user": {
    "login": "brockelmore",
    "id": 31553173,
    "node_id": "MDQ6VXNlcjMxNTUzMTcz",
    "avatar_url": "https://avatars.githubusercontent.com/u/31553173?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/brockelmore",
    "html_url": "https://github.com/brockelmore",
    "followers_url": "https://api.github.com/users/brockelmore/followers",
    "following_url": "https://api.github.com/users/brockelmore/following{/other_user}",
    "gists_url": "https://api.github.com/users/brockelmore/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/brockelmore/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brockelmore/subscriptions",
    "organizations_url": "https://api.github.com/users/brockelmore/orgs",
    "repos_url": "https://api.github.com/users/brockelmore/repos",
    "events_url": "https://api.github.com/users/brockelmore/events{/privacy}",
    "received_events_url": "https://api.github.com/users/brockelmore/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 785717317,
      "node_id": "MDU6TGFiZWw3ODU3MTczMTc=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/language%20design%20:rage4:",
      "name": "language design :rage4:",
      "color": "9d76d3",
      "default": false,
      "description": "Any changes to the language, e.g. new features"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-04-21T19:29:30Z",
  "updated_at": "2022-08-17T13:48:53Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Abstract\r\nAs the compiler gets smarter at inlining, const evaling, and keeping variables around (with stack-to-deep avoidance and the like), there is a growing need to hide/blackbox chunks of code from the compiler for testing and profiling reasons. \r\n\r\n## Motivation\r\n\r\nI am extremely encouraged that I need to make this request. Effectively, the optimizer (especially with `viaIR`) is getting so smart there is a growing need to be able to tell the compiler \"dont touch this\". For example: https://github.com/foundry-rs/foundry/issues/1373\r\n\r\nFoundry allows users to change global variables like block parameters in a test. The issue is the optimizer now is smart enough that later usage of `block.timestamp` is compiled away after the first usage and duped, because in normal circumstances, this is constant throughout a transaction. There have also been times when trying to gas profile a library that under `viaIR`, it gets const evaled (in these tests for example: https://github.com/recmo/experiment-solexp/blob/main/src/test/FixedPointMathLib.t.sol).\r\n\r\n## Specification\r\nBlackboxing would take an expression/code block and not perform any constant evaluation on it or perform optimizations on its output.\r\n\r\nOne option is to add a `blackbox` code block similar to `unchecked` or `assembly` blocks:\r\n```solidity\r\n\r\nfunction t() public returns (uint256 a) {\r\n    blackbox { a = 5 + 5; }\r\n}\r\n```\r\n\r\nThe above would *never* evaluate the function at compile time and would always effectively generate:\r\n```\r\nPUSH1(0x05)\r\nPUSH1(0x05)\r\nADD\r\nPUSH1(0x00)\r\nMSTORE\r\nPUSH1(0x00)\r\nPUSH1(0x20)\r\nRETURN\r\n```\r\n\r\nOr whatever. I am not entirely sure of optimizations that occur on raw bytecode, but if  peephole optimizations may still take place on it, one way you might avoid that is basically just trick the peephole optimizer into thinking its a sort of link reference (i.e. `_$blackboxRef1$_`)? Then as the last step, fill in any references with the associated blackbox opcodes. \r\n\r\n## Backwards Compatibility\r\nWould add a new keyword `blackbox` ",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/12951/reactions",
    "total_count": 7,
    "+1": 5,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 2,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/12951/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1110070190",
    "html_url": "https://github.com/ethereum/solidity/issues/12951#issuecomment-1110070190",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12951",
    "id": 1110070190,
    "node_id": "IC_kwDOAm_5kc5CKlOu",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-26T17:35:05Z",
    "updated_at": "2022-04-26T17:35:05Z",
    "author_association": "MEMBER",
    "body": "This seems related to this earlier issue from @cgewecke and @Ferparishuertas: #10354. That issue is about something else (getting \"stack too deep\" with optimizer disabled) but the underlying use case is very similar - needing to insert some \"instrumentation\" code that should go through the optimizer unmodified - for the purpose of tracking coverage in that specific case.\r\n\r\n@brockelmore Do you need to be able to do this at Solidity level or would compiling first to Yul, then inserting your snippet and finally assembling to bytecode be enough? If it's the latter then I guess [`verbatim`](https://docs.soliditylang.org/en/latest/yul.html#verbatim) could be used as a workaround since the compiler won't optimize verbatim blocks.\r\n\r\n> I am not entirely sure of optimizations that occur on raw bytecode, but if peephole optimizations may still take place on it,\r\n\r\nYeah, there's another optimization pass on EVM assembly after Yul optimizer finishes. It's basically the same optimizer that's used in the legacy non-Yul pipeline. We have fine-grained settings for selecting optimizations done at this stage. You can disable the peephole optimizer by setting `settings.optimizer.details.peephole` to `false` in Standard JSON. Also note that you have to explicitly disable it - it still runs if you just set `settings.optimizer.enabled` to `false` (at least on 0.8.6+, there was a bug related to that earlier, see [Input description](https://docs.soliditylang.org/en/latest/using-the-compiler.html#input-description) for details).",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1110070190/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 1
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1166681503",
    "html_url": "https://github.com/ethereum/solidity/issues/12951#issuecomment-1166681503",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12951",
    "id": 1166681503,
    "node_id": "IC_kwDOAm_5kc5FiiWf",
    "user": {
      "login": "axic",
      "id": 20340,
      "node_id": "MDQ6VXNlcjIwMzQw",
      "avatar_url": "https://avatars.githubusercontent.com/u/20340?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/axic",
      "html_url": "https://github.com/axic",
      "followers_url": "https://api.github.com/users/axic/followers",
      "following_url": "https://api.github.com/users/axic/following{/other_user}",
      "gists_url": "https://api.github.com/users/axic/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/axic/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/axic/subscriptions",
      "organizations_url": "https://api.github.com/users/axic/orgs",
      "repos_url": "https://api.github.com/users/axic/repos",
      "events_url": "https://api.github.com/users/axic/events{/privacy}",
      "received_events_url": "https://api.github.com/users/axic/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-26T23:44:45Z",
    "updated_at": "2022-06-26T23:44:45Z",
    "author_association": "MEMBER",
    "body": "I think this function is really about `verbatim`, given the goal of `blackbox` would be the code remains untouched. One just needs to finish #12067.\r\n\r\n@brockelmore can this be closed or do you think `blackbox` would be useful beyond small snippets accomplishable via `verbatim`?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1166681503/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
