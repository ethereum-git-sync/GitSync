{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/13004",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/13004/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/13004/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/13004/events",
  "html_url": "https://github.com/ethereum/solidity/issues/13004",
  "id": 1231798112,
  "node_id": "I_kwDOAm_5kc5Ja79g",
  "number": 13004,
  "title": "Warn when an arithmetic expression in a common type is implicitly upcast to an even larger type",
  "user": {
    "login": "sseefried",
    "id": 121262,
    "node_id": "MDQ6VXNlcjEyMTI2Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/121262?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/sseefried",
    "html_url": "https://github.com/sseefried",
    "followers_url": "https://api.github.com/users/sseefried/followers",
    "following_url": "https://api.github.com/users/sseefried/following{/other_user}",
    "gists_url": "https://api.github.com/users/sseefried/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/sseefried/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sseefried/subscriptions",
    "organizations_url": "https://api.github.com/users/sseefried/orgs",
    "repos_url": "https://api.github.com/users/sseefried/repos",
    "events_url": "https://api.github.com/users/sseefried/events{/privacy}",
    "received_events_url": "https://api.github.com/users/sseefried/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-05-10T23:13:29Z",
  "updated_at": "2022-05-11T22:31:47Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Page\r\n\r\nNo documentation\r\n\r\n## Abstract\r\n\r\nI recently discovered that literal expressions of the form `n days` seem to get given the type `uint24`. However, I couldn't find any documentation on this and it leads to problems once you try to multiply by a number with smaller precision.\r\n\r\nThe following simple contract highlights this problem\r\n\r\n```sol\r\npragma solidity 0.8.7;\r\n\r\ncontract Test {\r\n\r\n    function r1(uint8 n) public view returns (uint32) {\r\n        return n * 1 day; \r\n    }\r\n\r\n}\r\n```\r\n\r\nIf you compile, deploy and call function `r1` -- I used Remix -- you will find that it reverts because of an arithmetic overflow whenever `n` is in the range `n >= 195` and `n <= 255` (`uint8.max`). \r\n\r\nThis is how I discovered that `1 day` must be assigned the type `uint24`.  Assigning `n = 194` does not cause an overflow but assigning `n = 195` does. This is because `uint24.max = 16777215` and the following two facts are true:\r\n\r\n- `194 * 86400 = 16761600`\r\n- `195 * 86400 = 16848000`\r\n\r\nThe first is slightly less than `uint24.max` and the latter just slightly more.\r\n\r\nWhat I suspect happens is that Solidity sees that we have a `uint8` multiplied by a `uint24` and then upcasts the `uint8` to a `uint24` and then performs the multiplication. Unfortunately `uint24` is just not big enough to hold the result and so we get an arithmetic overflow. \r\n\r\nTry as I might I couldn't find any documentation on this issue anywhere on the web, and I couldn't find any in the Solidity docs either.\r\n\r\nI also ran a debugging session in Remix and stepped, opcode by opcode, through the code and discovered that my casting theory was essentially correct. I saw the opcode `AND` applied to a value and `0xFFFFFF`, which is `uint24.max` several times while stepping through.\r\n\r\nMy question is: is this behaviour by design? It seems reasonable if so, but it needs to be documented. I would be happy to help out with that effort if someone can confirm that what I've found is correct _and_ intended behaviour. \r\n\r\n\r\n## Pull request\r\n\r\nI wanted to check that this was a real, and known issue before submitting a PR. I hope that is okay.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/13004/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/13004/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1123569329",
    "html_url": "https://github.com/ethereum/solidity/issues/13004#issuecomment-1123569329",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13004",
    "id": 1123569329,
    "node_id": "IC_kwDOAm_5kc5C-E6x",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-11T10:51:24Z",
    "updated_at": "2022-05-11T11:27:23Z",
    "author_association": "MEMBER",
    "body": "Thanks for the report. This really looks like a bug. `1 days` is supposed to be a a literal, equivalent to writing `24 * 60 * 60`. If you write\r\n```solidity\r\nuint8 x = 1 days;\r\n```\r\nyou get an error\r\n```\r\nError: Type int_const 86400 is not implicitly convertible to expected type uint8. Literal is too large to fit in uint8.\r\n```\r\nand it's the same exact error you get if you get when using a literal:\r\n```solidity\r\nuint8 x = 1 * 24 * 60 * 60;\r\n```\r\n```\r\nError: Type int_const 86400 is not implicitly convertible to expected type uint8. Literal is too large to fit in uint8.\r\n```\r\nThe analysis clearly does not treat it as an expression of type `uint24` or it would have issued this error instead:\r\n```\r\nError: Type uint24 is not implicitly convertible to expected type uint8.\r\n```\r\n\r\n**EDIT**: The snippet below is wrong. I did not put the `1 * 24 * 60 * 60` part in parentheses. It's not a bug after all. It's consistent with behavior of literals. See my next comment.\r\n<details>\r\n\r\n~I think that the analysis is right and it's the codegen that incorrectly treats is as `uint24`. Combined with `unchecked` it can lead to incorrect calculation results. For example in the code below `f1()` returns 163 while `f2()` returns 2 because the value is calculated within different types.~\r\n\r\n```solidity\r\ncontract Test {\r\n    function f1() public view returns (uint) {\r\n        uint8 n = 195;\r\n        unchecked {\r\n            return (2 * n * 1 days) / (n * 1 days);\r\n        }\r\n    }\r\n\r\n    function f2() public view returns (uint) {\r\n        uint8 n = 195;\r\n        unchecked {\r\n            return (2 * n * 1 * 24 * 60 * 60) / (n * 1 * 24 * 60 * 60);\r\n        }\r\n    }\r\n\r\n    function test() public view {\r\n        assert(f1() == f2());\r\n    }\r\n}\r\n```\r\n\r\n</details>",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1123569329/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1123604363",
    "html_url": "https://github.com/ethereum/solidity/issues/13004#issuecomment-1123604363",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13004",
    "id": 1123604363,
    "node_id": "IC_kwDOAm_5kc5C-NeL",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-11T11:23:41Z",
    "updated_at": "2022-05-11T11:23:41Z",
    "author_association": "MEMBER",
    "body": "After discussing it with @ekpyron looks like I was wrong. This is actually the expected behavior for literals. If you do `n * (1 * 24 * 60 * 60)`, the `1 * 24 * 60 * 60` part is a literal expression but it gets converted to its mobile type before the operation, which is `uint24` in this case. Same happens when you use `1 days` instead.\r\n\r\nSo there's no bug here and the suffixes do not inherently give that value a type but when used in expressions, you need to be aware that operations between such literals and variables are performed in limited precision and the precision depends on the type of the variable and the value of the literal.\r\n\r\nThe problem here is really that the expression is computed in smaller precision than the return type of the function and it may not be immediately clear when looking at it. @ekpyron suggested that perhaps we should warn about such situations and I agree that it would be a good idea:\r\n> Whenever you have an arithmetic expression in a common type that is then implicitly upcast to an even larger type, there is likely something off I guess...\r\n> Might be possible to warn about this and ask for one of the operands to be upcast explicitly...\r\n\r\nWe just need to think carefully about the conditions under which we want this warning to avoid unnecessary false-positives.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1123604363/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1124353590",
    "html_url": "https://github.com/ethereum/solidity/issues/13004#issuecomment-1124353590",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13004",
    "id": 1124353590,
    "node_id": "IC_kwDOAm_5kc5DBEY2",
    "user": {
      "login": "sseefried",
      "id": 121262,
      "node_id": "MDQ6VXNlcjEyMTI2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/121262?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sseefried",
      "html_url": "https://github.com/sseefried",
      "followers_url": "https://api.github.com/users/sseefried/followers",
      "following_url": "https://api.github.com/users/sseefried/following{/other_user}",
      "gists_url": "https://api.github.com/users/sseefried/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sseefried/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sseefried/subscriptions",
      "organizations_url": "https://api.github.com/users/sseefried/orgs",
      "repos_url": "https://api.github.com/users/sseefried/repos",
      "events_url": "https://api.github.com/users/sseefried/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sseefried/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-11T22:31:46Z",
    "updated_at": "2022-05-11T22:31:46Z",
    "author_association": "NONE",
    "body": "@cameel Thanks for your thorough research on the topic. I searched for the term \"mobile type\" in the Solidity docs and found this\r\n\r\n> In case one of the operands is a [literal number](https://docs.soliditylang.org/en/v0.8.12/types.html#rational-literals) it is first converted to its “mobile type”, which is the smallest type that can hold the value (unsigned types of the same bit-width are considered “smaller” than the signed types). If both are literal numbers, the operation is computed with arbitrary precision.\r\n\r\nThis is exactly what I was looking for earlier but failed to find. Thank you for helping me find it.\r\n\r\nI don't think the behaviour I saw in my function `r1` above is incorrect but it is _tricky_. What I was expecting was that the whole expression would be computed with the precision of `uint32`. But when you actually get into the details of how the expression is evaluated, part by part, you see that you need to upcast the `uint8` to a `uint32` to get the intended behaviour. \r\n\r\ne.g.\r\n```sol\r\n    function r1(uint8 n) public view returns (uint32) {\r\n        return uint32(n) * 1 days; \r\n    }\r\n```\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1124353590/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
