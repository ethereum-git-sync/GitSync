{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/13180",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/13180/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/13180/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/13180/events",
  "html_url": "https://github.com/ethereum/solidity/issues/13180",
  "id": 1278075617,
  "node_id": "I_kwDOAm_5kc5MLeLh",
  "number": 13180,
  "title": "[Legacy codegen] Higher order bits not sign-extended in signed integer array in storage that may be accessed via inline assembly",
  "user": {
    "login": "bshastry",
    "id": 2388185,
    "node_id": "MDQ6VXNlcjIzODgxODU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bshastry",
    "html_url": "https://github.com/bshastry",
    "followers_url": "https://api.github.com/users/bshastry/followers",
    "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
    "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
    "organizations_url": "https://api.github.com/users/bshastry/orgs",
    "repos_url": "https://api.github.com/users/bshastry/repos",
    "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bshastry/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 249074435,
      "node_id": "MDU6TGFiZWwyNDkwNzQ0MzU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/bug%20:bug:",
      "name": "bug :bug:",
      "color": "fc1313",
      "default": false,
      "description": ""
    },
    {
      "id": 2376132438,
      "node_id": "MDU6TGFiZWwyMzc2MTMyNDM4",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/codegen%20error",
      "name": "codegen error",
      "color": "000000",
      "default": false,
      "description": "Compiler generates invalid code. Critical."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2022-06-21T08:18:10Z",
  "updated_at": "2022-08-15T11:03:32Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "In the semantic test below, legacy codegen does not sign-extend the second element of the storage array but via-ir does. This may be accessed via inline assembly. Bug similar to https://github.com/ethereum/solidity/pull/12050\r\n\r\nNote that Solidity access is just fine (i.e., sign-extension happens correctly via legacy or IR). Also note that the value returned by the call to `g()` in the test below is via legacy (i.e., the non-sign-extended value).\r\n\r\n```\r\ncontract C0 {\r\n  int192[2]   s3;\r\n  constructor(int192[2] memory i0)   {\r\n    s3 = i0;\r\n  }\r\n  function f() external returns (int192[2] memory o) { o = s3; }\r\n  function g() external returns (uint o) { assembly { o := sload(add(s3.slot, 1)) } }\r\n}\r\n// ====\r\n// compileViaYul: also\r\n// ----\r\n// constructor(): 0x0000000000000000000000000000000000000000000000000000000000000000, 0xFFFFFFFFFFFFFFFFF6F6BEA5083DFED985055AB0D43C9DB425C40FEAC74632E5 ->\r\n// gas irOptimized: 136872\r\n// gas legacy: 179142\r\n// gas legacyOptimized: 135428\r\n// f() -> 0, -221565838963264769260736510461167584867121330438731844891\r\n// g() -> 6055535896423415994575052912746498831235234114025302668005\r\n```",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/13180/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/13180/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1214839500",
    "html_url": "https://github.com/ethereum/solidity/issues/13180#issuecomment-1214839500",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13180",
    "id": 1214839500,
    "node_id": "IC_kwDOAm_5kc5IaPrM",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-15T09:57:46Z",
    "updated_at": "2022-08-15T09:57:46Z",
    "author_association": "MEMBER",
    "body": "Simpler case:\r\n```\r\ncontract C {\r\n  int136[1] s;\r\n  function test() external returns (uint o) {\r\n\ts = [int136(-1)];\r\n\tassembly { o := sload(s.slot) }\r\n  }\r\n}\r\n// ====\r\n// compileViaYul: also\r\n// ----\r\n// test() -> 0xffffffffffffffffffffffffffffffffff\r\n// test() -> -1\r\n```\r\n(the first expectation is legacy, the second via-IR)\r\n\r\nSo the cases are storage arrays in which only a single value is stored per slot (i.e. ``int8`` would have consistent behaviour - and since that's packed, the values in storage cannot be sign-extended at all).\r\n\r\nWhile we should probably document this difference, I think it's basically harmless, given that signextending cleanup is performed on solidity reads.\r\n\r\nHowever, a second pair of eyes on this may be nice to see, if anyone can come up with a case in which this would cause actual issues.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1214839500/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1214867664",
    "html_url": "https://github.com/ethereum/solidity/issues/13180#issuecomment-1214867664",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13180",
    "id": 1214867664,
    "node_id": "IC_kwDOAm_5kc5IaWjQ",
    "user": {
      "login": "bshastry",
      "id": 2388185,
      "node_id": "MDQ6VXNlcjIzODgxODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bshastry",
      "html_url": "https://github.com/bshastry",
      "followers_url": "https://api.github.com/users/bshastry/followers",
      "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
      "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
      "organizations_url": "https://api.github.com/users/bshastry/orgs",
      "repos_url": "https://api.github.com/users/bshastry/repos",
      "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bshastry/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-15T10:31:24Z",
    "updated_at": "2022-08-15T10:31:24Z",
    "author_association": "MEMBER",
    "body": "> So the cases are storage arrays in which only a single value is stored per slot\r\n\r\nAh I see, this would mean cases where bit width is `> 128`.\r\n\r\n> I think it's basically harmless, given that signextending cleanup is performed on solidity reads.\r\n\r\nIsn't this similar to https://github.com/ethereum/solidity/blob/7e7c68e5bf910b12ee9326dd34926c61261a4a71/test/libsolidity/semanticTests/immutable/immutable_signed.sol#L5-L9\r\n\r\nIs non cleaned up value that is only accessible via inline assembly okay?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1214867664/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1214872881",
    "html_url": "https://github.com/ethereum/solidity/issues/13180#issuecomment-1214872881",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13180",
    "id": 1214872881,
    "node_id": "IC_kwDOAm_5kc5IaX0x",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-15T10:38:55Z",
    "updated_at": "2022-08-15T10:38:55Z",
    "author_association": "MEMBER",
    "body": "It's borderline and will probably require some thought on a case-by-case basis...\r\nFor storage, in a sense, the \"default\" is actually *not* to sign-extend smaller types, due to the packed layout for ``<= 128`` bytes types...\r\nI'd myself also not necessarily have considered the immutable case an \"important bug\", so that was also at least borderline.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1214872881/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1214873050",
    "html_url": "https://github.com/ethereum/solidity/issues/13180#issuecomment-1214873050",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13180",
    "id": 1214873050,
    "node_id": "IC_kwDOAm_5kc5IaX3a",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-15T10:39:10Z",
    "updated_at": "2022-08-15T10:39:10Z",
    "author_association": "MEMBER",
    "body": "But yeah, I'd be happy about more opinions on this.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1214873050/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1214880274",
    "html_url": "https://github.com/ethereum/solidity/issues/13180#issuecomment-1214880274",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13180",
    "id": 1214880274,
    "node_id": "IC_kwDOAm_5kc5IaZoS",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-15T10:49:43Z",
    "updated_at": "2022-08-15T10:49:43Z",
    "author_association": "MEMBER",
    "body": "I'm staging this for discussion next Wednesday (even though I'm off there, but maybe that results in some more opinions anyways).\r\n\r\nMy current thinking on this would be to (1) document this properly (2) take care of optimizing the Yul optimizer :-) - and (3) drop legacy codegen ;-) - that'd solve the issue eventually :-).\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1214880274/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1214889358",
    "html_url": "https://github.com/ethereum/solidity/issues/13180#issuecomment-1214889358",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13180",
    "id": 1214889358,
    "node_id": "IC_kwDOAm_5kc5Iab2O",
    "user": {
      "login": "bshastry",
      "id": 2388185,
      "node_id": "MDQ6VXNlcjIzODgxODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bshastry",
      "html_url": "https://github.com/bshastry",
      "followers_url": "https://api.github.com/users/bshastry/followers",
      "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
      "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
      "organizations_url": "https://api.github.com/users/bshastry/orgs",
      "repos_url": "https://api.github.com/users/bshastry/repos",
      "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bshastry/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-15T11:03:32Z",
    "updated_at": "2022-08-15T11:03:32Z",
    "author_association": "MEMBER",
    "body": "My two cents: If the test case does not really affect real-world contracts, it is safe to just document this properly and eventually not have to care about it when we deprecate legacy codegen. OTOH, if there is no way of finding out real-world impact and there is a small possibility that there may be an impact, I would tend to just be consistent with the other linked bug (signed immutables) and mark it a low-priority bug.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1214889358/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
