{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/13201",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/13201/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/13201/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/13201/events",
  "html_url": "https://github.com/ethereum/solidity/issues/13201",
  "id": 1282407523,
  "node_id": "I_kwDOAm_5kc5Mb_xj",
  "number": 13201,
  "title": "Improve DataFlowAnalyzer's performance",
  "user": {
    "login": "leonardoalt",
    "id": 504195,
    "node_id": "MDQ6VXNlcjUwNDE5NQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/504195?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/leonardoalt",
    "html_url": "https://github.com/leonardoalt",
    "followers_url": "https://api.github.com/users/leonardoalt/followers",
    "following_url": "https://api.github.com/users/leonardoalt/following{/other_user}",
    "gists_url": "https://api.github.com/users/leonardoalt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/leonardoalt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/leonardoalt/subscriptions",
    "organizations_url": "https://api.github.com/users/leonardoalt/orgs",
    "repos_url": "https://api.github.com/users/leonardoalt/repos",
    "events_url": "https://api.github.com/users/leonardoalt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/leonardoalt/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 682993385,
      "node_id": "MDU6TGFiZWw2ODI5OTMzODU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/performance%20:racehorse:",
      "name": "performance :racehorse:",
      "color": "c5def5",
      "default": false,
      "description": ""
    },
    {
      "id": 1282209978,
      "node_id": "MDU6TGFiZWwxMjgyMjA5OTc4",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/optimizer",
      "name": "optimizer",
      "color": "d4c5f9",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2022-06-23T13:26:52Z",
  "updated_at": "2022-08-17T13:48:46Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "- [ ] Check if the call to `SyntacticallyEqual::operator()` can be made more efficienty\r\n- [ ]  Check `yul::valueOfNumberLiteral` (cache it)\r\n- [ ]  In `DataFlowAnalyzer`, don't always use `m_memory` (check whether the derived class needs it). CSE might be fine without it - implemented in https://github.com/ethereum/solidity/pull/13261\r\n\r\nTaken from a 0.8.15 profiling:\r\n\r\n![image](https://user-images.githubusercontent.com/504195/175310027-640d860c-a14f-4a63-a456-e5305f8a82d5.png)\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/13201/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/13201/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1164419179",
    "html_url": "https://github.com/ethereum/solidity/issues/13201#issuecomment-1164419179",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13201",
    "id": 1164419179,
    "node_id": "IC_kwDOAm_5kc5FZ6Br",
    "user": {
      "login": "hrkrshnn",
      "id": 13174375,
      "node_id": "MDQ6VXNlcjEzMTc0Mzc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/13174375?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hrkrshnn",
      "html_url": "https://github.com/hrkrshnn",
      "followers_url": "https://api.github.com/users/hrkrshnn/followers",
      "following_url": "https://api.github.com/users/hrkrshnn/following{/other_user}",
      "gists_url": "https://api.github.com/users/hrkrshnn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hrkrshnn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hrkrshnn/subscriptions",
      "organizations_url": "https://api.github.com/users/hrkrshnn/orgs",
      "repos_url": "https://api.github.com/users/hrkrshnn/repos",
      "events_url": "https://api.github.com/users/hrkrshnn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hrkrshnn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-23T13:37:19Z",
    "updated_at": "2022-06-23T13:37:19Z",
    "author_association": "MEMBER",
    "body": "Perhaps also https://github.com/ethereum/solidity/blob/70ca05fd739b2423636d510e3e7dca5a59ffbefd/libyul/optimiser/CommonSubexpressionEliminator.cpp#L108 ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1164419179/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1164421045",
    "html_url": "https://github.com/ethereum/solidity/issues/13201#issuecomment-1164421045",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13201",
    "id": 1164421045,
    "node_id": "IC_kwDOAm_5kc5FZ6e1",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-23T13:39:07Z",
    "updated_at": "2022-06-23T13:39:07Z",
    "author_association": "MEMBER",
    "body": "Yep, that's exactly it.\r\nSo it looks like for CSE we should disable m_memory and m_storage in DataFlowAnalyzer and we should use a more efficient data structure for the search inline 108.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1164421045/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1180461644",
    "html_url": "https://github.com/ethereum/solidity/issues/13201#issuecomment-1180461644",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13201",
    "id": 1180461644,
    "node_id": "IC_kwDOAm_5kc5GXGpM",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-11T14:11:58Z",
    "updated_at": "2022-07-11T14:11:58Z",
    "author_association": "MEMBER",
    "body": "@leonardoalt do you still have the original input for the profiler run here?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1180461644/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1200106379",
    "html_url": "https://github.com/ethereum/solidity/issues/13201#issuecomment-1200106379",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13201",
    "id": 1200106379,
    "node_id": "IC_kwDOAm_5kc5HiCuL",
    "user": {
      "login": "StrongerXi",
      "id": 26714592,
      "node_id": "MDQ6VXNlcjI2NzE0NTky",
      "avatar_url": "https://avatars.githubusercontent.com/u/26714592?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/StrongerXi",
      "html_url": "https://github.com/StrongerXi",
      "followers_url": "https://api.github.com/users/StrongerXi/followers",
      "following_url": "https://api.github.com/users/StrongerXi/following{/other_user}",
      "gists_url": "https://api.github.com/users/StrongerXi/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/StrongerXi/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/StrongerXi/subscriptions",
      "organizations_url": "https://api.github.com/users/StrongerXi/orgs",
      "repos_url": "https://api.github.com/users/StrongerXi/repos",
      "events_url": "https://api.github.com/users/StrongerXi/events{/privacy}",
      "received_events_url": "https://api.github.com/users/StrongerXi/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-30T07:08:58Z",
    "updated_at": "2022-07-30T07:08:58Z",
    "author_association": "CONTRIBUTOR",
    "body": "@leonardoalt could you provide a repro for the profiler run? I'd love to take a jab at this.\r\n\r\nA few questions:\r\n\r\n1. Why aren't nested function call expressions unnested -- design choice, or legacy? It could've enabled more CSE for nested expressions, e.g.,\r\n```solidity\r\n        let expr_9 := checked_add_int256(convert_rational_by_to_int256(expr_7), var_a_2)\r\n        // ...\r\n        let expr_15 := checked_add_int256(expr_9, convert_rational_by_to_int256(expr_7))\r\n```\r\nRegardless, it might be worth to support such nested CSE (by looking up such nested/unnamed values & replacing them with newly inserted variable definitions). I uncovered this pattern from a very simple program:\r\n\r\n```solidity\r\ncontract C {\r\n    function foo(int a) pure public {\r\n        int a = 2 + a;\r\n        int b = a + 2;\r\n        int c = a * b;\r\n        int d = a * b;\r\n    }\r\n}\r\n```\r\n\r\n2. For the commented inefficient search, any thoughts on using value numbering (simple hash) to look up variable by syntactic value? We could potentially also cache `valueOfNumberLiteral` in the `SyntacticallyEqual` object, and reuse this object in the comparator for the `unordered_map`.\r\n\r\n3. For the same program from (1), any thoughts on supporting CSE for commutative algebraic ops? Should be pretty easy to implement with (2).\r\n\r\n4. Is it really worth looking up values for literals (Number, Boolean, String)? Is it to avoid redundant string alloc? I can't seem to make a program that shows this.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1200106379/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1200501247",
    "html_url": "https://github.com/ethereum/solidity/issues/13201#issuecomment-1200501247",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13201",
    "id": 1200501247,
    "node_id": "IC_kwDOAm_5kc5HjjH_",
    "user": {
      "login": "hrkrshnn",
      "id": 13174375,
      "node_id": "MDQ6VXNlcjEzMTc0Mzc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/13174375?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hrkrshnn",
      "html_url": "https://github.com/hrkrshnn",
      "followers_url": "https://api.github.com/users/hrkrshnn/followers",
      "following_url": "https://api.github.com/users/hrkrshnn/following{/other_user}",
      "gists_url": "https://api.github.com/users/hrkrshnn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hrkrshnn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hrkrshnn/subscriptions",
      "organizations_url": "https://api.github.com/users/hrkrshnn/orgs",
      "repos_url": "https://api.github.com/users/hrkrshnn/repos",
      "events_url": "https://api.github.com/users/hrkrshnn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hrkrshnn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-31T21:11:32Z",
    "updated_at": "2022-08-01T00:08:26Z",
    "author_association": "MEMBER",
    "body": "> Why aren't nested function call expressions unnested -- design choice, or legacy? It could've enabled more CSE for nested expressions, e.g.,\r\n\r\n@StrongerXi They will get \"unnested\" by the `ExpressionSplitter`. The `ExpressionJoiner` would invert the operation. But it's a good question on how often this should be applied. You can look at https://github.com/ethereum/solidity/blob/d5a78b18b3fd9e54b2839e9685127c6cdbddf614/libyul/optimiser/Suite.cpp#L254 and https://github.com/ethereum/solidity/blob/d5a78b18b3fd9e54b2839e9685127c6cdbddf614/libsolidity/interface/OptimiserSettings.h#L44 on how it's being used.\r\n\r\n> For the commented inefficient search, any thoughts on using value numbering (simple hash) to look up variable by syntactic value?\r\n\r\nSounds good. Would be nice to benchmark this change, and we'd accept this if it can improve the performance.\r\n\r\n> For the same program from (1), any thoughts on supporting CSE for commutative algebraic ops? Should be pretty easy to implement with (2).\r\n\r\nAgain, sounds good. For commutativity, we have mostly been relying on https://github.com/ethereum/solidity/blob/develop/libevmasm/RuleList.h. If your proposal improves the performance of the optimizer or optimizes more code, we'd be happy to merge it.\r\n\r\n> Is it really worth looking up values for literals (Number, Boolean, String)? Is it to avoid redundant string alloc? I can't seem to make a program that shows this.\r\n\r\nAlso sounds good. I also found all the string manipulation a bit awkward. Maybe you can have a Yul dialect that only has number literals (u256) and perform all operations there.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1200501247/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1200947608",
    "html_url": "https://github.com/ethereum/solidity/issues/13201#issuecomment-1200947608",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13201",
    "id": 1200947608,
    "node_id": "IC_kwDOAm_5kc5HlQGY",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-01T09:24:39Z",
    "updated_at": "2022-08-01T09:24:39Z",
    "author_association": "MEMBER",
    "body": "Thanks for your suggestions, they all sound good! I'm not sure if we are currently doing CSE for calls to user-defined functions. We did some work on extending the side-effects structure also to user-defined functions, so it might already be there, but could also be in an \"almost finished\" open pull request :)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1200947608/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
