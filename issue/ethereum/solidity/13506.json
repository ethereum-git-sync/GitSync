{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/13506",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/13506/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/13506/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/13506/events",
  "html_url": "https://github.com/ethereum/solidity/issues/13506",
  "id": 1366769621,
  "node_id": "I_kwDOAm_5kc5Rdz_V",
  "number": 13506,
  "title": "Nightly builds in solc-bin broken due to git's `safe.directory` check",
  "user": {
    "login": "cameel",
    "id": 137030,
    "node_id": "MDQ6VXNlcjEzNzAzMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cameel",
    "html_url": "https://github.com/cameel",
    "followers_url": "https://api.github.com/users/cameel/followers",
    "following_url": "https://api.github.com/users/cameel/following{/other_user}",
    "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
    "organizations_url": "https://api.github.com/users/cameel/orgs",
    "repos_url": "https://api.github.com/users/cameel/repos",
    "events_url": "https://api.github.com/users/cameel/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cameel/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 249074435,
      "node_id": "MDU6TGFiZWwyNDkwNzQ0MzU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/bug%20:bug:",
      "name": "bug :bug:",
      "color": "fc1313",
      "default": false,
      "description": ""
    },
    {
      "id": 2685863294,
      "node_id": "MDU6TGFiZWwyNjg1ODYzMjk0",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/solc-bin",
      "name": "solc-bin",
      "color": "3B8CF5",
      "default": false,
      "description": ""
    },
    {
      "id": 4438006499,
      "node_id": "LA_kwDOAm_5kc8AAAABCIaa4w",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/low%20effort",
      "name": "low effort",
      "color": "ffb1fa",
      "default": false,
      "description": "There is not much implementation work to be done. The task is very easy or tiny."
    },
    {
      "id": 4438155599,
      "node_id": "LA_kwDOAm_5kc8AAAABCIjhTw",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/medium%20impact",
      "name": "medium impact",
      "color": "314aff",
      "default": false,
      "description": "Default level of impact"
    },
    {
      "id": 4438488423,
      "node_id": "LA_kwDOAm_5kc8AAAABCI31Zw",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/must%20have",
      "name": "must have",
      "color": "ffa12a",
      "default": false,
      "description": "Something we consider an essential part of Solidity 1.0."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "r0qs",
    "id": 457348,
    "node_id": "MDQ6VXNlcjQ1NzM0OA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/457348?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/r0qs",
    "html_url": "https://github.com/r0qs",
    "followers_url": "https://api.github.com/users/r0qs/followers",
    "following_url": "https://api.github.com/users/r0qs/following{/other_user}",
    "gists_url": "https://api.github.com/users/r0qs/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/r0qs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/r0qs/subscriptions",
    "organizations_url": "https://api.github.com/users/r0qs/orgs",
    "repos_url": "https://api.github.com/users/r0qs/repos",
    "events_url": "https://api.github.com/users/r0qs/events{/privacy}",
    "received_events_url": "https://api.github.com/users/r0qs/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "r0qs",
      "id": 457348,
      "node_id": "MDQ6VXNlcjQ1NzM0OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/457348?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/r0qs",
      "html_url": "https://github.com/r0qs",
      "followers_url": "https://api.github.com/users/r0qs/followers",
      "following_url": "https://api.github.com/users/r0qs/following{/other_user}",
      "gists_url": "https://api.github.com/users/r0qs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/r0qs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/r0qs/subscriptions",
      "organizations_url": "https://api.github.com/users/r0qs/orgs",
      "repos_url": "https://api.github.com/users/r0qs/repos",
      "events_url": "https://api.github.com/users/r0qs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/r0qs/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2022-09-08T17:59:33Z",
  "updated_at": "2022-09-13T16:38:29Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Nightly builds in solc-bin seem to have been failing for 2 weeks now: [8239563561](https://github.com/ethereum/solc-bin/runs/8239563561).\r\n\r\n```\r\nfatal: detected dubious ownership in repository at '/root/project'\r\nTo add an exception for this directory, call:\r\n\r\n\tgit config --global --add safe.directory /root/project\r\n```\r\n\r\nThis seems to be due to the checks introduced recently by git to address a security vulnerability: [Git security vulnerability announced](https://github.blog/2022-04-12-git-security-vulnerability-announced/).",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/13506/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/13506/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1241667399",
    "html_url": "https://github.com/ethereum/solidity/issues/13506#issuecomment-1241667399",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13506",
    "id": 1241667399,
    "node_id": "IC_kwDOAm_5kc5KAldH",
    "user": {
      "login": "r0qs",
      "id": 457348,
      "node_id": "MDQ6VXNlcjQ1NzM0OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/457348?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/r0qs",
      "html_url": "https://github.com/r0qs",
      "followers_url": "https://api.github.com/users/r0qs/followers",
      "following_url": "https://api.github.com/users/r0qs/following{/other_user}",
      "gists_url": "https://api.github.com/users/r0qs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/r0qs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/r0qs/subscriptions",
      "organizations_url": "https://api.github.com/users/r0qs/orgs",
      "repos_url": "https://api.github.com/users/r0qs/repos",
      "events_url": "https://api.github.com/users/r0qs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/r0qs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-09T08:28:10Z",
    "updated_at": "2022-09-09T10:47:29Z",
    "author_association": "MEMBER",
    "body": "@cameel looking at this issue, I also noted that [build_emscripten.sh](https://github.com/r0qs/solidity/blob/develop/scripts/ci/build_emscripten.sh) creates the `emscripten_build` folder under the solidity directory tree as root.\r\nAs far as I could see, the docker instance needs to run with root user because of [this line](https://github.com/r0qs/solidity/blob/develop/scripts/ci/build_emscripten.sh#L44) to install lz4. The volume is also mounted under the `/root` directory in the emscripten container.\r\n\r\nSince the `build_emscripten` script will run as root in the container to execute the apt-get, the git commands in the script will be performed by a different user, and git will detect the changes in the ownership from the current user when traversing files, which will trigger the issue.\r\n\r\nI do not know why the `lz4` need to be installed in the build script and cannot be directly installed in the [solbuildpackpusher docker image](https://github.com/ethereum/solidity-buildpack-deps/blob/master/docker/Dockerfile.emscripten).\r\nMy proposed solution is that we move the installation of lz4 to that image, letting the script only responsible for building emscripten and not installing dependencies, and change the `docker run` command to run as the current user and mount the volume under the emscripten user, like so:\r\n\r\n```\r\ndocker run -v \"$(pwd):/home/emscripten/project\" -w /home/emscripten/project \\\r\n    --user \"$(id -u):$(id -g)\" \\\r\n    solbuildpackpusher/solidity-buildpack-deps@sha256:f1c13f3450d1f2e53ea18ac1ac1a17e932573cb9a5ccd0fd9ef6dd44f6402fa9 \\\r\n    ./scripts/ci/build_emscripten.sh \"$BUILD_DIR\"\r\n```\r\n\r\nWe also need to update the WORKSPACE variable [here](https://github.com/r0qs/solidity/blob/develop/scripts/ci/build_emscripten.sh#L46)\r\n\r\nThis will fix the permissions issues without requiring to change the `safe.directory` configuration. The emscripten user is already created by the base image (emscripten/emsdk) used in the solbuildpackpusher.\r\n\r\nLet me know if this sounds reasonable and I can open a PR with the fix.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1241667399/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1241825887",
    "html_url": "https://github.com/ethereum/solidity/issues/13506#issuecomment-1241825887",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13506",
    "id": 1241825887,
    "node_id": "IC_kwDOAm_5kc5KBMJf",
    "user": {
      "login": "r0qs",
      "id": 457348,
      "node_id": "MDQ6VXNlcjQ1NzM0OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/457348?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/r0qs",
      "html_url": "https://github.com/r0qs",
      "followers_url": "https://api.github.com/users/r0qs/followers",
      "following_url": "https://api.github.com/users/r0qs/following{/other_user}",
      "gists_url": "https://api.github.com/users/r0qs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/r0qs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/r0qs/subscriptions",
      "organizations_url": "https://api.github.com/users/r0qs/orgs",
      "repos_url": "https://api.github.com/users/r0qs/repos",
      "events_url": "https://api.github.com/users/r0qs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/r0qs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-09T10:58:47Z",
    "updated_at": "2022-09-09T10:58:47Z",
    "author_association": "MEMBER",
    "body": "Actually, I just found another dockerfile that seems to be the correct one here https://github.com/ethereum/solidity/blob/develop/scripts/docker/buildpack-deps/Dockerfile.emscripten\r\nAnd it already install the lz4, so we just need to remove it from the `build_emscripten` and change the user and volume mount.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1241825887/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1241834934",
    "html_url": "https://github.com/ethereum/solidity/issues/13506#issuecomment-1241834934",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13506",
    "id": 1241834934,
    "node_id": "IC_kwDOAm_5kc5KBOW2",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-09T11:08:16Z",
    "updated_at": "2022-09-09T11:08:16Z",
    "author_association": "MEMBER",
    "body": "Sounds good. Let's try this. I do think it's better to avoid using `root` in docker images when possible, it's just that that's the easiest way for people to set it up so that's probably why our image does it.\r\n\r\n> I do not know why the lz4 need to be installed in the build script\r\n\r\nIt is installed in the image. See #13424. The one you're looking at looks like an old repo created by @aarlt that we ended up not using. Or is it actually used somewhere? We should either delete it or keep it up to date with our current images, which are in https://github.com/ethereum/solidity-buildpack-deps.\r\n\r\nI don't remember why we install it both in the script and in the image (pinging @Marenz) but this is a very recent change. There should be no problem changing that as long as the images still build correctly.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1241834934/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1241839790",
    "html_url": "https://github.com/ethereum/solidity/issues/13506#issuecomment-1241839790",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13506",
    "id": 1241839790,
    "node_id": "IC_kwDOAm_5kc5KBPiu",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-09T11:13:29Z",
    "updated_at": "2022-09-09T11:14:38Z",
    "author_association": "MEMBER",
    "body": "> Actually, I just found another dockerfile\r\n\r\nRight. In any case, try changing it.\r\n\r\nBTW, check out [`buildpack-deps/README.md`](https://github.com/r0qs/solidity/blob/develop/scripts/docker/buildpack-deps/README.md) for info on how building these images works. They're versioned and built automatically but not used automatically by CI - hashes in the CI config need to be updated first.\r\n\r\nWould be simpler if we did not have to hard-code the hashes, but there was some issue with pulling from DockerHub via tags. That's another thing you might want to improve in due time - @aarlt and @ekpyron know the details of what exactly the problem was and I'm sure it's also written down in one of the old PRs/issues from the time it was being set up. I might be able to find it if need be.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1241839790/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1241841579",
    "html_url": "https://github.com/ethereum/solidity/issues/13506#issuecomment-1241841579",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13506",
    "id": 1241841579,
    "node_id": "IC_kwDOAm_5kc5KBP-r",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-09T11:15:28Z",
    "updated_at": "2022-09-09T11:15:28Z",
    "author_association": "MEMBER",
    "body": "The main reason for using hard-coded hashes is actually security. It makes us robust against repushing docker images or compromised docker hub or all sorts of things like that. So I actually wouldn't touch that :-).\r\n\r\nOf course the hashes are just posted by CI that may be compromised as well, but the surface there is much smaller.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1241841579/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1241891329",
    "html_url": "https://github.com/ethereum/solidity/issues/13506#issuecomment-1241891329",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13506",
    "id": 1241891329,
    "node_id": "IC_kwDOAm_5kc5KBcIB",
    "user": {
      "login": "r0qs",
      "id": 457348,
      "node_id": "MDQ6VXNlcjQ1NzM0OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/457348?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/r0qs",
      "html_url": "https://github.com/r0qs",
      "followers_url": "https://api.github.com/users/r0qs/followers",
      "following_url": "https://api.github.com/users/r0qs/following{/other_user}",
      "gists_url": "https://api.github.com/users/r0qs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/r0qs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/r0qs/subscriptions",
      "organizations_url": "https://api.github.com/users/r0qs/orgs",
      "repos_url": "https://api.github.com/users/r0qs/repos",
      "events_url": "https://api.github.com/users/r0qs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/r0qs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-09T11:59:41Z",
    "updated_at": "2022-09-09T11:59:41Z",
    "author_association": "MEMBER",
    "body": "It seems that `/root/project` is used in much more places than I expected. So it may require some refactoring.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1241891329/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1245668362",
    "html_url": "https://github.com/ethereum/solidity/issues/13506#issuecomment-1245668362",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13506",
    "id": 1245668362,
    "node_id": "IC_kwDOAm_5kc5KP2QK",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-13T16:38:29Z",
    "updated_at": "2022-09-13T16:38:29Z",
    "author_association": "MEMBER",
    "body": "I just realized that we may have one more problem here that probably did not show up only because the nightly is broken. I.e. we enabled branch protection in solc-bin. The action commits nightlies directly to the main branch so I suspect it will still be failing even after we fix the issue here.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1245668362/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
